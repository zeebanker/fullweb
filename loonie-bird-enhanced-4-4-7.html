<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Loonie Bird</title>
    
    <!-- PWA & iOS App Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Loonie Bird">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0d9488">
    <meta name="description" content="Music lesson scheduling app for teachers">
    
    <!-- App Icon (180x180 for iOS) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%230d9488'/><circle cx='90' cy='85' r='50' fill='%23fbbf24'/><ellipse cx='90' cy='95' rx='35' ry='25' fill='%23f59e0b'/><circle cx='75' cy='75' r='8' fill='%231c1917'/><circle cx='105' cy='75' r='8' fill='%231c1917'/><path d='M80 100 Q90 115 100 100' stroke='%231c1917' stroke-width='4' fill='none' stroke-linecap='round'/><path d='M55 55 Q45 35 60 40' stroke='%23fbbf24' stroke-width='6' fill='none' stroke-linecap='round'/><path d='M125 55 Q135 35 120 40' stroke='%23fbbf24' stroke-width='6' fill='none' stroke-linecap='round'/><text x='90' y='155' text-anchor='middle' font-family='system-ui' font-size='24' font-weight='bold' fill='white'>♪</text></svg>">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%230d9488'/><circle cx='16' cy='14' r='9' fill='%23fbbf24'/><circle cx='13' cy='12' r='2' fill='%231c1917'/><circle cx='19' cy='12' r='2' fill='%231c1917'/><text x='16' y='28' text-anchor='middle' font-size='10' fill='white'>♪</text></svg>">
    
    <!-- Web App Manifest (inline) -->
    <link rel="manifest" href="data:application/json,{%22name%22:%22Loonie%20Bird%22,%22short_name%22:%22Loonie%20Bird%22,%22description%22:%22Music%20lesson%20scheduling%20app%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23fafaf9%22,%22theme_color%22:%22%230d9488%22}">
    
    <!-- Splash Screens for iOS -->
    <meta name="apple-mobile-web-app-orientations" content="portrait">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Primary palette - warm amber/gold */
            --amber-50: #fffbeb;
            --amber-100: #fef3c7;
            --amber-200: #fde68a;
            --amber-300: #fcd34d;
            --amber-400: #fbbf24;
            --amber-500: #f59e0b;
            --amber-600: #d97706;
            --amber-700: #b45309;
            
            /* Secondary palette - deep teal */
            --teal-50: #f0fdfa;
            --teal-100: #ccfbf1;
            --teal-200: #99f6e4;
            --teal-500: #14b8a6;
            --teal-600: #0d9488;
            --teal-700: #0f766e;
            --teal-800: #115e59;
            --teal-900: #134e4a;
            
            /* Neutrals - warm gray */
            --stone-50: #fafaf9;
            --stone-100: #f5f5f4;
            --stone-200: #e7e5e4;
            --stone-300: #d6d3d1;
            --stone-400: #a8a29e;
            --stone-500: #78716c;
            --stone-600: #57534e;
            --stone-700: #44403c;
            --stone-800: #292524;
            --stone-900: #1c1917;
            
            /* Accent colors */
            --coral-500: #f97316;
            --rose-500: #f43f5e;
            --rose-600: #e11d48;
            --violet-50: #f5f3ff;
            --violet-100: #ede9fe;
            --violet-300: #c4b5fd;
            --violet-500: #8b5cf6;
            --violet-700: #6d28d9;
            --emerald-500: #10b981;
            --sky-500: #0ea5e9;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-glow: 0 0 40px rgba(251, 191, 36, 0.15);
            
            /* Typography */
            --font-display: 'Plus Jakarta Sans', system-ui, sans-serif;
            --font-body: 'Inter', system-ui, sans-serif;
        }
        
        /* Dark Mode */
        [data-theme="dark"] {
            --stone-50: #1c1917;
            --stone-100: #292524;
            --stone-200: #44403c;
            --stone-300: #57534e;
            --stone-400: #78716c;
            --stone-500: #a8a29e;
            --stone-600: #d6d3d1;
            --stone-700: #e7e5e4;
            --stone-800: #f5f5f4;
            --stone-900: #fafaf9;
            
            --amber-50: #292524;
            --amber-100: #44403c;
            
            --teal-50: #1c1917;
            --teal-100: #292524;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.4), 0 1px 2px -1px rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.3);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.4), 0 8px 10px -6px rgb(0 0 0 / 0.3);
            --shadow-glow: 0 0 40px rgba(251, 191, 36, 0.1);
        }
        
        [data-theme="dark"] body {
            background: linear-gradient(135deg, #1c1917 0%, #292524 100%);
        }
        
        [data-theme="dark"] .login-card,
        [data-theme="dark"] .calendar-wrapper,
        [data-theme="dark"] .app-header {
            background: #292524;
            border-color: #44403c;
        }
        
        [data-theme="dark"] #loginScreen {
            background: 
                radial-gradient(ellipse at top left, rgba(251, 191, 36, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(20, 184, 166, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, #1c1917 0%, #292524 100%);
        }
        
        [data-theme="dark"] .calendar-table thead th {
            background: #1c1917;
            border-color: #44403c;
        }
        
        [data-theme="dark"] .calendar-table th:first-child {
            background: #0f0e0d;
        }
        
        [data-theme="dark"] .calendar-table th.today-header {
            background: linear-gradient(135deg, var(--teal-700) 0%, var(--teal-800) 100%);
        }
        
        [data-theme="dark"] .calendar-table td {
            border-color: #44403c;
            background: #292524;
        }
        
        [data-theme="dark"] .calendar-table td:first-child {
            background: #1c1917;
        }
        
        [data-theme="dark"] .calendar-table td.past-day {
            background: #1c1917;
        }
        
        [data-theme="dark"] .lesson-slot {
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        [data-theme="dark"] .modal-content {
            background: #292524;
            color: #f5f5f4;
        }
        
        [data-theme="dark"] #modal {
            background: rgba(12, 10, 9, 0.5);
        }
        
        [data-theme="dark"] #modalContent {
            background: rgba(41, 37, 36, 0.78);
            border-color: rgba(68, 64, 60, 0.5);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.35),
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.06);
        }
        
        [data-theme="dark"] .form-input,
        [data-theme="dark"] .form-select,
        [data-theme="dark"] .login-input {
            background: #1c1917;
            border-color: #44403c;
            color: #f5f5f4;
        }
        
        [data-theme="dark"] .info-box {
            background: #1c1917;
        }
        
        [data-theme="dark"] .student-card {
            background: #1c1917;
            border-color: #44403c;
        }
        
        [data-theme="dark"] .btn-nav {
            background: #1c1917;
            border-color: #44403c;
            color: #d6d3d1;
        }
        
        [data-theme="dark"] .btn-nav:hover {
            background: #44403c;
        }
        
        [data-theme="dark"] .logout-btn {
            background: #1c1917;
            border-color: #44403c;
            color: #d6d3d1;
        }
        
        [data-theme="dark"] .user-badge {
            background: #1c1917;
            color: #d6d3d1;
        }
        
        [data-theme="dark"] .photo-placeholder {
            background: #1c1917;
            border-color: #44403c;
            color: #78716c;
        }
        
        [data-theme="dark"] .photo-preview-img {
            border-color: var(--teal-700);
        }
        
        /* Theme toggle button */
        .theme-toggle {
            padding: 0.5rem;
            background: var(--stone-100);
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
        }
        
        .theme-toggle:hover {
            background: var(--stone-200);
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body { 
            font-family: var(--font-body);
            line-height: 1.6;
            color: var(--stone-800);
            background: linear-gradient(135deg, var(--stone-100) 0%, var(--amber-50) 100%);
            min-height: 100vh;
            /* iOS safe areas */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Allow text selection in specific areas */
        .modal-content, .info-box, input, textarea, .detail-value {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* PWA standalone mode adjustments */
        @media all and (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
            }
            .app-header {
                padding-top: calc(1rem + env(safe-area-inset-top));
            }
        }
        
        /* Typography */
        h1, h2, h3, h4 {
            font-family: var(--font-display);
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        /* ===== LOGIN SCREEN ===== */
        #loginScreen {
            min-height: 100vh;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: 
                radial-gradient(ellipse at top left, rgba(251, 191, 36, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(20, 184, 166, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, var(--stone-100) 0%, var(--amber-50) 100%);
        }
        
        .login-card {
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow-xl), var(--shadow-glow);
            padding: 3rem;
            width: 100%;
            max-width: 420px;
            position: relative;
            overflow: hidden;
        }
        
        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--amber-400), var(--teal-500), var(--amber-400));
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        
        .login-logo .bird-icon {
            font-size: 4rem;
            display: block;
            margin-bottom: 0.5rem;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .login-logo h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--amber-600) 0%, var(--teal-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
        }
        
        .login-logo p {
            color: var(--stone-500);
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .login-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .login-btn-primary {
            background: linear-gradient(135deg, var(--teal-600) 0%, var(--teal-700) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(13, 148, 136, 0.3);
        }
        
        .login-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.4);
        }
        
        .login-btn-secondary {
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--amber-600) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
        }
        
        .login-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .login-divider {
            display: flex;
            align-items: center;
            margin: 1.75rem 0;
            gap: 1rem;
        }
        
        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--stone-300), transparent);
        }
        
        .login-divider span {
            color: var(--stone-400);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .login-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--stone-200);
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 1rem;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-align: center;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--amber-400);
            box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.1);
        }
        
        .login-input::placeholder {
            text-transform: none;
            letter-spacing: normal;
        }
        
        .login-help {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--stone-200);
        }
        
        .login-help p {
            color: var(--stone-500);
            font-size: 0.875rem;
        }
        
        /* ===== TEACHER DASHBOARD ===== */
        #teacherDashboard {
            min-height: 100vh;
            padding: 2rem;
            background: 
                radial-gradient(ellipse at top left, rgba(251, 191, 36, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(20, 184, 166, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, var(--stone-100) 0%, var(--amber-50) 100%);
        }
        
        [data-theme="dark"] #teacherDashboard {
            background: 
                radial-gradient(ellipse at top left, rgba(251, 191, 36, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(20, 184, 166, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, #1c1917 0%, #292524 100%);
        }
        
        .dashboard-container {
            max-width: 720px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-top: 1rem;
        }
        
        .dashboard-title {
            font-size: 2.2rem;
            background: linear-gradient(135deg, var(--amber-600) 0%, var(--teal-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0.25rem 0;
        }
        
        .dashboard-subtitle {
            color: var(--stone-500);
            font-size: 1rem;
            font-weight: 500;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        @media (max-width: 520px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .dashboard-card {
            background: white;
            border-radius: 16px;
            padding: 1.4rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
        }
        
        [data-theme="dark"] .dashboard-card {
            background: #292524;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .dashboard-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] .dashboard-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        
        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }
        
        .dashboard-card-schedule::before { background: linear-gradient(90deg, var(--teal-500), var(--teal-600)); }
        .dashboard-card-schedule:hover { border-color: var(--teal-300); }
        .dashboard-card-students::before { background: linear-gradient(90deg, var(--violet-500), var(--violet-600)); }
        .dashboard-card-students:hover { border-color: var(--violet-300); }
        .draft-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-22deg);
            font-family: var(--font-display);
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: 0.15em;
            color: rgba(220, 38, 38, 0.55);
            border: 4px solid rgba(220, 38, 38, 0.55);
            border-radius: 8px;
            padding: 0.1rem 1rem;
            text-transform: uppercase;
            pointer-events: none;
            z-index: 5;
            white-space: nowrap;
        }
        
        .dashboard-card-payments::before { background: linear-gradient(90deg, var(--emerald-500), var(--emerald-600)); }
        .dashboard-card-payments:hover { border-color: var(--emerald-300); }
        .dashboard-card-swaps::before { background: linear-gradient(90deg, var(--amber-500), var(--amber-600)); }
        .dashboard-card-swaps:hover { border-color: var(--amber-300); }
        .dashboard-card-reschedules::before { background: linear-gradient(90deg, var(--rose-400), var(--rose-500)); }
        .dashboard-card-reschedules:hover { border-color: var(--rose-300); }
        .dashboard-card-blocks::before { background: linear-gradient(90deg, var(--stone-400), var(--stone-500)); }
        .dashboard-card-blocks:hover { border-color: var(--stone-300); }
        
        .dashboard-card-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .dashboard-card-label {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--stone-800);
            margin-bottom: 0.25rem;
        }
        
        [data-theme="dark"] .dashboard-card-label {
            color: var(--stone-200);
        }
        
        .dashboard-card-desc {
            font-size: 0.78rem;
            color: var(--stone-500);
            line-height: 1.3;
        }
        
        .dashboard-card-stat {
            margin-top: 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--teal-700);
            min-height: 1.2em;
        }
        
        [data-theme="dark"] .dashboard-card-stat {
            color: var(--teal-400);
        }
        
        .dashboard-card-stat .stat-alert {
            color: var(--amber-600);
            font-weight: 700;
        }
        
        [data-theme="dark"] .dashboard-card-stat .stat-alert {
            color: var(--amber-400);
        }
        
        .dashboard-footer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--stone-200);
        }
        
        [data-theme="dark"] .dashboard-footer {
            border-top-color: var(--stone-700);
        }
        
        .dashboard-logout {
            padding: 0.6rem 1.5rem;
            background: var(--stone-200);
            border: none;
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--stone-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .dashboard-logout:hover {
            background: var(--stone-300);
        }
        
        [data-theme="dark"] .dashboard-logout {
            background: var(--stone-700);
            color: var(--stone-300);
        }
        
        /* ===== MAIN APP LAYOUT ===== */
        #mainApp {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        #mainApp.active {
            display: flex;
        }
        
        /* ===== HEADER ===== */
        .app-header {
            background: white;
            border-bottom: 1px solid var(--stone-200);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .header-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-brand .bird-icon {
            font-size: 2rem;
        }
        
        .header-brand h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--amber-600) 0%, var(--teal-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--stone-100);
            border-radius: 100px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--stone-700);
        }
        
        .logout-btn {
            padding: 0.5rem 1rem;
            background: var(--stone-100);
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--stone-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .logout-btn:hover {
            background: var(--stone-200);
            color: var(--stone-800);
        }
        
        /* ===== CONTROL BAR ===== */
        .control-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border: none;
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-height: 44px; /* iOS touch target minimum */
            touch-action: manipulation;
        }
        
        /* Touch-friendly tap states */
        .btn:active {
            transform: scale(0.97);
        }
        
        .btn-add {
            background: linear-gradient(135deg, var(--emerald-500) 0%, #059669 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }
        
        .btn-add:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
        }
        
        .btn-block {
            background: linear-gradient(135deg, var(--coral-500) 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.25);
        }
        
        .btn-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.35);
        }
        
        .btn-students {
            background: linear-gradient(135deg, var(--violet-500) 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.25);
        }
        
        .btn-students:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.35);
        }
        
        .btn-swaps {
            background: linear-gradient(135deg, var(--sky-500) 0%, #0284c7 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.25);
            position: relative;
        }
        
        .btn-swaps:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.35);
        }
        
        .btn-payments {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.25);
        }
        
        .btn-payments:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.35);
        }
        
        .btn-swaps .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--rose-500);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(244, 63, 94, 0.4);
        }
        
        .btn-reschedule {
            background: linear-gradient(135deg, var(--teal-500) 0%, var(--teal-700) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(13, 148, 136, 0.25);
            position: relative;
        }
        
        .btn-reschedule:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.35);
        }
        
        .btn-reschedule .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--amber-500);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.4);
        }
        
        .btn-swap {
            padding: 1rem 2rem;
            font-size: 1rem;
            background: linear-gradient(135deg, var(--violet-500) 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(139, 92, 246, 0.3);
            position: relative;
        }
        
        .btn-swap:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }
        
        .btn-swap .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--rose-500);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(244, 63, 94, 0.4);
        }
        
        .btn-reschedule-student {
            padding: 1rem 2rem;
            font-size: 1rem;
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--amber-600) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
            position: relative;
        }
        
        .btn-reschedule-student:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .week-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
            position: relative;
        }
        
        .btn-nav {
            padding: 0.625rem 1rem;
            background: var(--stone-100);
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--stone-700);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-nav:hover {
            background: var(--stone-200);
            border-color: var(--stone-300);
        }
        
        .btn-mini-cal {
            font-size: 1rem;
            padding: 0.5rem 0.65rem;
        }
        
        .btn-today {
            background: linear-gradient(135deg, var(--teal-500) 0%, var(--teal-600) 100%);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(20, 184, 166, 0.25);
        }
        
        .btn-today:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.35);
        }
        
        /* Mini month calendar */
        .mini-calendar {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.45);
            border-radius: 14px;
            box-shadow: 0 8px 32px rgba(28, 25, 23, 0.14), 0 2px 8px rgba(28, 25, 23, 0.08);
            padding: 0.75rem;
            width: 260px;
            user-select: none;
        }
        
        .mini-calendar.hidden {
            display: none;
        }
        
        .mini-cal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0 0.15rem;
        }
        
        .mini-cal-title {
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--stone-800);
        }
        
        .mini-cal-nav {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--stone-500);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            transition: all 0.15s;
        }
        
        .mini-cal-nav:hover {
            background: var(--stone-100);
            color: var(--stone-800);
        }
        
        .mini-cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            text-align: center;
        }
        
        .mini-cal-dow {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--stone-400);
            padding: 0.25rem 0;
            text-transform: uppercase;
        }
        
        .mini-cal-day {
            font-size: 0.75rem;
            padding: 0.3rem 0;
            border-radius: 6px;
            cursor: pointer;
            color: var(--stone-600);
            transition: all 0.12s;
            position: relative;
        }
        
        .mini-cal-day:hover {
            background: var(--teal-50);
            color: var(--teal-700);
        }
        
        .mini-cal-day.other-month {
            color: var(--stone-300);
        }
        
        .mini-cal-day.today {
            font-weight: 800;
            color: white;
            background: var(--teal-500);
        }
        
        .mini-cal-day.today:hover {
            background: var(--teal-600);
            color: white;
        }
        
        .mini-cal-day.current-week {
            background: var(--teal-50);
            color: var(--teal-700);
            font-weight: 600;
        }
        
        .mini-cal-day.current-week:hover {
            background: var(--teal-100);
        }
        
        .mini-cal-day.has-lessons::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--teal-400);
        }
        
        .mini-cal-day.today.has-lessons::after {
            background: white;
        }
        
        [data-theme="dark"] .mini-calendar {
            background: rgba(41, 37, 36, 0.88);
            border-color: rgba(68, 64, 60, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35);
        }
        
        [data-theme="dark"] .mini-cal-title {
            color: var(--stone-200);
        }
        
        [data-theme="dark"] .mini-cal-nav:hover {
            background: var(--stone-700);
            color: var(--stone-200);
        }
        
        [data-theme="dark"] .mini-cal-day {
            color: var(--stone-400);
        }
        
        [data-theme="dark"] .mini-cal-day:hover {
            background: rgba(20, 184, 166, 0.15);
            color: var(--teal-300);
        }
        
        [data-theme="dark"] .mini-cal-day.other-month {
            color: var(--stone-600);
        }
        
        [data-theme="dark"] .mini-cal-day.current-week {
            background: rgba(20, 184, 166, 0.12);
            color: var(--teal-300);
        }
        
        [data-theme="dark"] .mini-cal-day.current-week:hover {
            background: rgba(20, 184, 166, 0.2);
        }
        
        /* ===== FLOATING ACTION BUTTON ===== */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--emerald-500) 0%, #059669 100%);
            color: white;
            font-size: 1.75rem;
            font-weight: 300;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.35), 0 2px 6px rgba(0,0,0,0.1);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            line-height: 1;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.45), 0 3px 8px rgba(0,0,0,0.12);
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab.hidden {
            display: none;
        }
        
        [data-theme="dark"] .fab {
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.25), 0 2px 6px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .fab {
                bottom: 1.25rem;
                right: 1.25rem;
            }
        }
        
        /* ===== CALENDAR ===== */
        .calendar-container {
            flex: 1;
            padding: 1.5rem;
            overflow: hidden;
        }
        
        .calendar-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            position: relative;
        }
        
        .calendar-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
        }
        
        .calendar-table th:first-child,
        .calendar-table td:first-child {
            width: 80px;
        }
        
        .calendar-table th:not(:first-child),
        .calendar-table td:not(:first-child) {
            width: calc((100% - 80px) / 7);
        }
        
        .calendar-table thead th {
            position: sticky;
            top: 0;
            z-index: 20;
            background: var(--stone-800);
            color: white;
            padding: 1rem 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            text-align: center;
            border-bottom: 2px solid var(--stone-600);
        }
        
        .calendar-table th:first-child {
            background: var(--stone-900);
            z-index: 21;
        }
        
        .calendar-table th.today-header {
            background: linear-gradient(135deg, var(--teal-600) 0%, var(--teal-700) 100%);
        }
        
        .calendar-table th.past-header {
            background: var(--stone-600);
            color: var(--stone-400);
        }
        
        .day-name {
            font-weight: 700;
            letter-spacing: 0.02em;
        }
        
        .day-date {
            font-size: 0.75rem;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .calendar-table td {
            border: 1px solid var(--stone-200);
            vertical-align: top;
            height: 80px;
            position: relative;
            transition: background 0.15s ease;
        }
        
        .calendar-table td:first-child {
            background: var(--stone-50);
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--stone-600);
            text-align: center;
            vertical-align: middle;
            border-left: none;
        }
        
        .calendar-table td.past-day {
            background: var(--stone-100);
            opacity: 0.6;
        }
        
        body.teacher-mode .calendar-table td.drop-zone:hover:not(.past-day) {
            background: var(--amber-50);
        }
        
        body.student-mode .calendar-table td.drop-zone {
            cursor: default;
        }
        
        /* Current time indicator */
        .time-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--coral-500);
            z-index: 15;
            pointer-events: none;
        }
        
        .time-indicator-dot {
            position: absolute;
            left: -4px;
            top: -3px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--coral-500);
        }
        
        [data-theme="dark"] .time-indicator {
            background: #f87171;
        }
        
        [data-theme="dark"] .time-indicator-dot {
            background: #f87171;
        }
        
        /* Drag and Drop Enhancement */
        .calendar-table td.drag-over:not(.past-day) {
            background: var(--teal-50) !important;
            position: relative;
        }
        
        .calendar-table td.drag-over:not(.past-day)::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                to bottom,
                transparent,
                transparent 19px,
                var(--teal-200) 19px,
                var(--teal-200) 20px
            );
            pointer-events: none;
            z-index: 1;
        }
        
        .drop-indicator {
            position: absolute;
            left: 4px;
            right: 4px;
            height: 6px;
            background: var(--teal-500);
            border-radius: 3px;
            z-index: 500;
            pointer-events: none;
            box-shadow: 0 0 12px var(--teal-400), 0 0 20px rgba(20, 184, 166, 0.5);
            transition: top 0.08s ease;
        }
        
        .drop-indicator::before,
        .drop-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-style: solid;
        }
        
        .drop-indicator::before {
            left: -6px;
            border-width: 6px 6px 6px 0;
            border-color: transparent var(--teal-500) transparent transparent;
        }
        
        .drop-indicator::after {
            right: -6px;
            border-width: 6px 0 6px 6px;
            border-color: transparent transparent transparent var(--teal-500);
        }
        
        .drop-preview {
            position: absolute;
            left: 4px;
            right: 4px;
            background: var(--teal-400);
            opacity: 0.4;
            border-radius: 6px;
            pointer-events: none;
            z-index: 499;
            border: 2px dashed var(--teal-600);
            transition: top 0.08s ease, height 0.08s ease;
        }
        
        .drop-indicator-blocked {
            background: var(--rose-500);
            box-shadow: 0 0 12px var(--rose-400), 0 0 20px rgba(244, 63, 94, 0.5);
        }
        
        .drop-indicator-blocked::before {
            border-color: transparent var(--rose-500) transparent transparent;
        }
        
        .drop-indicator-blocked::after {
            border-color: transparent transparent transparent var(--rose-500);
        }
        
        .drop-preview-blocked {
            background: var(--rose-400);
            border-color: var(--rose-600);
        }
        
        .drop-time-tooltip {
            position: fixed;
            background: var(--stone-800);
            color: white;
            padding: 0.35rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            pointer-events: none;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        
        /* ===== LESSON SLOTS ===== */
        .lesson-slot {
            position: absolute;
            left: 3px;
            right: 3px;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 0.7rem;
            cursor: move;
            overflow: hidden;
            transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
            z-index: 1;
        }
        
        .lesson-slot:hover {
            transform: scale(1.02);
            z-index: 5;
        }
        
        .lesson-slot.dragging {
            opacity: 0.4;
            transform: scale(0.95);
            box-shadow: none;
        }
        
        .lesson-slot.drag-source {
            background: var(--stone-300) !important;
            opacity: 0.3;
        }
        
        .lesson-slot .student-name {
            font-weight: 700;
            font-size: 0.75rem;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .lesson-30 { height: 40px; }
        .lesson-45 { height: 60px; }
        .lesson-60 { height: 80px; }
        
        /* Lesson color variants */
        .lesson-overlap-0 {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #60a5fa;
            color: #1e40af;
        }
        
        .lesson-overlap-1 {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #fbbf24;
            color: #92400e;
        }
        
        .lesson-overlap-2 {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #34d399;
            color: #065f46;
        }
        
        .lesson-overlap-3 {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border: 2px solid #a78bfa;
            color: #5b21b6;
        }
        
        .lesson-overlap-4 {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            border: 2px solid #f472b6;
            color: #9d174d;
        }
        
        .lesson-overlap-5 {
            background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);
            border: 2px solid #fb923c;
            color: #9a3412;
        }
        
        /* Student's own lessons - golden highlight */
        .my-lesson {
            background: linear-gradient(135deg, var(--amber-200) 0%, var(--amber-300) 100%);
            border: 2px solid var(--amber-500);
            color: var(--amber-900);
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
        }
        
        .my-lesson:hover {
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }
        
        /* Flash animation for newly swapped lessons */
        @keyframes swapFlash {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            15% { transform: scale(1.08); box-shadow: 0 0 20px 4px rgba(16, 185, 129, 0.5); }
            30% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
            45% { transform: scale(1.08); box-shadow: 0 0 20px 4px rgba(16, 185, 129, 0.5); }
            60% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
            75% { transform: scale(1.06); box-shadow: 0 0 15px 3px rgba(16, 185, 129, 0.4); }
            100% { transform: scale(1); box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3); }
        }
        
        .lesson-slot.swap-flash {
            animation: swapFlash 2.5s ease-out;
            z-index: 50 !important;
            border: 2px solid var(--emerald-500) !important;
        }
        
        /* ===== BLOCKED SLOTS ===== */
        .blocked-slot {
            position: absolute;
            left: 3px;
            right: 3px;
            z-index: 10;
            background: repeating-linear-gradient(
                45deg,
                var(--stone-300),
                var(--stone-300) 8px,
                var(--stone-400) 8px,
                var(--stone-400) 16px
            );
            color: var(--stone-700);
            padding: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            box-sizing: border-box;
        }
        
        body.teacher-mode .blocked-slot:hover {
            background: repeating-linear-gradient(
                45deg,
                var(--stone-400),
                var(--stone-400) 8px,
                var(--stone-500) 8px,
                var(--stone-500) 16px
            );
        }
        
        [data-theme="dark"] .blocked-slot {
            background: repeating-linear-gradient(
                45deg,
                var(--stone-600),
                var(--stone-600) 8px,
                var(--stone-700) 8px,
                var(--stone-700) 16px
            );
            color: var(--stone-400);
            border-color: var(--stone-600);
        }
        
        [data-theme="dark"] body.teacher-mode .blocked-slot:hover {
            background: repeating-linear-gradient(
                45deg,
                var(--stone-500),
                var(--stone-500) 8px,
                var(--stone-600) 8px,
                var(--stone-600) 16px
            );
        }
        
        /* ===== MODAL ===== */
        #modal {
            position: fixed;
            inset: 0;
            background: rgba(28, 25, 23, 0.45);
            backdrop-filter: blur(8px) saturate(120%);
            -webkit-backdrop-filter: blur(8px) saturate(120%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }
        
        #modal.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #modalContent {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.45);
            box-shadow: 
                0 8px 32px rgba(28, 25, 23, 0.12),
                0 2px 8px rgba(28, 25, 23, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            max-width: 480px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            animation: glassSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes glassSlideUp {
            from { 
                opacity: 0;
                transform: translateY(24px) scale(0.97);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--stone-900);
            margin-bottom: 1.5rem;
        }
        
        .modal-subtitle {
            font-size: 0.9rem;
            color: var(--stone-500);
            margin-top: -1rem;
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--stone-700);
            margin-bottom: 0.5rem;
        }
        
        .form-label-optional {
            font-weight: 400;
            color: var(--stone-400);
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--stone-200);
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 0.9375rem;
            color: var(--stone-800);
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--teal-500);
            box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.1);
        }
        
        .form-input[readonly] {
            background: var(--stone-100);
            color: var(--stone-500);
            cursor: not-allowed;
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        .form-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--teal-600);
            cursor: pointer;
        }
        
        .form-checkbox span {
            font-size: 0.9rem;
            color: var(--stone-700);
        }
        
        .modal-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.75rem;
        }
        
        .modal-btn:last-child {
            margin-bottom: 0;
        }
        
        .modal-btn-primary {
            background: linear-gradient(135deg, var(--teal-500) 0%, var(--teal-600) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(20, 184, 166, 0.3);
        }
        
        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(20, 184, 166, 0.4);
        }
        
        .modal-btn-success {
            background: linear-gradient(135deg, var(--emerald-500) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
        }
        
        .modal-btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .modal-btn-warning {
            background: linear-gradient(135deg, var(--coral-500) 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(249, 115, 22, 0.3);
        }
        
        .modal-btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
        }
        
        .modal-btn-danger {
            background: linear-gradient(135deg, var(--rose-500) 0%, #e11d48 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(244, 63, 94, 0.3);
        }
        
        .modal-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 63, 94, 0.4);
        }
        
        .modal-btn-secondary {
            background: var(--stone-100);
            color: var(--stone-700);
            border: 1px solid var(--stone-200);
        }
        
        .modal-btn-secondary:hover {
            background: var(--stone-200);
        }
        
        .modal-btn-violet {
            background: linear-gradient(135deg, var(--violet-500) 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(139, 92, 246, 0.3);
        }
        
        .modal-btn-violet:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }
        
        .modal-btn-amber {
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--amber-600) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
        }
        
        .modal-btn-amber:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        /* Info boxes */
        .info-box {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .info-box-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
            border: 1px solid var(--amber-300);
            color: var(--amber-800);
        }
        
        .info-box-info {
            background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
            border: 1px solid var(--sky-500);
            color: #075985;
        }
        
        .info-box-success {
            background: linear-gradient(135deg, #d1fae5 0%, #dcfce7 100%);
            border: 1px solid var(--emerald-500);
            color: #065f46;
        }
        
        .info-box-danger {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 1px solid var(--rose-500);
            color: #9f1239;
        }
        
        /* Detail cards */
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--stone-100);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: var(--stone-500);
            font-size: 0.875rem;
        }
        
        .detail-value {
            font-weight: 600;
            color: var(--stone-800);
            font-size: 0.875rem;
        }
        
        .recurring-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, var(--teal-100) 0%, var(--teal-50) 100%);
            border: 1px solid var(--teal-300);
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--teal-700);
            margin-top: 0.5rem;
        }
        
        /* Student list cards */
        .student-card {
            padding: 1rem;
            border: 2px solid var(--stone-200);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            transition: all 0.15s ease;
        }
        
        .student-card:hover {
            border-color: var(--teal-400);
            background: var(--teal-50);
        }
        
        .student-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .student-name-large {
            font-weight: 700;
            font-size: 1rem;
            color: var(--stone-800);
        }
        
        .student-meta {
            font-size: 0.8rem;
            color: var(--stone-500);
            margin-top: 0.25rem;
        }
        
        .student-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.5rem 0.875rem;
            font-size: 0.8rem;
            border-radius: 8px;
        }
        
        /* Profile section */
        .profile-section {
            background: linear-gradient(135deg, var(--teal-50) 0%, var(--amber-50) 100%);
            border: 1px solid var(--teal-200);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        
        .profile-header {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .profile-photo {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
        }
        
        .profile-photo-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: var(--stone-200);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--stone-400);
            font-size: 0.75rem;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
        }
        
        /* Photo Upload Styles */
        .photo-upload-section {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .photo-upload-preview {
            position: relative;
            flex-shrink: 0;
        }
        
        .photo-preview-img {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid var(--teal-200);
            box-shadow: var(--shadow-md);
        }
        
        .photo-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            background: var(--stone-100);
            border: 2px dashed var(--stone-300);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--stone-400);
            font-size: 1.5rem;
        }
        
        .photo-remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--rose-500);
            color: white;
            border: 2px solid white;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }
        
        .photo-remove-btn:hover {
            background: var(--rose-600);
            transform: scale(1.1);
        }
        
        .photo-upload-controls {
            flex: 1;
            min-width: 0;
        }
        
        .family-code-display {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            background: linear-gradient(135deg, var(--violet-100) 0%, var(--violet-50) 100%);
            border: 1px solid var(--violet-300);
            border-radius: 6px;
            font-family: monospace;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--violet-700);
            letter-spacing: 0.05em;
        }
        
        /* Swap request cards */
        .swap-request-card {
            background: white;
            border: 2px solid var(--amber-300);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .swap-arrow {
            text-align: center;
            color: var(--stone-400);
            font-size: 1.25rem;
            margin: 0.5rem 0;
        }
        
        /* Available slot cards for reschedule */
        .available-slot-card {
            background: white;
            border: 2px solid var(--teal-200);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .available-slot-card:hover {
            border-color: var(--teal-500);
            background: var(--teal-50);
            transform: translateX(4px);
        }
        
        .available-slot-card:active {
            transform: scale(0.98);
        }
        
        [data-theme="dark"] .available-slot-card {
            background: var(--stone-700);
            border-color: var(--teal-700);
        }
        
        [data-theme="dark"] .available-slot-card:hover {
            background: var(--stone-600);
            border-color: var(--teal-500);
        }
        
        /* Toast notification */
        #toast {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 0;
            background: linear-gradient(135deg, var(--stone-800) 0%, var(--stone-900) 100%);
            color: white;
            border-radius: 14px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.05);
            font-weight: 500;
            z-index: 2000;
            display: none;
            min-width: 280px;
            max-width: 400px;
            overflow: hidden;
            animation: toastSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        #toast.show {
            display: block;
        }
        
        #toast.hiding {
            animation: toastSlideOut 0.3s ease forwards;
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .toast-message {
            flex: 1;
            line-height: 1.4;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 16px;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .toast-close:hover {
            color: white;
        }
        
        .toast-progress {
            height: 3px;
            background: rgba(255,255,255,0.2);
        }
        
        .toast-progress-bar {
            height: 100%;
            width: 100%;
            transform-origin: left;
            animation: toastProgress 3s linear forwards;
        }
        
        /* Toast Types */
        #toast.toast-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        #toast.toast-success .toast-icon {
            background: rgba(255,255,255,0.2);
        }
        #toast.toast-success .toast-progress-bar {
            background: rgba(255,255,255,0.4);
        }
        
        #toast.toast-error {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        #toast.toast-error .toast-icon {
            background: rgba(255,255,255,0.2);
        }
        #toast.toast-error .toast-progress-bar {
            background: rgba(255,255,255,0.4);
        }
        
        #toast.toast-warning {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }
        #toast.toast-warning .toast-icon {
            background: rgba(255,255,255,0.2);
        }
        #toast.toast-warning .toast-progress-bar {
            background: rgba(255,255,255,0.4);
        }
        
        #toast.toast-info {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
        }
        #toast.toast-info .toast-icon {
            background: rgba(255,255,255,0.2);
        }
        #toast.toast-info .toast-progress-bar {
            background: rgba(255,255,255,0.4);
        }
        
        #toast.toast-default .toast-icon {
            background: rgba(255,255,255,0.15);
        }
        #toast.toast-default .toast-progress-bar {
            background: rgba(255,255,255,0.3);
        }
        
        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateX(100%) scale(0.9);
            }
        }
        
        @keyframes toastProgress {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }
        
        /* Mobile positioning */
        @media (max-width: 480px) {
            #toast {
                left: 1rem;
                right: 1rem;
                top: auto;
                bottom: 5rem;
                min-width: auto;
                max-width: none;
            }
        }
        
        /* Section dividers */
        .section-divider {
            border-top: 2px solid var(--stone-200);
            margin: 1.5rem 0;
            padding-top: 1.5rem;
        }
        
        .section-title {
            font-family: var(--font-display);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--stone-400);
            margin-bottom: 1rem;
        }
        
        /* Guardian cards */
        .guardian-card {
            background: var(--stone-50);
            border: 1px solid var(--stone-200);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .guardian-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .guardian-header .section-title {
            margin-bottom: 0;
        }
        
        .btn-remove-guardian {
            background: var(--rose-100);
            color: var(--rose-600);
            border: none;
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .btn-remove-guardian:hover {
            background: var(--rose-200);
        }
        
        .btn-add-guardian {
            width: 100%;
            padding: 0.75rem;
            background: var(--teal-50);
            border: 2px dashed var(--teal-300);
            border-radius: 10px;
            color: var(--teal-700);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 1rem;
        }
        
        .btn-add-guardian:hover {
            background: var(--teal-100);
            border-color: var(--teal-400);
        }
        
        [data-theme="dark"] .guardian-card {
            background: var(--stone-700);
            border-color: var(--stone-600);
        }
        
        [data-theme="dark"] .btn-add-guardian {
            background: var(--teal-900);
            border-color: var(--teal-700);
            color: var(--teal-300);
        }
        
        [data-theme="dark"] .btn-add-guardian:hover {
            background: var(--teal-800);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--stone-100);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--stone-300);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--stone-400);
        }
        
        /* Conflict list */
        .conflict-list {
            background: var(--amber-50);
            border: 1px solid var(--amber-200);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .conflict-item {
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--amber-200);
        }
        
        .conflict-item:last-child {
            border-bottom: none;
        }
        
        /* Lesson list for student view */
        .lesson-list-item {
            background: linear-gradient(135deg, var(--amber-50) 0%, var(--amber-100) 100%);
            border: 2px solid var(--amber-300);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.15s ease;
            cursor: pointer;
        }
        
        .lesson-list-item:hover {
            border-color: var(--amber-500);
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        
        .lesson-list-time {
            font-weight: 700;
            font-size: 1rem;
            color: var(--stone-800);
        }
        
        .lesson-list-duration {
            font-size: 0.8rem;
            color: var(--stone-500);
        }
        
        /* Utility classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        
        /* Max height scroll containers */
        .scroll-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Payment tracking styles */
        .payment-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .payment-stat {
            text-align: center;
            padding: 1rem;
            border-radius: 12px;
            background: var(--stone-100);
        }
        
        .payment-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-display);
        }
        
        .payment-stat-label {
            font-size: 0.75rem;
            color: var(--stone-500);
            margin-top: 0.25rem;
        }
        
        .payment-stat.paid {
            background: rgba(16, 185, 129, 0.15);
        }
        
        .payment-stat.paid .payment-stat-value {
            color: var(--emerald-500);
        }
        
        .payment-stat.unpaid {
            background: rgba(244, 63, 94, 0.15);
        }
        
        .payment-stat.unpaid .payment-stat-value {
            color: var(--rose-500);
        }
        
        .payment-stat.total {
            background: rgba(139, 92, 246, 0.15);
        }
        
        .payment-stat.total .payment-stat-value {
            color: var(--violet-500);
        }
        
        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--stone-200);
        }
        
        .payment-row:last-child {
            border-bottom: none;
        }
        
        .payment-row-info {
            flex: 1;
        }
        
        .payment-row-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .payment-row-detail {
            font-size: 0.75rem;
            color: var(--stone-500);
        }
        
        .payment-row-amount {
            font-weight: 700;
            font-family: var(--font-display);
            font-size: 1rem;
            margin-right: 0.75rem;
        }
        
        .payment-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .payment-badge.paid {
            background: var(--emerald-500);
            color: white;
        }
        
        .payment-badge.unpaid {
            background: var(--rose-500);
            color: white;
        }
        
        .rate-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .rate-input input {
            width: 100px;
            text-align: right;
        }
        
        .invoice-preview {
            background: white;
            border: 1px solid var(--stone-300);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            font-size: 0.875rem;
        }
        
        [data-theme="dark"] .invoice-preview {
            background: #1c1917;
            border-color: #44403c;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--stone-200);
        }
        
        .invoice-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .invoice-table th,
        .invoice-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--stone-200);
        }
        
        .invoice-table th {
            font-weight: 600;
            background: var(--stone-100);
        }
        
        .invoice-total {
            text-align: right;
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--stone-300);
        }
        
        /* Data persistence indicator */
        .save-indicator {
            font-size: 0.75rem;
            color: var(--stone-400);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .save-indicator.saving {
            color: var(--amber-500);
        }
        
        .save-indicator.saved {
            color: var(--emerald-500);
        }
        
        /* iOS Splash/Loading Screen */
        #splashScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--teal-600) 0%, var(--teal-800) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        
        #splashScreen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .splash-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: splash-bounce 1s ease infinite;
        }
        
        .splash-title {
            font-family: var(--font-display);
            font-size: 2rem;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .splash-subtitle {
            color: var(--teal-200);
            font-size: 1rem;
        }
        
        .splash-loader {
            margin-top: 2rem;
            width: 40px;
            height: 40px;
            border: 3px solid var(--teal-400);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes splash-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* ===== PUBLIC WEBSITE ===== */
        #publicWebsite {
            font-family: var(--font-body);
            color: var(--stone-800);
            background: var(--stone-50);
            min-height: 100vh;
        }
        
        [data-theme="dark"] #publicWebsite {
            background: var(--stone-900);
            color: var(--stone-200);
        }
        
        /* --- Site Nav --- */
        .site-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(250, 250, 249, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(214, 211, 209, 0.4);
            transition: background 0.3s;
        }
        
        [data-theme="dark"] .site-nav {
            background: rgba(28, 25, 23, 0.8);
            border-bottom-color: rgba(68, 64, 60, 0.4);
        }
        
        .site-nav-brand {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-family: var(--font-display);
            font-weight: 800;
            font-size: 1.25rem;
            color: var(--stone-800);
            text-decoration: none;
        }
        
        [data-theme="dark"] .site-nav-brand {
            color: var(--stone-100);
        }
        
        .site-nav-brand .bird-icon {
            font-size: 1.5rem;
        }
        
        .site-nav-links {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .site-nav-links a {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--stone-500);
            text-decoration: none;
            transition: color 0.2s;
            letter-spacing: 0.01em;
        }
        
        .site-nav-links a:hover {
            color: var(--stone-800);
        }
        
        [data-theme="dark"] .site-nav-links a:hover {
            color: var(--stone-100);
        }
        
        .site-portal-btn {
            padding: 0.6rem 1.4rem;
            background: linear-gradient(135deg, var(--teal-500) 0%, var(--teal-600) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(20, 184, 166, 0.25);
        }
        
        .site-portal-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(20, 184, 166, 0.35);
        }
        
        /* --- Hero --- */
        .site-hero {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8rem 2rem 6rem;
            position: relative;
            overflow: hidden;
        }
        
        .site-hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(ellipse at 20% 50%, rgba(251, 191, 36, 0.12) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 30%, rgba(20, 184, 166, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 60% 80%, rgba(251, 191, 36, 0.06) 0%, transparent 40%);
            pointer-events: none;
        }
        
        [data-theme="dark"] .site-hero::before {
            background: 
                radial-gradient(ellipse at 20% 50%, rgba(251, 191, 36, 0.06) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 30%, rgba(20, 184, 166, 0.05) 0%, transparent 50%);
        }
        
        /* Piano keys decoration */
        .site-hero::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: repeating-linear-gradient(
                90deg,
                white 0px, white 60px,
                var(--stone-200) 60px, var(--stone-200) 61px,
                white 61px, white 90px,
                var(--stone-800) 90px, var(--stone-800) 120px,
                white 120px, white 121px
            );
            opacity: 0.08;
            pointer-events: none;
        }
        
        .site-hero-content {
            max-width: 720px;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .site-hero-badge {
            display: inline-block;
            padding: 0.4rem 1rem;
            background: rgba(20, 184, 166, 0.1);
            border: 1px solid rgba(20, 184, 166, 0.2);
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--teal-700);
            margin-bottom: 2rem;
            letter-spacing: 0.02em;
        }
        
        [data-theme="dark"] .site-hero-badge {
            background: rgba(20, 184, 166, 0.08);
            border-color: rgba(20, 184, 166, 0.15);
            color: var(--teal-400);
        }
        
        .site-hero h1 {
            font-family: var(--font-display);
            font-size: clamp(2.8rem, 6vw, 4.2rem);
            font-weight: 800;
            line-height: 1.1;
            color: var(--stone-900);
            margin-bottom: 1.5rem;
            letter-spacing: -0.025em;
        }
        
        [data-theme="dark"] .site-hero h1 {
            color: var(--stone-50);
        }
        
        .site-hero h1 .accent {
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--teal-500) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .site-hero-sub {
            font-size: 1.15rem;
            line-height: 1.7;
            color: var(--stone-500);
            max-width: 540px;
            margin: 0 auto 2.5rem;
        }
        
        .site-hero-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .site-btn-primary {
            padding: 0.9rem 2rem;
            background: linear-gradient(135deg, var(--teal-500) 0%, var(--teal-600) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 14px rgba(20, 184, 166, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .site-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(20, 184, 166, 0.4);
        }
        
        .site-btn-secondary {
            padding: 0.9rem 2rem;
            background: white;
            color: var(--stone-700);
            border: 1px solid var(--stone-200);
            border-radius: 12px;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .site-btn-secondary:hover {
            background: var(--stone-50);
            border-color: var(--stone-300);
            transform: translateY(-1px);
        }
        
        [data-theme="dark"] .site-btn-secondary {
            background: var(--stone-800);
            color: var(--stone-200);
            border-color: var(--stone-700);
        }
        
        /* --- Section Shared --- */
        .site-section {
            padding: 6rem 2rem;
        }
        
        .site-section-label {
            display: inline-block;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--teal-600);
            margin-bottom: 0.75rem;
        }
        
        .site-section h2 {
            font-family: var(--font-display);
            font-size: clamp(1.8rem, 4vw, 2.4rem);
            font-weight: 800;
            color: var(--stone-900);
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
        }
        
        [data-theme="dark"] .site-section h2 {
            color: var(--stone-50);
        }
        
        .site-section-desc {
            font-size: 1.05rem;
            line-height: 1.7;
            color: var(--stone-500);
            max-width: 560px;
        }
        
        /* --- About --- */
        .site-about {
            background: white;
        }
        
        [data-theme="dark"] .site-about {
            background: var(--stone-800);
        }
        
        .site-about-inner {
            max-width: 1100px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4rem;
            align-items: center;
        }
        
        .site-about-img {
            width: 100%;
            aspect-ratio: 4/3;
            background: linear-gradient(135deg, var(--stone-200) 0%, var(--stone-100) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            overflow: hidden;
            position: relative;
        }
        
        [data-theme="dark"] .site-about-img {
            background: linear-gradient(135deg, var(--stone-700) 0%, var(--stone-600) 100%);
        }
        
        .site-about-img::after {
            content: '🎹';
            font-size: 5rem;
        }
        
        .site-about-text p {
            font-size: 1.05rem;
            line-height: 1.8;
            color: var(--stone-600);
            margin-bottom: 1.5rem;
        }
        
        [data-theme="dark"] .site-about-text p {
            color: var(--stone-400);
        }
        
        .site-stat-row {
            display: flex;
            gap: 2.5rem;
            margin-top: 2rem;
        }
        
        .site-stat {
            text-align: center;
        }
        
        .site-stat-num {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 800;
            color: var(--teal-600);
        }
        
        .site-stat-label {
            font-size: 0.8rem;
            color: var(--stone-500);
            margin-top: 0.15rem;
        }
        
        /* --- Services --- */
        .site-services {
            background: var(--stone-50);
        }
        
        [data-theme="dark"] .site-services {
            background: var(--stone-900);
        }
        
        .site-services-inner {
            max-width: 1100px;
            margin: 0 auto;
        }
        
        .site-services-header {
            text-align: center;
            margin-bottom: 3.5rem;
        }
        
        .site-services-header .site-section-desc {
            margin: 0 auto;
        }
        
        .site-services-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        
        .site-service-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--stone-100);
            transition: all 0.25s;
        }
        
        .site-service-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(28, 25, 23, 0.08);
        }
        
        [data-theme="dark"] .site-service-card {
            background: var(--stone-800);
            border-color: var(--stone-700);
        }
        
        .site-service-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            margin-bottom: 1.25rem;
        }
        
        .site-service-card:nth-child(1) .site-service-icon { background: rgba(251, 191, 36, 0.12); }
        .site-service-card:nth-child(2) .site-service-icon { background: rgba(20, 184, 166, 0.1); }
        .site-service-card:nth-child(3) .site-service-icon { background: rgba(244, 114, 182, 0.1); }
        
        .site-service-card h3 {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--stone-800);
            margin-bottom: 0.6rem;
        }
        
        [data-theme="dark"] .site-service-card h3 {
            color: var(--stone-100);
        }
        
        .site-service-card p {
            font-size: 0.9rem;
            line-height: 1.65;
            color: var(--stone-500);
        }
        
        .site-service-price {
            margin-top: 1.25rem;
            padding-top: 1rem;
            border-top: 1px solid var(--stone-100);
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--teal-600);
        }
        
        [data-theme="dark"] .site-service-price { border-top-color: var(--stone-700); }
        
        .site-service-price span {
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--stone-400);
        }
        
        /* --- Testimonials --- */
        .site-testimonials {
            background: white;
        }
        
        [data-theme="dark"] .site-testimonials {
            background: var(--stone-800);
        }
        
        .site-testimonials-inner {
            max-width: 1100px;
            margin: 0 auto;
        }
        
        .site-testimonials-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .site-testimonials-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        
        .site-testimonial-card {
            background: var(--stone-50);
            border-radius: 16px;
            padding: 2rem;
        }
        
        [data-theme="dark"] .site-testimonial-card {
            background: var(--stone-700);
        }
        
        .site-testimonial-stars {
            color: var(--amber-400);
            font-size: 0.9rem;
            letter-spacing: 2px;
            margin-bottom: 1rem;
        }
        
        .site-testimonial-card blockquote {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--stone-600);
            font-style: italic;
            margin-bottom: 1.25rem;
        }
        
        [data-theme="dark"] .site-testimonial-card blockquote {
            color: var(--stone-300);
        }
        
        .site-testimonial-author {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .site-testimonial-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--teal-400), var(--amber-400));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: white;
            font-weight: 700;
        }
        
        .site-testimonial-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--stone-800);
        }
        
        [data-theme="dark"] .site-testimonial-name {
            color: var(--stone-100);
        }
        
        .site-testimonial-detail {
            font-size: 0.75rem;
            color: var(--stone-400);
        }
        
        /* --- CTA --- */
        .site-cta {
            background: linear-gradient(135deg, var(--stone-900) 0%, var(--stone-800) 100%);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .site-cta::before {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(ellipse at 30% 50%, rgba(20, 184, 166, 0.15) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 50%, rgba(251, 191, 36, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .site-cta-inner {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .site-cta h2 {
            color: white;
            margin-bottom: 1rem;
        }
        
        .site-cta p {
            color: var(--stone-400);
            font-size: 1.05rem;
            line-height: 1.7;
            margin-bottom: 2rem;
        }
        
        .site-cta .site-btn-primary {
            margin: 0 auto;
        }
        
        /* --- Footer --- */
        .site-footer {
            padding: 3rem 2rem;
            background: var(--stone-900);
            border-top: 1px solid var(--stone-800);
        }
        
        .site-footer-inner {
            max-width: 1100px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .site-footer-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1rem;
            color: var(--stone-400);
        }
        
        .site-footer-copy {
            font-size: 0.8rem;
            color: var(--stone-600);
        }
        
        .site-footer-links {
            display: flex;
            gap: 1.5rem;
        }
        
        .site-footer-links a {
            font-size: 0.8rem;
            color: var(--stone-500);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .site-footer-links a:hover {
            color: var(--stone-300);
        }
        
        /* --- Back to website link on login --- */
        .back-to-site {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--stone-400);
            cursor: pointer;
            background: none;
            border: none;
            font-family: var(--font-body);
            transition: color 0.2s;
            margin-top: 0.75rem;
        }
        
        .back-to-site:hover {
            color: var(--teal-500);
        }
        
        /* --- Responsive --- */
        @media (max-width: 768px) {
            .site-nav-links a:not(.site-portal-btn-wrap) { display: none; }
            .site-about-inner { grid-template-columns: 1fr; gap: 2rem; }
            .site-services-grid { grid-template-columns: 1fr; }
            .site-testimonials-grid { grid-template-columns: 1fr; }
            .site-hero { padding: 7rem 1.5rem 4rem; }
            .site-footer-inner { flex-direction: column; text-align: center; }
        }
        
        /* --- Entrance animations --- */
        @keyframes site-fade-up {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .site-anim {
            animation: site-fade-up 0.7s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
        
        .site-anim-d1 { animation-delay: 0.1s; }
        .site-anim-d2 { animation-delay: 0.2s; }
        .site-anim-d3 { animation-delay: 0.3s; }
        .site-anim-d4 { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <!-- iOS Splash Screen -->
    <div id="splashScreen">
        <div class="splash-icon">🐦</div>
        <div class="splash-title">Loonie Bird</div>
        <div class="splash-subtitle">Music Lesson Scheduler</div>
        <div class="splash-loader"></div>
    </div>
    
    <!-- ===== PUBLIC WEBSITE ===== -->
    <div id="publicWebsite">
        <nav class="site-nav">
            <a href="#" class="site-nav-brand" onclick="event.preventDefault();">
                <span class="bird-icon">🐦</span> Loonie Bird Studio
            </a>
            <div class="site-nav-links">
                <a href="#about" onclick="smoothScroll(event, 'about')">About</a>
                <a href="#lessons" onclick="smoothScroll(event, 'lessons')">Lessons</a>
                <a href="#testimonials" onclick="smoothScroll(event, 'testimonials')">Kind Words</a>
                <a href="#contact" onclick="smoothScroll(event, 'contact')">Contact</a>
                <span class="site-portal-btn-wrap">
                    <button onclick="openStudentPortal()" class="site-portal-btn">Student Portal</button>
                </span>
            </div>
        </nav>
        
        <!-- Hero -->
        <section class="site-hero">
            <div class="site-hero-content">
                <div class="site-hero-badge site-anim site-anim-d1">🎵 Now Accepting New Students</div>
                <h1 class="site-anim site-anim-d2">Where music meets <span class="accent">joy</span></h1>
                <p class="site-hero-sub site-anim site-anim-d3">Private piano instruction for all ages and levels. From first notes to recital-ready — learn at your own pace in a warm, encouraging environment.</p>
                <div class="site-hero-actions site-anim site-anim-d4">
                    <button onclick="smoothScroll(event, 'lessons')" class="site-btn-primary">View Lesson Options</button>
                    <button onclick="smoothScroll(event, 'contact')" class="site-btn-secondary">✉️ Get in Touch</button>
                </div>
            </div>
        </section>
        
        <!-- About -->
        <section class="site-section site-about" id="about">
            <div class="site-about-inner">
                <div class="site-about-img"></div>
                <div class="site-about-text">
                    <span class="site-section-label">About</span>
                    <h2>A lifelong love of music starts here</h2>
                    <p>With over 15 years of teaching experience, I believe every student has a unique musical voice waiting to be discovered. My studio provides a supportive space where beginners gain confidence and advanced players refine their artistry.</p>
                    <p>I hold a Bachelor of Music in Piano Performance and have guided hundreds of students through examinations, recitals, and — most importantly — the simple joy of sitting down and playing.</p>
                    <div class="site-stat-row">
                        <div class="site-stat">
                            <div class="site-stat-num">15+</div>
                            <div class="site-stat-label">Years Teaching</div>
                        </div>
                        <div class="site-stat">
                            <div class="site-stat-num">200+</div>
                            <div class="site-stat-label">Students Taught</div>
                        </div>
                        <div class="site-stat">
                            <div class="site-stat-num">98%</div>
                            <div class="site-stat-label">Exam Pass Rate</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Services -->
        <section class="site-section site-services" id="lessons">
            <div class="site-services-inner">
                <div class="site-services-header">
                    <span class="site-section-label">Lessons</span>
                    <h2>Find the right fit for your journey</h2>
                    <p class="site-section-desc">Whether you're just starting out or preparing for an exam, there's a lesson format designed for you.</p>
                </div>
                <div class="site-services-grid">
                    <div class="site-service-card">
                        <div class="site-service-icon">🌱</div>
                        <h3>Beginner Foundations</h3>
                        <p>Perfect for ages 5+ with no prior experience. Build rhythm, reading, and technique through playful, encouraging lessons.</p>
                        <div class="site-service-price">$XX <span>/ 30 min</span></div>
                    </div>
                    <div class="site-service-card">
                        <div class="site-service-icon">🎵</div>
                        <h3>Intermediate Growth</h3>
                        <p>Expand your repertoire, strengthen sight-reading, and develop musical expression. Ideal for students with 1–3 years of experience.</p>
                        <div class="site-service-price">$XX <span>/ 45 min</span></div>
                    </div>
                    <div class="site-service-card">
                        <div class="site-service-icon">🏆</div>
                        <h3>Advanced &amp; Exam Prep</h3>
                        <p>Intensive preparation for RCM, ABRSM, or conservatory exams. Focused technique, theory integration, and performance coaching.</p>
                        <div class="site-service-price">$XX <span>/ 60 min</span></div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Testimonials -->
        <section class="site-section site-testimonials" id="testimonials">
            <div class="site-testimonials-inner">
                <div class="site-testimonials-header">
                    <span class="site-section-label">Kind Words</span>
                    <h2>What families are saying</h2>
                </div>
                <div class="site-testimonials-grid">
                    <div class="site-testimonial-card">
                        <div class="site-testimonial-stars">★★★★★</div>
                        <blockquote>"My daughter used to dread practice — now she runs to the piano after school. The patience and creativity in every lesson is remarkable."</blockquote>
                        <div class="site-testimonial-author">
                            <div class="site-testimonial-avatar">S</div>
                            <div>
                                <div class="site-testimonial-name">Sarah M.</div>
                                <div class="site-testimonial-detail">Parent · 2 years</div>
                            </div>
                        </div>
                    </div>
                    <div class="site-testimonial-card">
                        <div class="site-testimonial-stars">★★★★★</div>
                        <blockquote>"I started as a complete beginner at 40. The lessons are tailored exactly to my pace, and I just passed my Grade 3 exam!"</blockquote>
                        <div class="site-testimonial-author">
                            <div class="site-testimonial-avatar">J</div>
                            <div>
                                <div class="site-testimonial-name">James T.</div>
                                <div class="site-testimonial-detail">Adult student · 1 year</div>
                            </div>
                        </div>
                    </div>
                    <div class="site-testimonial-card">
                        <div class="site-testimonial-stars">★★★★★</div>
                        <blockquote>"The online scheduling system makes our busy family life so much easier. And both our kids genuinely look forward to their lessons."</blockquote>
                        <div class="site-testimonial-author">
                            <div class="site-testimonial-avatar">R</div>
                            <div>
                                <div class="site-testimonial-name">Rachel &amp; Dan K.</div>
                                <div class="site-testimonial-detail">Parents · 3 years</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- CTA -->
        <section class="site-section site-cta" id="contact">
            <div class="site-cta-inner">
                <span class="site-section-label" style="color: var(--teal-400);">Get Started</span>
                <h2>Ready to begin your musical journey?</h2>
                <p>Reach out for a free introductory consultation. I'd love to learn about your goals and find the perfect lesson plan for you or your child.</p>
                <button class="site-btn-primary" onclick="alert('Contact form placeholder — replace with your email or booking link!')">✉️ Get in Touch</button>
            </div>
        </section>
        
        <!-- Footer -->
        <footer class="site-footer">
            <div class="site-footer-inner">
                <div class="site-footer-brand">
                    <span>🐦</span> Loonie Bird Studio
                </div>
                <div class="site-footer-copy">© 2026 Loonie Bird Studio. All rights reserved.</div>
                <div class="site-footer-links">
                    <a href="#">Privacy</a>
                    <a href="#">Terms</a>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <span class="bird-icon">🐦</span>
                <h1>Loonie Bird</h1>
                <p>Music Lesson Scheduler</p>
            </div>
            
            <button onclick="loginAsTeacher()" class="login-btn login-btn-primary">
                <span>👨‍🏫</span> Teacher Login
            </button>
            
            <div class="login-divider">
                <span>or student access</span>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label class="form-label">Family Code</label>
                <input 
                    type="text" 
                    id="familyCodeInput" 
                    placeholder="Enter your code" 
                    class="login-input"
                    onkeypress="if(event.key==='Enter') loginAsStudent()"
                >
            </div>
            
            <button onclick="loginAsStudent()" class="login-btn login-btn-secondary">
                <span>🎓</span> Student Login
            </button>
            
            <div class="login-help">
                <p>Need a code? Contact your teacher</p>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center;">
                    <button onclick="toggleDarkMode()" class="theme-toggle" id="loginThemeToggle" title="Toggle dark mode">🌙</button>
                    <button onclick="clearAllData()" style="padding: 0.5rem 1rem; background: var(--stone-200); border: none; border-radius: 8px; font-size: 0.75rem; color: var(--stone-500); cursor: pointer;">Reset All Data</button>
                </div>
                <button onclick="backToWebsite()" class="back-to-site">← Back to Website</button>
            </div>
        </div>
    </div>
    
    <!-- Teacher Dashboard -->
    <div id="teacherDashboard" style="display: none;">
        <div class="dashboard-container">
            <div class="dashboard-header">
                <span class="bird-icon" style="font-size: 3rem;">🐦</span>
                <h1 class="dashboard-title">Loonie Bird</h1>
                <p class="dashboard-subtitle">Teacher Dashboard</p>
            </div>
            
            <div class="dashboard-grid">
                <div class="dashboard-card dashboard-card-schedule" onclick="goToCalendar()">
                    <div class="dashboard-card-icon">📅</div>
                    <div class="dashboard-card-label">Lesson Schedule</div>
                    <div class="dashboard-card-desc">View and manage your weekly calendar</div>
                    <div class="dashboard-card-stat" id="dashTodayLessons"></div>
                </div>
                
                <div class="dashboard-card dashboard-card-students" onclick="openDashboardModal(showStudentsModal)">
                    <div class="dashboard-card-icon">👥</div>
                    <div class="dashboard-card-label">Student Roster</div>
                    <div class="dashboard-card-desc">Profiles, contacts, and family codes</div>
                    <div class="dashboard-card-stat" id="dashStudentCount"></div>
                </div>
                
                <div class="dashboard-card dashboard-card-payments" onclick="openDashboardModal(showPaymentsModal)" style="overflow: hidden;">
                    <div class="draft-stamp">DRAFT</div>
                    <div class="dashboard-card-icon">💰</div>
                    <div class="dashboard-card-label">Payments</div>
                    <div class="dashboard-card-desc">Invoices, balances, and payment history</div>
                    <div class="dashboard-card-stat" id="dashPaymentStat"></div>
                </div>
            </div>
            
            <div class="dashboard-footer">
                <button onclick="toggleDarkMode()" class="theme-toggle" id="dashThemeToggle" title="Toggle dark mode">🌙</button>
                <button onclick="logout()" class="dashboard-logout">Logout</button>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="mainApp">
        <header class="app-header">
            <div class="header-content">
                <div class="header-top">
                    <div class="header-brand">
                        <span class="bird-icon">🐦</span>
                        <h1>Loonie Bird</h1>
                    </div>
                    <div class="header-user">
                        <span class="save-indicator" id="saveIndicator">💾 Saved</span>
                        <button onclick="toggleDarkMode()" class="theme-toggle" id="themeToggle" title="Toggle dark mode">🌙</button>
                        <div class="user-badge" id="loginStatus"></div>
                        <button onclick="goToDashboard()" class="logout-btn" id="dashboardBtn" style="background: var(--teal-600); color: white;">Dashboard</button>
                        <button onclick="logout()" class="logout-btn">Logout</button>
                    </div>
                </div>
                
                <div id="teacherControls" class="control-bar">
                    <button onclick="showAddModal()" class="btn btn-add">
                        <span>+</span> Add Lesson
                    </button>
                    <button onclick="showBlockTimeModal()" class="btn btn-block">
                        <span>🚫</span> Block Time
                    </button>
                    <button onclick="showTeacherSwapRequests()" class="btn btn-swaps" id="teacherSwapBtn">
                        <span>🔄</span> Swap Requests
                    </button>
                    <button onclick="showTeacherMoveRequests()" class="btn btn-reschedule" id="teacherMoveBtn">
                        <span>📅</span> Reschedule Requests
                    </button>
                    <div class="week-nav">
                        <button onclick="changeWeek(-1)" class="btn-nav">← Previous</button>
                        <button id="weekLabel" onclick="goToToday()" class="btn-nav btn-today">Today</button>
                        <button onclick="changeWeek(1)" class="btn-nav">Next →</button>
                        <button onclick="toggleMiniCalendar(event)" class="btn-nav btn-mini-cal" title="Jump to week">📆</button>
                        <div id="miniCalendar" class="mini-calendar hidden"></div>
                    </div>
                </div>
                
                <div id="studentControls" class="control-bar hidden">
                    <button onclick="showMyLessonsForSwap()" class="btn btn-swap">
                        <span>🔄</span> Swap Lesson with another student
                        <span id="mySwapBadge" class="badge hidden">0</span>
                    </button>
                    <button onclick="showMyLessonsForReschedule()" class="btn btn-reschedule-student">
                        <span>📩</span> Request Teacher for a Reschedule
                    </button>
                    <div class="week-nav">
                        <button onclick="changeWeek(-1)" class="btn-nav">← Previous</button>
                        <button id="weekLabel2" onclick="goToToday()" class="btn-nav btn-today">Today</button>
                        <button onclick="changeWeek(1)" class="btn-nav">Next →</button>
                        <button onclick="toggleMiniCalendar(event)" class="btn-nav btn-mini-cal" title="Jump to week">📆</button>
                        <div id="miniCalendar2" class="mini-calendar hidden"></div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="calendar-container">
            <div class="calendar-wrapper">
                <div id="calendar"></div>
            </div>
        </div>
        
        <!-- Floating Action Button -->
        <button id="fab" class="fab hidden" onclick="showAddModal()" title="Add Lesson">+</button>
    </div>
    
    <!-- Modal -->
    <div id="modal">
        <div id="modalContent"></div>
    </div>
    
    <!-- Toast -->
    <div id="toast"></div>

<script>
// ===== DATA PERSISTENCE =====
const STORAGE_KEY = 'loonieBirdData';

function saveData() {
    const indicator = document.getElementById('saveIndicator');
    if(indicator) {
        indicator.textContent = '💾 Saving...';
        indicator.className = 'save-indicator saving';
    }
    
    const data = {
        lessons: lessons,
        blockedTimes: blockedTimes,
        studentProfiles: studentProfiles,
        swapRequests: swapRequests,
        moveRequests: moveRequests,
        payments: payments,
        lessonRates: lessonRates,
        seenNotifications: seenNotifications,
        seenRescheduleNotifications: seenRescheduleNotifications,
        nextId: nextId,
        nextSeriesId: nextSeriesId,
        nextBlockId: nextBlockId,
        nextSwapId: nextSwapId,
        nextMoveId: nextMoveId,
        nextPaymentId: nextPaymentId,
        darkMode: document.documentElement.getAttribute('data-theme') === 'dark'
    };
    
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        if(indicator) {
            setTimeout(() => {
                indicator.textContent = '✓ Saved';
                indicator.className = 'save-indicator saved';
                setTimeout(() => {
                    indicator.textContent = '💾 Saved';
                    indicator.className = 'save-indicator';
                }, 1500);
            }, 300);
        }
    } catch(e) {
        console.error('Failed to save data:', e);
        if(indicator) {
            indicator.textContent = '⚠️ Save failed';
            indicator.className = 'save-indicator';
        }
    }
}

function loadData() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) {
            const data = JSON.parse(saved);
            
            // Restore data
            if(data.lessons) lessons = data.lessons;
            if(data.blockedTimes) blockedTimes = data.blockedTimes;
            if(data.studentProfiles) studentProfiles = data.studentProfiles;
            if(data.swapRequests) swapRequests = data.swapRequests;
            if(data.moveRequests) moveRequests = data.moveRequests;
            if(data.payments) payments = data.payments;
            if(data.lessonRates) lessonRates = data.lessonRates;
            if(data.seenNotifications) seenNotifications = data.seenNotifications;
            if(data.seenRescheduleNotifications) seenRescheduleNotifications = data.seenRescheduleNotifications;
            if(data.nextId) nextId = data.nextId;
            if(data.nextSeriesId) nextSeriesId = data.nextSeriesId;
            if(data.nextBlockId) nextBlockId = data.nextBlockId;
            if(data.nextSwapId) nextSwapId = data.nextSwapId;
            if(data.nextMoveId) nextMoveId = data.nextMoveId;
            if(data.nextPaymentId) nextPaymentId = data.nextPaymentId;
            if(data.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            }
            
            return true;
        }
    } catch(e) {
        console.error('Failed to load data:', e);
    }
    return false;
}

function clearAllData() {
    if(confirm('Clear ALL data and reset? This cannot be undone!')) {
        localStorage.removeItem(STORAGE_KEY);
        window.location.reload(true);
    }
}

function toggleDarkMode() {
    const html = document.documentElement;
    const isDark = html.getAttribute('data-theme') === 'dark';
    
    if(isDark) {
        html.removeAttribute('data-theme');
    } else {
        html.setAttribute('data-theme', 'dark');
    }
    
    updateThemeIcon();
    saveData();
}

function updateThemeIcon() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const icon = isDark ? '☀️' : '🌙';
    const title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
    
    const btn = document.getElementById('themeToggle');
    if(btn) {
        btn.textContent = icon;
        btn.title = title;
    }
    
    const loginBtn = document.getElementById('loginThemeToggle');
    if(loginBtn) {
        loginBtn.textContent = icon;
        loginBtn.title = title;
    }
}

// ===== CORE DATA =====
let lessons = [
    // Monday lessons
    {id: 1, firstName: "Emma", lastName: "Smith", day: 0, time: "15:00", duration: 60, isRecurring: true, seriesId: "series-1", week: 0},
    {id: 2, firstName: "Noah", lastName: "Wilson", day: 0, time: "16:15", duration: 30, isRecurring: true, seriesId: "series-2", week: 0},
    {id: 3, firstName: "Ethan", lastName: "Miller", day: 0, time: "09:00", duration: 45, isRecurring: true, seriesId: "series-3", week: 0},
    {id: 4, firstName: "Mia", lastName: "Anderson", day: 0, time: "10:00", duration: 60, isRecurring: true, seriesId: "series-4", week: 0},
    {id: 5, firstName: "Harper", lastName: "Thomas", day: 0, time: "17:00", duration: 45, isRecurring: true, seriesId: "series-5", week: 0},
    
    // Tuesday lessons
    {id: 6, firstName: "Liam", lastName: "Jones", day: 1, time: "16:00", duration: 45, isRecurring: true, seriesId: "series-6", week: 0},
    {id: 7, firstName: "Sophia", lastName: "Garcia", day: 1, time: "10:00", duration: 60, isRecurring: true, seriesId: "series-7", week: 0},
    {id: 8, firstName: "Charlotte", lastName: "Moore", day: 1, time: "14:00", duration: 30, isRecurring: true, seriesId: "series-8", week: 0},
    {id: 9, firstName: "Benjamin", lastName: "Jackson", day: 1, time: "15:00", duration: 60, isRecurring: true, seriesId: "series-9", week: 0},
    {id: 10, firstName: "Elijah", lastName: "White", day: 1, time: "17:00", duration: 45, isRecurring: true, seriesId: "series-10", week: 0},
    
    // Wednesday lessons
    {id: 11, firstName: "Olivia", lastName: "Davis", day: 2, time: "14:00", duration: 60, isRecurring: true, seriesId: "series-11", week: 0},
    {id: 12, firstName: "Mason", lastName: "Martinez", day: 2, time: "18:00", duration: 30, isRecurring: true, seriesId: "series-12", week: 0},
    {id: 13, firstName: "Amelia", lastName: "Harris", day: 2, time: "09:30", duration: 45, isRecurring: true, seriesId: "series-13", week: 0},
    {id: 14, firstName: "James", lastName: "Clark", day: 2, time: "11:00", duration: 60, isRecurring: true, seriesId: "series-14", week: 0},
    {id: 15, firstName: "Evelyn", lastName: "Lewis", day: 2, time: "15:30", duration: 30, isRecurring: true, seriesId: "series-15", week: 0},
    
    // Thursday lessons
    {id: 16, firstName: "Ava", lastName: "Brown", day: 3, time: "15:00", duration: 60, isRecurring: true, seriesId: "series-16", week: 0},
    {id: 17, firstName: "Isabella", lastName: "Lee", day: 3, time: "11:00", duration: 60, isRecurring: true, seriesId: "series-17", week: 0},
    {id: 18, firstName: "Lucas", lastName: "Taylor", day: 3, time: "13:00", duration: 45, isRecurring: true, seriesId: "series-18", week: 0},
    {id: 19, firstName: "Alexander", lastName: "Robinson", day: 3, time: "16:30", duration: 30, isRecurring: true, seriesId: "series-19", week: 0},
    {id: 20, firstName: "Henry", lastName: "Walker", day: 3, time: "09:00", duration: 45, isRecurring: true, seriesId: "series-20", week: 0},
    
    // Friday lessons
    {id: 21, firstName: "Luna", lastName: "Hall", day: 4, time: "10:00", duration: 60, isRecurring: true, seriesId: "series-21", week: 0},
    {id: 22, firstName: "Sebastian", lastName: "Allen", day: 4, time: "14:00", duration: 45, isRecurring: true, seriesId: "series-22", week: 0},
    {id: 23, firstName: "Aria", lastName: "Young", day: 4, time: "15:30", duration: 60, isRecurring: true, seriesId: "series-23", week: 0},
    {id: 24, firstName: "Jack", lastName: "King", day: 4, time: "17:00", duration: 30, isRecurring: true, seriesId: "series-24", week: 0},
    {id: 25, firstName: "Chloe", lastName: "Wright", day: 4, time: "11:30", duration: 60, isRecurring: true, seriesId: "series-25", week: 0},
    {id: 26, firstName: "Daniel", lastName: "Scott", day: 4, time: "13:00", duration: 45, isRecurring: true, seriesId: "series-26", week: 0},
    {id: 27, firstName: "Penelope", lastName: "Green", day: 4, time: "18:00", duration: 30, isRecurring: true, seriesId: "series-27", week: 0},
    {id: 28, firstName: "Owen", lastName: "Baker", day: 4, time: "19:00", duration: 60, isRecurring: true, seriesId: "series-28", week: 0}
];
let blockedTimes = [
    // Weekday lunch breaks
    {id: 1, day: 0, time: "12:00", duration: 60, reason: "Lunch", week: 0},
    {id: 2, day: 1, time: "12:00", duration: 60, reason: "Lunch", week: 0},
    {id: 3, day: 2, time: "12:00", duration: 60, reason: "Lunch", week: 0},
    {id: 4, day: 3, time: "12:00", duration: 60, reason: "Lunch", week: 0},
    {id: 5, day: 4, time: "12:00", duration: 60, reason: "Lunch", week: 0},
    
    // Saturday - hourly blocks (day 5)
    {id: 6, day: 5, time: "08:00", duration: 60, reason: "Weekend", week: 0},
    {id: 7, day: 5, time: "09:00", duration: 60, reason: "Weekend", week: 0},
    {id: 8, day: 5, time: "10:00", duration: 60, reason: "Weekend", week: 0},
    {id: 9, day: 5, time: "11:00", duration: 60, reason: "Weekend", week: 0},
    {id: 10, day: 5, time: "12:00", duration: 60, reason: "Weekend", week: 0},
    {id: 11, day: 5, time: "13:00", duration: 60, reason: "Weekend", week: 0},
    {id: 12, day: 5, time: "14:00", duration: 60, reason: "Weekend", week: 0},
    {id: 13, day: 5, time: "15:00", duration: 60, reason: "Weekend", week: 0},
    {id: 14, day: 5, time: "16:00", duration: 60, reason: "Weekend", week: 0},
    {id: 15, day: 5, time: "17:00", duration: 60, reason: "Weekend", week: 0},
    {id: 16, day: 5, time: "18:00", duration: 60, reason: "Weekend", week: 0},
    {id: 17, day: 5, time: "19:00", duration: 60, reason: "Weekend", week: 0},
    {id: 18, day: 5, time: "20:00", duration: 60, reason: "Weekend", week: 0},
    
    // Sunday - hourly blocks (day 6)
    {id: 19, day: 6, time: "08:00", duration: 60, reason: "Weekend", week: 0},
    {id: 20, day: 6, time: "09:00", duration: 60, reason: "Weekend", week: 0},
    {id: 21, day: 6, time: "10:00", duration: 60, reason: "Weekend", week: 0},
    {id: 22, day: 6, time: "11:00", duration: 60, reason: "Weekend", week: 0},
    {id: 23, day: 6, time: "12:00", duration: 60, reason: "Weekend", week: 0},
    {id: 24, day: 6, time: "13:00", duration: 60, reason: "Weekend", week: 0},
    {id: 25, day: 6, time: "14:00", duration: 60, reason: "Weekend", week: 0},
    {id: 26, day: 6, time: "15:00", duration: 60, reason: "Weekend", week: 0},
    {id: 27, day: 6, time: "16:00", duration: 60, reason: "Weekend", week: 0},
    {id: 28, day: 6, time: "17:00", duration: 60, reason: "Weekend", week: 0},
    {id: 29, day: 6, time: "18:00", duration: 60, reason: "Weekend", week: 0},
    {id: 30, day: 6, time: "19:00", duration: 60, reason: "Weekend", week: 0},
    {id: 31, day: 6, time: "20:00", duration: 60, reason: "Weekend", week: 0},
    
    // Night hours (9pm-midnight) - hourly blocks for all days
    {id: 32, day: 0, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 33, day: 0, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 34, day: 0, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 35, day: 1, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 36, day: 1, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 37, day: 1, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 38, day: 2, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 39, day: 2, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 40, day: 2, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 41, day: 3, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 42, day: 3, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 43, day: 3, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 44, day: 4, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 45, day: 4, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 46, day: 4, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 47, day: 5, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 48, day: 5, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 49, day: 5, time: "23:00", duration: 60, reason: "Closed", week: 0},
    {id: 50, day: 6, time: "21:00", duration: 60, reason: "Closed", week: 0},
    {id: 51, day: 6, time: "22:00", duration: 60, reason: "Closed", week: 0},
    {id: 52, day: 6, time: "23:00", duration: 60, reason: "Closed", week: 0},
    
    // Early morning (midnight-8am) - hourly blocks for all days
    {id: 53, day: 0, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 54, day: 0, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 55, day: 0, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 56, day: 0, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 57, day: 0, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 58, day: 0, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 59, day: 0, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 60, day: 0, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 61, day: 1, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 62, day: 1, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 63, day: 1, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 64, day: 1, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 65, day: 1, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 66, day: 1, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 67, day: 1, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 68, day: 1, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 69, day: 2, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 70, day: 2, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 71, day: 2, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 72, day: 2, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 73, day: 2, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 74, day: 2, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 75, day: 2, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 76, day: 2, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 77, day: 3, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 78, day: 3, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 79, day: 3, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 80, day: 3, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 81, day: 3, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 82, day: 3, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 83, day: 3, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 84, day: 3, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 85, day: 4, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 86, day: 4, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 87, day: 4, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 88, day: 4, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 89, day: 4, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 90, day: 4, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 91, day: 4, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 92, day: 4, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 93, day: 5, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 94, day: 5, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 95, day: 5, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 96, day: 5, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 97, day: 5, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 98, day: 5, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 99, day: 5, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 100, day: 5, time: "07:00", duration: 60, reason: "Closed", week: 0},
    {id: 101, day: 6, time: "00:00", duration: 60, reason: "Closed", week: 0},
    {id: 102, day: 6, time: "01:00", duration: 60, reason: "Closed", week: 0},
    {id: 103, day: 6, time: "02:00", duration: 60, reason: "Closed", week: 0},
    {id: 104, day: 6, time: "03:00", duration: 60, reason: "Closed", week: 0},
    {id: 105, day: 6, time: "04:00", duration: 60, reason: "Closed", week: 0},
    {id: 106, day: 6, time: "05:00", duration: 60, reason: "Closed", week: 0},
    {id: 107, day: 6, time: "06:00", duration: 60, reason: "Closed", week: 0},
    {id: 108, day: 6, time: "07:00", duration: 60, reason: "Closed", week: 0}
];

let studentProfiles = [
    // Original students with full details
    {firstName: "Emma", lastName: "Smith", familyCode: "SMITH2013", dob: "2013-05-14", grade: "6th", school: "Minnehaha Academy", street: "2847 Lyndale Ave S", city: "Minneapolis", state: "MN", zip: "55408", guardianName: "Jennifer Smith", guardianPhone: "(612) 555-0142", guardianEmail: "jsmith@email.com", guardian2Name: "Michael Smith", guardian2Phone: "(612) 555-0143", guardian2Email: "msmith@email.com", photo: "", retired: false},
    {firstName: "Liam", lastName: "Jones", familyCode: "JONES2012", dob: "2012-09-22", grade: "7th", school: "Bryn Mawr Elementary", street: "1523 Penn Ave N", city: "Minneapolis", state: "MN", zip: "55411", guardianName: "Sarah Jones", guardianPhone: "(612) 555-0287", guardianEmail: "sjones@email.com", guardian2Name: "David Jones", guardian2Phone: "(612) 555-0288", guardian2Email: "djones@email.com", photo: "", retired: false},
    {firstName: "Olivia", lastName: "Davis", familyCode: "DAVIS2014", dob: "2014-03-08", grade: "5th", school: "Kenwood Elementary", street: "4219 Xerxes Ave S", city: "Minneapolis", state: "MN", zip: "55410", guardianName: "Amanda Davis", guardianPhone: "(612) 555-0391", guardianEmail: "adavis@email.com", guardian2Name: "Robert Davis", guardian2Phone: "(612) 555-0392", guardian2Email: "rdavis@email.com", photo: "", retired: false},
    
    // New students - Monday
    {firstName: "Noah", lastName: "Wilson", familyCode: "WILSON2015", dob: "2015-07-19", grade: "4th", school: "Clara Barton Elementary", street: "3815 Bryant Ave S", city: "Minneapolis", state: "MN", zip: "55409", guardianName: "Michelle Wilson", guardianPhone: "(612) 555-0445", guardianEmail: "mwilson@email.com", photo: "", retired: false},
    {firstName: "Ethan", lastName: "Miller", familyCode: "MILLER2011", dob: "2011-11-03", grade: "8th", school: "Southwest High School", street: "5128 Harriet Ave S", city: "Minneapolis", state: "MN", zip: "55419", guardianName: "Karen Miller", guardianPhone: "(612) 555-0512", guardianEmail: "kmiller@email.com", photo: "", retired: false},
    {firstName: "Mia", lastName: "Anderson", familyCode: "ANDERSON2016", dob: "2016-02-28", grade: "3rd", school: "Lake Harriet Lower", street: "4401 Chowen Ave S", city: "Minneapolis", state: "MN", zip: "55410", guardianName: "Lisa Anderson", guardianPhone: "(612) 555-0623", guardianEmail: "landerson@email.com", photo: "", retired: false},
    {firstName: "Harper", lastName: "Thomas", familyCode: "THOMAS2013", dob: "2013-08-15", grade: "6th", school: "Anwatin Middle School", street: "2920 Fremont Ave N", city: "Minneapolis", state: "MN", zip: "55411", guardianName: "Jessica Thomas", guardianPhone: "(612) 555-0734", guardianEmail: "jthomas@email.com", photo: "", retired: false},
    
    // New students - Tuesday
    {firstName: "Sophia", lastName: "Garcia", familyCode: "GARCIA2012", dob: "2012-04-22", grade: "7th", school: "Northeast Middle School", street: "1847 Central Ave NE", city: "Minneapolis", state: "MN", zip: "55418", guardianName: "Maria Garcia", guardianPhone: "(612) 555-0845", guardianEmail: "mgarcia@email.com", photo: "", retired: false},
    {firstName: "Charlotte", lastName: "Moore", familyCode: "MOORE2017", dob: "2017-01-09", grade: "2nd", school: "Dowling Elementary", street: "3920 46th Ave S", city: "Minneapolis", state: "MN", zip: "55406", guardianName: "Emily Moore", guardianPhone: "(612) 555-0956", guardianEmail: "emoore@email.com", photo: "", retired: false},
    {firstName: "Benjamin", lastName: "Jackson", familyCode: "JACKSON2010", dob: "2010-06-30", grade: "9th", school: "Washburn High School", street: "5005 Nicollet Ave S", city: "Minneapolis", state: "MN", zip: "55419", guardianName: "Patricia Jackson", guardianPhone: "(612) 555-1067", guardianEmail: "pjackson@email.com", photo: "", retired: false},
    {firstName: "Elijah", lastName: "White", familyCode: "WHITE2014", dob: "2014-12-11", grade: "5th", school: "Whittier Elementary", street: "2600 Blaisdell Ave S", city: "Minneapolis", state: "MN", zip: "55408", guardianName: "Stephanie White", guardianPhone: "(612) 555-1178", guardianEmail: "swhite@email.com", photo: "", retired: false},
    
    // New students - Wednesday
    {firstName: "Mason", lastName: "Martinez", familyCode: "MARTINEZ2015", dob: "2015-09-05", grade: "4th", school: "Jefferson Elementary", street: "1200 26th St NE", city: "Minneapolis", state: "MN", zip: "55418", guardianName: "Carmen Martinez", guardianPhone: "(612) 555-1289", guardianEmail: "cmartinez@email.com", photo: "", retired: false},
    {firstName: "Amelia", lastName: "Harris", familyCode: "HARRIS2013", dob: "2013-03-17", grade: "6th", school: "Ramsey Middle School", street: "4838 Emerson Ave N", city: "Minneapolis", state: "MN", zip: "55430", guardianName: "Rachel Harris", guardianPhone: "(612) 555-1390", guardianEmail: "rharris@email.com", photo: "", retired: false},
    {firstName: "James", lastName: "Clark", familyCode: "CLARK2011", dob: "2011-07-24", grade: "8th", school: "Anthony Middle School", street: "3301 Silver Lake Rd", city: "Minneapolis", state: "MN", zip: "55418", guardianName: "Susan Clark", guardianPhone: "(612) 555-1401", guardianEmail: "sclark@email.com", photo: "", retired: false},
    {firstName: "Evelyn", lastName: "Lewis", familyCode: "LEWIS2016", dob: "2016-10-02", grade: "3rd", school: "Armatage Elementary", street: "5645 Knox Ave S", city: "Minneapolis", state: "MN", zip: "55419", guardianName: "Angela Lewis", guardianPhone: "(612) 555-1512", guardianEmail: "alewis@email.com", photo: "", retired: false},
    
    // New students - Thursday
    {firstName: "Ava", lastName: "Brown", familyCode: "BROWN2014", dob: "2014-05-21", grade: "5th", school: "Bancroft Elementary", street: "3829 13th Ave S", city: "Minneapolis", state: "MN", zip: "55407", guardianName: "Nicole Brown", guardianPhone: "(612) 555-1623", guardianEmail: "nbrown@email.com", photo: "", retired: false},
    {firstName: "Isabella", lastName: "Lee", familyCode: "LEE2012", dob: "2012-08-14", grade: "7th", school: "Olson Middle School", street: "2817 James Ave N", city: "Minneapolis", state: "MN", zip: "55411", guardianName: "Grace Lee", guardianPhone: "(612) 555-1734", guardianEmail: "glee@email.com", photo: "", retired: false},
    {firstName: "Lucas", lastName: "Taylor", familyCode: "TAYLOR2013", dob: "2013-11-28", grade: "6th", school: "Sanford Middle School", street: "4101 Beard Ave S", city: "Minneapolis", state: "MN", zip: "55410", guardianName: "Megan Taylor", guardianPhone: "(612) 555-1845", guardianEmail: "mtaylor@email.com", photo: "", retired: false},
    {firstName: "Alexander", lastName: "Robinson", familyCode: "ROBINSON2015", dob: "2015-04-07", grade: "4th", school: "Loring Elementary", street: "2600 Hennepin Ave", city: "Minneapolis", state: "MN", zip: "55405", guardianName: "Christine Robinson", guardianPhone: "(612) 555-1956", guardianEmail: "crobinson@email.com", photo: "", retired: false},
    {firstName: "Henry", lastName: "Walker", familyCode: "WALKER2014", dob: "2014-01-19", grade: "5th", school: "Lyndale Elementary", street: "3411 5th Ave S", city: "Minneapolis", state: "MN", zip: "55408", guardianName: "Laura Walker", guardianPhone: "(612) 555-2067", guardianEmail: "lwalker@email.com", photo: "", retired: false},
    
    // New students - Friday
    {firstName: "Luna", lastName: "Hall", familyCode: "HALL2012", dob: "2012-06-13", grade: "7th", school: "Justice Page Middle School", street: "5045 Chicago Ave S", city: "Minneapolis", state: "MN", zip: "55417", guardianName: "Diana Hall", guardianPhone: "(612) 555-2178", guardianEmail: "dhall@email.com", photo: "", retired: false},
    {firstName: "Sebastian", lastName: "Allen", familyCode: "ALLEN2013", dob: "2013-09-26", grade: "6th", school: "Folwell Arts Magnet", street: "3611 Queen Ave N", city: "Minneapolis", state: "MN", zip: "55412", guardianName: "Katherine Allen", guardianPhone: "(612) 555-2289", guardianEmail: "kallen@email.com", photo: "", retired: false},
    {firstName: "Aria", lastName: "Young", familyCode: "YOUNG2011", dob: "2011-02-08", grade: "8th", school: "Roosevelt High School", street: "4029 28th Ave S", city: "Minneapolis", state: "MN", zip: "55406", guardianName: "Samantha Young", guardianPhone: "(612) 555-2390", guardianEmail: "syoung@email.com", photo: "", retired: false},
    {firstName: "Jack", lastName: "King", familyCode: "KING2016", dob: "2016-07-31", grade: "3rd", school: "Windom Elementary", street: "5821 Wentworth Ave S", city: "Minneapolis", state: "MN", zip: "55419", guardianName: "Rebecca King", guardianPhone: "(612) 555-2401", guardianEmail: "rking@email.com", photo: "", retired: false},
    
    // Additional students - Friday
    {firstName: "Chloe", lastName: "Wright", familyCode: "WRIGHT2010", dob: "2010-12-05", grade: "9th", school: "South High School", street: "3015 19th Ave S", city: "Minneapolis", state: "MN", zip: "55407", guardianName: "Heather Wright", guardianPhone: "(612) 555-2512", guardianEmail: "hwright@email.com", photo: "", retired: false},
    {firstName: "Daniel", lastName: "Scott", familyCode: "SCOTT2014", dob: "2014-04-18", grade: "5th", school: "Burroughs Elementary", street: "1601 50th St W", city: "Minneapolis", state: "MN", zip: "55419", guardianName: "Kimberly Scott", guardianPhone: "(612) 555-2623", guardianEmail: "kscott@email.com", photo: "", retired: false},
    {firstName: "Penelope", lastName: "Green", familyCode: "GREEN2017", dob: "2017-08-22", grade: "2nd", school: "Hale Elementary", street: "5445 Park Ave S", city: "Minneapolis", state: "MN", zip: "55417", guardianName: "Victoria Green", guardianPhone: "(612) 555-2734", guardianEmail: "vgreen@email.com", photo: "", retired: false},
    {firstName: "Owen", lastName: "Baker", familyCode: "BAKER2012", dob: "2012-10-14", grade: "7th", school: "Marcy Arts Magnet", street: "2620 Colfax Ave S", city: "Minneapolis", state: "MN", zip: "55408", guardianName: "Brittany Baker", guardianPhone: "(612) 555-2845", guardianEmail: "bbaker@email.com", photo: "", retired: false}
];

// ===== PAYMENT TRACKING =====
let payments = [
    // Emma Smith - fully paid
    {id: 1, studentKey: "Emma Smith", amount: 280, date: "2025-01-06", note: "January lessons - Check #1042", createdAt: "2025-01-06T10:00:00Z"},
    
    // Liam Jones - partial payment
    {id: 2, studentKey: "Liam Jones", amount: 110, date: "2025-01-08", note: "Venmo", createdAt: "2025-01-08T14:30:00Z"},
    
    // Olivia Davis - paid ahead
    {id: 3, studentKey: "Olivia Davis", amount: 350, date: "2025-01-02", note: "Jan + Feb prepaid - Zelle", createdAt: "2025-01-02T09:15:00Z"},
    
    // Sophia Garcia - recent payment
    {id: 4, studentKey: "Sophia Garcia", amount: 140, date: "2025-01-15", note: "Cash", createdAt: "2025-01-15T16:45:00Z"},
    
    // Benjamin Jackson - multiple payments
    {id: 5, studentKey: "Benjamin Jackson", amount: 70, date: "2025-01-03", note: "Week 1", createdAt: "2025-01-03T11:00:00Z"},
    {id: 6, studentKey: "Benjamin Jackson", amount: 70, date: "2025-01-10", note: "Week 2", createdAt: "2025-01-10T11:00:00Z"},
    
    // Chloe Wright - check payment
    {id: 7, studentKey: "Chloe Wright", amount: 210, date: "2025-01-12", note: "Check #5589", createdAt: "2025-01-12T10:30:00Z"},
    
    // Luna Hall - recent
    {id: 8, studentKey: "Luna Hall", amount: 140, date: "2025-01-20", note: "PayPal", createdAt: "2025-01-20T15:00:00Z"}
];
let nextPaymentId = 9;

// Default lesson rates by duration (in dollars)
let lessonRates = {
    30: 40,
    45: 55,
    60: 70
};

let swapRequests = [
    // A pending swap request - waiting for other student
    {id: 1, requestingStudent: "Noah Wilson", targetStudent: "Emma Smith", requestingLessonId: 2, targetLessonId: 1, status: "pending", timestamp: "2025-01-27T14:00:00Z"},
    // A student_agreed swap - both students agreed, needs teacher approval
    {id: 2, requestingStudent: "Liam Jones", targetStudent: "Sophia Garcia", requestingLessonId: 6, targetLessonId: 7, status: "student_agreed", timestamp: "2025-01-26T10:00:00Z", studentAgreedAt: "2025-01-27T09:30:00Z", agreedBy: "Sophia Garcia"},
    // An approved swap from last week
    {id: 3, requestingStudent: "Charlotte Moore", targetStudent: "Benjamin Jackson", requestingLessonId: 8, targetLessonId: 9, status: "approved", timestamp: "2025-01-20T10:00:00Z", studentAgreedAt: "2025-01-20T14:00:00Z", agreedBy: "Benjamin Jackson", resolvedAt: "2025-01-21T09:30:00Z", resolvedBy: "teacher"}
];
let nextSwapId = 4;

// Move requests - student wants to reschedule to an open time
let moveRequests = [
    // Example: pending move request
    {id: 1, studentName: "Olivia Davis", lessonId: 3, currentDay: 2, currentTime: "15:00", currentWeek: 0, newDay: 3, newTime: "16:00", newWeek: 1, duration: 45, status: "pending", timestamp: "2025-01-28T10:00:00Z"}
];
let nextMoveId = 2;
let loginMode = null;
let loggedInStudent = null;
let seenNotifications = {}; // Track which resolved swaps each student has seen
let seenRescheduleNotifications = {}; // Track which resolved reschedule requests each student has seen

let nextId = 29;
let nextSeriesId = 29;
let nextBlockId = 109;
let draggedId = null;
let draggedDuration = null;
let dragOffsetX = 0;
let dragOffsetY = 0;
let draggedWidth = 0;
let draggedHeight = 0;
let currentWeek = 0;
let tempEditData = null;
let tempNewData = null;

function isInPast(week, day) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1);
    const targetDate = new Date(startOfWeek);
    targetDate.setDate(startOfWeek.getDate() + (week * 7) + day);
    return targetDate < today;
}

// Hour-level past check: returns true if the given day+time is at or before the current hour
function isTimeInPast(week, day, time) {
    const now = new Date();
    const today = new Date(now);
    today.setHours(0, 0, 0, 0);
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1);
    const targetDate = new Date(startOfWeek);
    targetDate.setDate(startOfWeek.getDate() + (week * 7) + day);
    
    // If the day is in the past, it's definitely past
    if(targetDate < today) return true;
    // If the day is in the future, it's definitely not past
    if(targetDate > today) return false;
    // Same day: compare hours — current hour and all earlier hours are past
    const hour = parseInt(time.split(':')[0]);
    return hour <= now.getHours();
}

// Returns true if a lesson starts within 1 hour from now (too soon to swap/reschedule)
function isLessonTooSoon(week, day, time) {
    const now = new Date();
    const today = new Date(now);
    today.setHours(0, 0, 0, 0);
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1);
    const targetDate = new Date(startOfWeek);
    targetDate.setDate(startOfWeek.getDate() + (week * 7) + day);
    
    // Set the lesson time on the target date
    const parts = time.split(':');
    targetDate.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0);
    
    // Lesson is too soon if it starts within 60 minutes from now
    const diffMs = targetDate.getTime() - now.getTime();
    return diffMs < 60 * 60 * 1000;
}

function getActualDate(week, day) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1);
    const targetDate = new Date(startOfWeek);
    targetDate.setDate(startOfWeek.getDate() + (week * 7) + day);
    return targetDate;
}

function formatLessonDate(week, day) {
    const date = getActualDate(week, day);
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return dayNames[date.getDay()] + ', ' + monthNames[date.getMonth()] + ' ' + date.getDate();
}

function formatNamePrivate(firstName, lastName) {
    return firstName + ' ' + lastName.charAt(0) + '.';
}

const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
const allTimes = ["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"];
const detailedTimes = ["08:00","08:15","08:30","08:45","09:00","09:15","09:30","09:45","10:00","10:15","10:30","10:45","11:00","11:15","11:30","11:45","12:00","12:15","12:30","12:45","13:00","13:15","13:30","13:45","14:00","14:15","14:30","14:45","15:00","15:15","15:30","15:45","16:00","16:15","16:30","16:45","17:00","17:15","17:30","17:45","18:00","18:15","18:30","18:45","19:00","19:15","19:30","19:45","20:00"];

function initializeRecurringLessons() {
    const baseRecurring = lessons.filter(l => l.isRecurring && l.week === 0);
    const newLessons = [];
    for(let week = -2; week <= 4; week++) {
        if(week === 0) continue;
        baseRecurring.forEach(baseLesson => {
            newLessons.push({
                id: nextId++,
                firstName: baseLesson.firstName,
                lastName: baseLesson.lastName,
                day: baseLesson.day,
                time: baseLesson.time,
                duration: baseLesson.duration,
                isRecurring: true,
                seriesId: baseLesson.seriesId,
                week: week
            });
        });
    }
    lessons.push(...newLessons);
}

function initializeRecurringBlocks() {
    const baseBlocks = blockedTimes.filter(b => b.week === 0);
    const newBlocks = [];
    for(let week = -2; week <= 52; week++) {
        if(week === 0) continue;
        baseBlocks.forEach(baseBlock => {
            newBlocks.push({
                id: nextBlockId++,
                day: baseBlock.day,
                time: baseBlock.time,
                duration: baseBlock.duration,
                reason: baseBlock.reason,
                week: week
            });
        });
    }
    blockedTimes.push(...newBlocks);
}

// Load saved data on startup
const hadSavedData = loadData();
if(!hadSavedData) {
    initializeRecurringLessons();
    initializeRecurringBlocks();
}
// Update theme icon on load
updateThemeIcon();

function loginAsTeacher() {
    loginMode = 'teacher';
    loggedInStudent = null;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('teacherDashboard').style.display = 'block';
    updateDashboardStats();
    toast("Logged in as Teacher");
}

function updateDashboardStats() {
    // Today's lessons
    const now = new Date();
    const todayDayIndex = (now.getDay() + 6) % 7; // Convert Sun=0 to Mon=0
    const todayLessons = lessons.filter(l => l.week === 0 && l.day === todayDayIndex);
    const todayEl = document.getElementById('dashTodayLessons');
    if(todayEl) {
        todayEl.textContent = todayLessons.length + " lesson" + (todayLessons.length !== 1 ? "s" : "") + " today";
    }
    
    // Active students
    const activeStudents = studentProfiles.filter(s => !s.retired);
    const studentEl = document.getElementById('dashStudentCount');
    if(studentEl) {
        studentEl.textContent = activeStudents.length + " active student" + (activeStudents.length !== 1 ? "s" : "");
    }
    
    // Payment info - outstanding balances
    const studentsWithBalance = studentProfiles.filter(s => {
        if(s.retired) return false;
        const studentLessons = lessons.filter(l => l.firstName === s.firstName && l.lastName === s.lastName);
        const studentPayments = (typeof payments !== 'undefined') ? payments.filter(p => p.studentName === s.firstName + " " + s.lastName) : [];
        const totalOwed = studentLessons.reduce((sum, l) => {
            const rate = lessonRates[l.duration] || 0;
            return sum + rate;
        }, 0);
        const totalPaid = studentPayments.reduce((sum, p) => sum + p.amount, 0);
        return (totalOwed - totalPaid) > 0;
    });
    const paymentEl = document.getElementById('dashPaymentStat');
    if(paymentEl) {
        if(studentsWithBalance.length > 0) {
            paymentEl.innerHTML = '<span class="stat-alert">' + studentsWithBalance.length + ' outstanding balance' + (studentsWithBalance.length !== 1 ? 's' : '') + '</span>';
        } else {
            paymentEl.textContent = 'All accounts current';
        }
    }
    
    // Swap requests
    const pendingSwaps = swapRequests.filter(r => r.status === 'pending' || r.status === 'student_agreed');
    const needsApproval = swapRequests.filter(r => r.status === 'student_agreed');
    const swapEl = document.getElementById('dashSwapCount');
    if(swapEl) {
        if(needsApproval.length > 0) {
            swapEl.innerHTML = '<span class="stat-alert">' + needsApproval.length + ' ready to approve</span>';
        } else if(pendingSwaps.length > 0) {
            swapEl.textContent = pendingSwaps.length + ' pending';
        } else {
            swapEl.textContent = 'No pending requests';
        }
    }
    
    // Reschedule requests
    const pendingMoves = moveRequests.filter(r => r.status === 'pending');
    const rescheduleEl = document.getElementById('dashRescheduleCount');
    if(rescheduleEl) {
        if(pendingMoves.length > 0) {
            rescheduleEl.innerHTML = '<span class="stat-alert">' + pendingMoves.length + ' awaiting response</span>';
        } else {
            rescheduleEl.textContent = 'No pending requests';
        }
    }
    
    // Block time stat
    const thisWeekBlocks = blockedTimes.filter(b => b.week === 0).length;
    const blockEl = document.getElementById('dashBlockStat');
    if(blockEl) {
        blockEl.textContent = thisWeekBlocks + ' block' + (thisWeekBlocks !== 1 ? 's' : '') + ' this week';
    }
}

function goToCalendar() {
    _returnToDashboard = false;
    document.body.classList.remove('student-mode');
    document.body.classList.add('teacher-mode');
    document.getElementById('teacherDashboard').style.display = 'none';
    document.getElementById('mainApp').classList.add('active');
    document.getElementById('teacherControls').classList.remove('hidden');
    document.getElementById('studentControls').classList.add('hidden');
    document.getElementById('dashboardBtn').style.display = '';
    document.getElementById('fab').classList.remove('hidden');
    document.getElementById('loginStatus').innerHTML = '👨‍🏫 Teacher Mode';
    render();
}

function goToDashboard() {
    document.getElementById('mainApp').classList.remove('active');
    document.getElementById('teacherDashboard').style.display = 'block';
    document.getElementById('fab').classList.add('hidden');
    updateDashboardStats();
}

function loginAsStudent() {
    const familyCode = document.getElementById('familyCodeInput').value.trim().toUpperCase();
    if(!familyCode) {
        toast("Please enter a family code");
        return;
    }
    const student = studentProfiles.find(p => p.familyCode === familyCode);
    if(!student) {
        toast("Invalid family code. Please try again.");
        return;
    }
    loginMode = 'student';
    loggedInStudent = {
        firstName: student.firstName,
        lastName: student.lastName,
        familyCode: student.familyCode
    };
    document.body.classList.remove('teacher-mode');
    document.body.classList.add('student-mode');
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').classList.add('active');
    document.getElementById('teacherControls').classList.add('hidden');
    document.getElementById('studentControls').classList.remove('hidden');
    document.getElementById('dashboardBtn').style.display = 'none';
    document.getElementById('fab').classList.add('hidden');
    document.getElementById('loginStatus').innerHTML = '🎓 ' + student.firstName + ' ' + student.lastName;
    render();
    toast("Welcome, " + student.firstName + "!");
    
    // Check for swap request notifications
    setTimeout(() => checkSwapNotifications(), 500);
    
    // Check for reschedule notifications
    setTimeout(() => checkRescheduleNotifications(), 600);
}

function checkSwapNotifications() {
    if(!loggedInStudent) return;
    
    const fullName = loggedInStudent.firstName + " " + loggedInStudent.lastName;
    
    // Initialize seen notifications for this student if needed
    if(!seenNotifications[fullName]) {
        seenNotifications[fullName] = [];
    }
    
    // Find resolved swap requests involving this student that they haven't seen
    const unreadNotifications = swapRequests.filter(r => 
        (r.status === 'approved' || r.status === 'declined') &&
        (r.requestingStudent === fullName || r.targetStudent === fullName) &&
        !seenNotifications[fullName].includes(r.id)
    );
    
    if(unreadNotifications.length > 0) {
        showSwapNotifications(unreadNotifications, fullName);
    }
}

function showSwapNotifications(notifications, fullName) {
    let html = "<h3 class='modal-title'>🔔 Swap Request Updates</h3>" +
        "<p class='modal-subtitle'>Updates since your last login</p>";
    
    // Collect lesson IDs to flash for approved swaps
    const flashLessonIds = [];
    let flashWeek = null;
    
    notifications.forEach(request => {
        const isRequester = request.requestingStudent === fullName;
        const otherStudent = isRequester ? request.targetStudent : request.requestingStudent;
        const otherNamePrivate = formatNamePrivate(otherStudent.split(' ')[0], otherStudent.split(' ')[1]);
        
        const myLessonId = isRequester ? request.requestingLessonId : request.targetLessonId;
        const myLesson = lessons.find(l => l.id === myLessonId);
        
        if(request.status === 'approved') {
            // Get old and new times for this student
            const oldDay = isRequester ? request.oldRequestingDay : request.oldTargetDay;
            const oldTime = isRequester ? request.oldRequestingTime : request.oldTargetTime;
            const newDay = isRequester ? request.newRequestingDay : request.newTargetDay;
            const newTime = isRequester ? request.newRequestingTime : request.newTargetTime;
            const newWeek = isRequester ? request.newRequestingWeek : request.newTargetWeek;
            
            html += "<div class='info-box info-box-success' style='margin-bottom: 1rem;'>" +
                "<div style='font-weight: 700; margin-bottom: 0.5rem;'>✅ Swap Approved!</div>";
            
            if(isRequester) {
                html += "<p style='font-size: 0.875rem;'>Your swap request with <strong>" + otherNamePrivate + "</strong> was approved by your teacher!</p>";
            } else {
                html += "<p style='font-size: 0.875rem;'>The swap with <strong>" + otherNamePrivate + "</strong> was approved by your teacher!</p>";
            }
            
            // Show old → new time
            if(oldDay !== undefined && newDay !== undefined) {
                html += "<div style='margin-top: 0.75rem; padding: 0.75rem; background: rgba(255,255,255,0.15); border-radius: 10px;'>" +
                    "<div style='display: flex; align-items: center; gap: 0.75rem;'>" +
                    "<div style='flex: 1; text-align: center;'>" +
                    "<div style='font-size: 0.7rem; font-weight: 600; opacity: 0.7; margin-bottom: 0.2rem;'>OLD TIME</div>" +
                    "<div style='font-size: 0.85rem; text-decoration: line-through; opacity: 0.6;'>" + days[oldDay] + " " + oldTime + "</div>" +
                    "</div>" +
                    "<div style='font-size: 1.2rem;'>→</div>" +
                    "<div style='flex: 1; text-align: center;'>" +
                    "<div style='font-size: 0.7rem; font-weight: 600; opacity: 0.7; margin-bottom: 0.2rem;'>NEW TIME</div>" +
                    "<div style='font-size: 1rem; font-weight: 700;'>" + days[newDay] + " " + newTime + "</div>" +
                    "</div>" +
                    "</div>" +
                    "</div>";
            } else if(myLesson) {
                // Fallback to current lesson position
                html += "<p style='font-size: 0.85rem; margin-top: 0.5rem;'>" +
                    "Your new time: <strong>" + days[myLesson.day] + " at " + myLesson.time + "</strong>" +
                    "</p>";
            }
            
            html += "</div>";
            
            // Queue this lesson for flashing
            if(myLessonId) {
                flashLessonIds.push(myLessonId);
                if(newWeek !== undefined) flashWeek = newWeek;
                else if(myLesson) flashWeek = myLesson.week;
            }
        } else if(request.status === 'declined') {
            html += "<div class='info-box info-box-danger' style='margin-bottom: 1rem;'>" +
                "<div style='font-weight: 700; margin-bottom: 0.5rem;'>❌ Swap Declined</div>";
            
            if(isRequester) {
                html += "<p style='font-size: 0.875rem;'>Your swap request with <strong>" + otherNamePrivate + "</strong> was declined.</p>" +
                    "<p style='font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.9;'>Your lesson remains at its original time.</p>";
                
                if(request.declineReason) {
                    html += "<div style='margin-top: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.15); border-radius: 8px;'>" +
                        "<div style='font-size: 0.7rem; font-weight: 600; margin-bottom: 0.15rem;'>💬 Reason</div>" +
                        "<div style='font-size: 0.8rem;'>" + request.declineReason + "</div>" +
                        "</div>";
                }
            } else {
                html += "<p style='font-size: 0.875rem;'>You declined a swap request from <strong>" + otherNamePrivate + "</strong>.</p>";
            }
            
            html += "</div>";
        }
        
        // Mark as seen
        seenNotifications[fullName].push(request.id);
    });
    
    // Save the seen status
    saveData();
    
    // Build the close button — if there are approved swaps, flash on close
    if(flashLessonIds.length > 0) {
        // Store flash data globally so the close handler can use it
        window._pendingSwapFlash = { lessonIds: flashLessonIds, week: flashWeek };
        html += "<button onclick='closeModalAndFlashSwap()' class='modal-btn modal-btn-primary'>See My New Time</button>";
    } else {
        html += "<button onclick='closeModal()' class='modal-btn modal-btn-primary'>Got It</button>";
    }
    
    modal(html);
}

function closeModalAndFlashSwap() {
    const flashData = window._pendingSwapFlash;
    window._pendingSwapFlash = null;
    
    closeModal();
    
    if(!flashData) return;
    
    // Navigate to the correct week if needed
    if(flashData.week !== null && flashData.week !== undefined && flashData.week !== currentWeek) {
        currentWeek = flashData.week;
        render();
    }
    
    // Flash the lesson slots after a short delay to let the calendar render
    setTimeout(() => {
        flashData.lessonIds.forEach(lessonId => {
            const el = document.querySelector('.lesson-slot[data-id="' + lessonId + '"]');
            if(el) {
                // Scroll the slot into view
                el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                
                // Add flash class after scroll completes
                setTimeout(() => {
                    el.classList.add('swap-flash');
                    // Remove class after animation ends
                    el.addEventListener('animationend', () => {
                        el.classList.remove('swap-flash');
                    }, { once: true });
                }, 400);
            }
        });
    }, 150);
}

function checkRescheduleNotifications() {
    if(!loggedInStudent) return;
    
    const fullName = loggedInStudent.firstName + " " + loggedInStudent.lastName;
    
    // Initialize seen notifications for this student if needed
    if(!seenRescheduleNotifications[fullName]) {
        seenRescheduleNotifications[fullName] = [];
    }
    
    // Find resolved reschedule requests for this student that they haven't seen
    const unreadNotifications = moveRequests.filter(r => 
        (r.status === 'approved' || r.status === 'declined') &&
        r.studentName === fullName &&
        !seenRescheduleNotifications[fullName].includes(r.id)
    );
    
    if(unreadNotifications.length > 0) {
        showRescheduleNotifications(unreadNotifications, fullName);
    }
}

function showRescheduleNotifications(notifications, fullName) {
    let html = "<h3 class='modal-title'>🔔 Reschedule Updates</h3>" +
        "<p class='modal-subtitle'>Updates on your reschedule requests</p>";
    
    notifications.forEach(request => {
        const lesson = lessons.find(l => l.id === request.lessonId);
        
        if(request.status === 'approved') {
            html += "<div class='info-box info-box-success' style='margin-bottom: 1rem;'>" +
                "<div style='font-weight: 700; margin-bottom: 0.5rem;'>✅ Reschedule Approved!</div>";
            
            html += "<p style='font-size: 0.875rem;'>Your reschedule request was approved by your teacher.</p>";
            
            if(request.newDay !== null && request.newTime) {
                const newDate = getDateForLesson({day: request.newDay, week: request.newWeek});
                html += "<p style='font-size: 0.85rem; margin-top: 0.5rem;'>" +
                    "<span style='color: var(--stone-500);'>From:</span> " + days[request.currentDay] + " at " + request.currentTime + "<br>" +
                    "<span style='color: var(--teal-700); font-weight: 600;'>New time:</span> <strong>" + days[request.newDay] + " at " + request.newTime + "</strong> (" + newDate + ")" +
                    "</p>";
            }
            
            html += "</div>";
        } else if(request.status === 'declined') {
            html += "<div class='info-box info-box-danger' style='margin-bottom: 1rem;'>" +
                "<div style='font-weight: 700; margin-bottom: 0.5rem;'>❌ Reschedule Declined</div>";
            
            html += "<p style='font-size: 0.875rem;'>Your request to reschedule <strong>" + days[request.currentDay] + " at " + request.currentTime + "</strong> was declined.</p>" +
                "<p style='font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.9;'>Your lesson remains at its original time. Contact your teacher if you have questions.</p>";
            
            html += "</div>";
        }
        
        // Mark as seen
        seenRescheduleNotifications[fullName].push(request.id);
    });
    
    // Save the seen status
    saveData();
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-primary'>Got It</button>";
    
    modal(html);
}

// ===== PUBLIC WEBSITE NAVIGATION =====

function openStudentPortal() {
    document.getElementById('publicWebsite').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
}

function backToWebsite() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('publicWebsite').style.display = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function smoothScroll(e, id) {
    e.preventDefault();
    const el = document.getElementById(id);
    if(el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function logout() {
    loginMode = null;
    loggedInStudent = null;
    document.body.classList.remove('teacher-mode', 'student-mode');
    document.getElementById('mainApp').classList.remove('active');
    document.getElementById('teacherDashboard').style.display = 'none';
    document.getElementById('fab').classList.add('hidden');
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('publicWebsite').style.display = '';
    document.getElementById('familyCodeInput').value = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    toast("Logged out successfully");
}

function render() {
    const weekLessons = lessons.filter(l => l.week === currentWeek);
    const times = allTimes;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (currentWeek * 7));
    
    let html = "<table class='calendar-table'><thead><tr><th>Time</th>";
    days.forEach((d, i) => {
        const dayDate = new Date(startOfWeek);
        dayDate.setDate(startOfWeek.getDate() + i);
        const monthDay = (dayDate.getMonth() + 1) + '/' + dayDate.getDate();
        const year = dayDate.getFullYear();
        const isToday = dayDate.getTime() === today.getTime();
        const isPast = dayDate < today;
        
        let headerClass = isToday ? 'today-header' : (isPast ? 'past-header' : '');
        html += "<th class='" + headerClass + "'>" +
                "<div class='day-name'>" + d + "</div>" +
                "<div class='day-date'>" + monthDay + "/" + year + "</div>" +
                "</th>";
    });
    html += "</tr></thead><tbody>";
    
    // Save data after render (debounced)
    clearTimeout(window.saveTimeout);
    window.saveTimeout = setTimeout(saveData, 500);
    
    times.forEach(time => {
        const hour = time.split(':')[0];
        html += "<tr><td>" + time + "</td>";
        
        for(let d = 0; d < 7; d++) {
            const cellDate = new Date(startOfWeek);
            cellDate.setDate(startOfWeek.getDate() + d);
            const isPastCell = isTimeInPast(currentWeek, d, time);
            
            const dayLessons = weekLessons.filter(l => l.day === d && l.time.startsWith(hour));
            const cellClass = isPastCell ? 'drop-zone past-day' : 'drop-zone';
            
            // Check if today's column and current hour for time indicator
            const isCurrentDayCell = currentWeek === 0 && d === (new Date().getDay() - 1);
            const nowHour = new Date().getHours();
            const nowMinutes = new Date().getMinutes();
            const cellHour = parseInt(hour);
            
            html += "<td class='" + cellClass + "' data-day='" + d + "' data-time='" + time + "' ";
            
            if(loginMode === 'teacher') {
                html += "ondrop='drop(event)' ondragover='dragover(event)' ondragleave='dragleave(event)' ";
                html += "onclick='handleCellClick(" + d + ", \"" + time + "\")'>";
            } else {
                html += ">";
            }
            
            // Find blocks that cover this hour (start in this hour OR span into this hour)
            const hourInt = parseInt(hour);
            
            // Current time indicator line
            if(isCurrentDayCell && cellHour === nowHour) {
                const indicatorTop = (nowMinutes / 60) * 80;
                html += "<div class='time-indicator' style='top:" + indicatorTop + "px;'><div class='time-indicator-dot'></div></div>";
            }
            const relevantBlocks = blockedTimes.filter(b => {
                if(b.week !== currentWeek || b.day !== d) return false;
                const blockStartHour = parseInt(b.time.split(':')[0]);
                const blockStartMinutes = parseInt(b.time.split(':')[1]);
                const blockEndMinutes = blockStartHour * 60 + blockStartMinutes + b.duration;
                const blockEndHour = Math.floor(blockEndMinutes / 60);
                const cellStartMinutes = hourInt * 60;
                const cellEndMinutes = (hourInt + 1) * 60;
                // Block overlaps this cell if it starts before cell ends and ends after cell starts
                return (blockStartHour * 60 + blockStartMinutes) < cellEndMinutes && blockEndMinutes > cellStartMinutes;
            });
            
            relevantBlocks.forEach(block => {
                const blockStartHour = parseInt(block.time.split(':')[0]);
                const blockStartMinutes = parseInt(block.time.split(':')[1]);
                const blockTotalStartMinutes = blockStartHour * 60 + blockStartMinutes;
                const blockTotalEndMinutes = blockTotalStartMinutes + block.duration;
                
                const cellStartMinutes = hourInt * 60;
                const cellEndMinutes = (hourInt + 1) * 60;
                
                // Calculate where the block appears within this cell
                const visibleStartMinutes = Math.max(blockTotalStartMinutes, cellStartMinutes);
                const visibleEndMinutes = Math.min(blockTotalEndMinutes, cellEndMinutes);
                
                const topOffset = visibleStartMinutes - cellStartMinutes;
                const visibleDuration = visibleEndMinutes - visibleStartMinutes;
                
                const topPosition = (topOffset / 60) * 80;
                const blockHeight = (visibleDuration / 60) * 80;
                
                const blockCursorStyle = (loginMode === 'student') ? "cursor: default; pointer-events: none;" : "cursor: pointer;";
                
                // Determine if this is a continuation segment (for border styling)
                const startsInThisCell = blockTotalStartMinutes >= cellStartMinutes && blockTotalStartMinutes < cellEndMinutes;
                const endsInThisCell = blockTotalEndMinutes > cellStartMinutes && blockTotalEndMinutes <= cellEndMinutes;
                
                let borderRadius = "0";
                let borderStyle = "border: 1px solid var(--stone-400);";
                
                if(startsInThisCell && endsInThisCell) {
                    borderRadius = "8px";
                } else if(startsInThisCell) {
                    borderRadius = "8px 8px 0 0";
                    borderStyle = "border: 1px solid var(--stone-400); border-bottom: none;";
                } else if(endsInThisCell) {
                    borderRadius = "0 0 8px 8px";
                    borderStyle = "border: 1px solid var(--stone-400); border-top: none;";
                } else {
                    // Middle segment
                    borderStyle = "border-left: 1px solid var(--stone-400); border-right: 1px solid var(--stone-400); border-top: none; border-bottom: none;";
                }
                
                // For students: show no text at all (just black box)
                // For teachers: only show reason label in the first cell where block starts
                let displayReason = '';
                if(loginMode !== 'student' && startsInThisCell) {
                    displayReason = (block.reason === 'Closed' || block.reason === 'Weekend') ? '' : '🚫 ' + block.reason;
                }
                
                // Build the onclick handler for teachers
                let onclickAttr = '';
                if(loginMode !== 'student') {
                    onclickAttr = ' onclick="event.stopPropagation(); showBlockDetails(' + block.id + ')"';
                }
                
                html += '<div class="blocked-slot" style="top:' + topPosition + 'px; height:' + blockHeight + 'px; border-radius:' + borderRadius + '; ' + borderStyle + ' ' + blockCursorStyle + '"' + onclickAttr + '>';
                html += displayReason;
                html += '</div>';
            });
            
            dayLessons.forEach((lesson, index) => {
                const name = lesson.firstName + " " + lesson.lastName.charAt(0) + ".";
                const isPastLesson = isTimeInPast(lesson.week, lesson.day, lesson.time);
                let heightClass = lesson.duration === 30 ? 'lesson-30' : lesson.duration === 45 ? 'lesson-45' : 'lesson-60';
                
                const timeParts = lesson.time.split(':');
                const minutes = parseInt(timeParts[1]);
                const snappedMinutes = Math.round(minutes / 15) * 15;
                const topPosition = (snappedMinutes / 60) * 80;
                
                let column = 0;
                let totalColumns = 1;
                
                const allDayLessons = weekLessons.filter(l => l.day === d && l.week === currentWeek);
                const lessonStartMinutes = timeToMinutes(lesson.time);
                const lessonEndMinutes = lessonStartMinutes + lesson.duration;
                
                const overlapping = allDayLessons.filter((other) => {
                    if(other.id === lesson.id) return false;
                    const otherStartMinutes = timeToMinutes(other.time);
                    const otherEndMinutes = otherStartMinutes + other.duration;
                    return (lessonStartMinutes < otherEndMinutes && lessonEndMinutes > otherStartMinutes);
                });
                
                if(overlapping.length > 0) {
                    totalColumns = overlapping.length + 1;
                    const allLessons = [lesson, ...overlapping].sort((a, b) => {
                        const timeCompare = a.time.localeCompare(b.time);
                        if(timeCompare !== 0) return timeCompare;
                        return a.id - b.id;
                    });
                    column = allLessons.findIndex(l => l.id === lesson.id);
                }
                
                const width = totalColumns > 1 ? (100 / totalColumns) : 100;
                const leftPosition = totalColumns > 1 ? (column * width) : 0;
                
                let colorClass = totalColumns > 1 ? ' lesson-overlap-' + (column % 6) : ' lesson-overlap-0';
                
                if(loginMode === 'student' && loggedInStudent) {
                    if(lesson.firstName === loggedInStudent.firstName && lesson.lastName === loggedInStudent.lastName) {
                        colorClass = ' my-lesson';
                    } else {
                        // All other students' lessons get the same color
                        colorClass = ' lesson-overlap-0';
                    }
                }
                
                const draggableAttr = (isPastLesson || loginMode === 'student') ? "draggable='false'" : "draggable='true' ondragstart='dragstart(event)' ondragend='dragend(event)'";
                
                const isMyLesson = loginMode === 'student' && loggedInStudent && 
                    lesson.firstName === loggedInStudent.firstName && lesson.lastName === loggedInStudent.lastName;
                
                let cursorStyle, clickableAttr;
                if(loginMode === 'student') {
                    if(isMyLesson && !isPastLesson) {
                        cursorStyle = "cursor: pointer;";
                        clickableAttr = "onclick='showDetails(" + lesson.id + ")'";
                    } else {
                        cursorStyle = "cursor: default; pointer-events: none;";
                        clickableAttr = "";
                    }
                } else {
                    cursorStyle = isPastLesson ? "cursor: default;" : "cursor: pointer;";
                    clickableAttr = "onclick='showDetails(" + lesson.id + ")'";
                }
                
                html += "<div class='lesson-slot " + heightClass + colorClass + "' style='top:" + topPosition + "px; left:" + leftPosition + "%; width:" + width + "%; " + cursorStyle + "' " + draggableAttr + " data-id='" + lesson.id + "' " + clickableAttr + ">";
                html += "<div class='student-name'>" + name + " " + lesson.duration + " min</div>";
                html += "</div>";
            });
            
            html += "</td>";
        }
        html += "</tr>";
    });
    html += "</tbody></table>";
    document.getElementById("calendar").innerHTML = html;
    
    updateWeekLabel();
    updateMySwapBadge();
    updateTeacherSwapBadge();
    updateTeacherMoveBadge();
    updateMiniCalendar();
    setTimeout(scrollToCurrentTime, 0);
}

// Live time indicator - update every 60 seconds
let _timeIndicatorInterval = null;
function startTimeIndicator() {
    if(_timeIndicatorInterval) clearInterval(_timeIndicatorInterval);
    _timeIndicatorInterval = setInterval(function() {
        // Only update indicator position without full re-render
        document.querySelectorAll('.time-indicator').forEach(el => el.remove());
        if(currentWeek !== 0) return;
        
        const now = new Date();
        const todayCol = now.getDay() - 1; // 0=Mon
        if(todayCol < 0 || todayCol > 6) return;
        
        const nowHour = now.getHours();
        const nowMinutes = now.getMinutes();
        
        const cells = document.querySelectorAll('td[data-day="' + todayCol + '"][data-time="' + nowHour.toString().padStart(2, '0') + ':00"]');
        cells.forEach(cell => {
            const indicatorTop = (nowMinutes / 60) * 80;
            const indicator = document.createElement('div');
            indicator.className = 'time-indicator';
            indicator.style.top = indicatorTop + 'px';
            indicator.innerHTML = '<div class="time-indicator-dot"></div>';
            cell.appendChild(indicator);
        });
    }, 60000);
}

function scrollToCurrentTime() {
    const calendarWrapper = document.querySelector('.calendar-wrapper');
    if(!calendarWrapper) return;
    
    // If viewing current week, scroll to current time
    if(currentWeek === 0) {
        const now = new Date();
        const currentHour = now.getHours();
        // Scroll so current time is about 1/3 from the top
        const scrollPosition = Math.max(0, (currentHour - 1) * 82);
        calendarWrapper.scrollTop = scrollPosition;
    } else {
        // Default to 8am for other weeks
        calendarWrapper.scrollTop = 8 * 82;
    }
    
    startTimeIndicator();
}

function changeWeek(direction) {
    currentWeek += direction;
    render();
}

function updateWeekLabel() {
    const label = document.getElementById('weekLabel');
    const label2 = document.getElementById('weekLabel2');
    let text = 'Today';
    if(currentWeek === 1) text = 'Next Week';
    else if(currentWeek === -1) text = 'Last Week';
    else if(currentWeek > 0) text = currentWeek + ' Weeks Ahead';
    else if(currentWeek < 0) text = Math.abs(currentWeek) + ' Weeks Ago';
    
    if(label) label.textContent = text;
    if(label2) label2.textContent = text;
}

function updateMySwapBadge() {
    if(loginMode !== 'student' || !loggedInStudent) return;
    
    const fullName = loggedInStudent.firstName + " " + loggedInStudent.lastName;
    const pendingCount = swapRequests.filter(r => 
        r.status === 'pending' && 
        (r.requestingStudent === fullName || r.targetStudent === fullName)
    ).length;
    
    const badge = document.getElementById('mySwapBadge');
    if(!badge) return;
    
    if(pendingCount > 0) {
        badge.textContent = pendingCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

function updateTeacherSwapBadge() {
    if(loginMode !== 'teacher') return;
    
    const pendingCount = swapRequests.filter(r => r.status === 'pending' || r.status === 'student_agreed').length;
    const btn = document.getElementById('teacherSwapBtn');
    if(!btn) return;
    
    // Remove existing badge if any
    const existingBadge = btn.querySelector('.badge');
    if(existingBadge) existingBadge.remove();
    
    if(pendingCount > 0) {
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = pendingCount;
        // Make badge more prominent if there are student_agreed requests needing approval
        const needsApproval = swapRequests.filter(r => r.status === 'student_agreed').length;
        if(needsApproval > 0) {
            badge.style.background = 'var(--teal-600)';
        }
        btn.appendChild(badge);
    }
}

function updateTeacherMoveBadge() {
    if(loginMode !== 'teacher') return;
    
    const pendingCount = moveRequests.filter(r => r.status === 'pending').length;
    const btn = document.getElementById('teacherMoveBtn');
    if(!btn) return;
    
    // Remove existing badge if any
    const existingBadge = btn.querySelector('.badge');
    if(existingBadge) existingBadge.remove();
    
    if(pendingCount > 0) {
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = pendingCount;
        btn.appendChild(badge);
    }
}

function showTeacherSwapRequests() {
    const pending = swapRequests.filter(r => r.status === 'pending');
    const studentAgreed = swapRequests.filter(r => r.status === 'student_agreed');
    const approved = swapRequests.filter(r => r.status === 'approved');
    const declined = swapRequests.filter(r => r.status === 'declined');
    
    let html = "<h3 class='modal-title'>🔄 Swap Requests</h3>" +
        "<p class='modal-subtitle'>View and manage student swap requests</p>";
    
    // Summary stats
    html += "<div style='display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;'>" +
        "<div style='flex: 1; min-width: 70px; text-align: center; padding: 0.75rem; background: var(--teal-100); border-radius: 10px;'>" +
        "<div style='font-size: 1.5rem; font-weight: 700; color: var(--teal-700);'>" + studentAgreed.length + "</div>" +
        "<div style='font-size: 0.7rem; color: var(--teal-600);'>Needs Approval</div>" +
        "</div>" +
        "<div style='flex: 1; min-width: 70px; text-align: center; padding: 0.75rem; background: var(--amber-100); border-radius: 10px;'>" +
        "<div style='font-size: 1.5rem; font-weight: 700; color: var(--amber-700);'>" + pending.length + "</div>" +
        "<div style='font-size: 0.7rem; color: var(--amber-600);'>Pending Student</div>" +
        "</div>" +
        "<div style='flex: 1; min-width: 70px; text-align: center; padding: 0.75rem; background: var(--emerald-500); border-radius: 10px; opacity: 0.8;'>" +
        "<div style='font-size: 1.5rem; font-weight: 700; color: white;'>" + approved.length + "</div>" +
        "<div style='font-size: 0.7rem; color: white;'>Completed</div>" +
        "</div>" +
        "<div style='flex: 1; min-width: 70px; text-align: center; padding: 0.75rem; background: var(--rose-500); border-radius: 10px; opacity: 0.8;'>" +
        "<div style='font-size: 1.5rem; font-weight: 700; color: white;'>" + declined.length + "</div>" +
        "<div style='font-size: 0.7rem; color: white;'>Declined</div>" +
        "</div>" +
        "</div>";
    
    if(swapRequests.length === 0) {
        html += "<div class='info-box info-box-info'>No swap requests yet. Students can request swaps from their portal.</div>";
    } else {
        html += "<div class='scroll-container' style='max-height: 400px;'>";
        
        // Student agreed - needs teacher approval (highest priority)
        if(studentAgreed.length > 0) {
            html += "<div class='section-title' style='color: var(--teal-600);'>✋ Needs Your Approval</div>";
            html += "<p style='font-size: 0.8rem; color: var(--stone-500); margin-bottom: 0.75rem;'>Both students have agreed. Approve to complete the swap.</p>";
            studentAgreed.forEach(request => {
                html += renderSwapRequestCard(request, true);
            });
        }
        
        // Pending requests - waiting for other student
        if(pending.length > 0) {
            html += "<div class='section-title' style='margin-top: 1rem; color: var(--amber-600);'>⏳ Awaiting Student Response</div>";
            html += "<p style='font-size: 0.8rem; color: var(--stone-500); margin-bottom: 0.75rem;'>Waiting for the other student to accept or decline.</p>";
            pending.forEach(request => {
                html += renderSwapRequestCard(request, true);
            });
        }
        
        // Accepted requests
        if(approved.length > 0) {
            html += "<div class='section-title' style='margin-top: 1rem; color: var(--emerald-600);'>✅ Completed</div>";
            approved.forEach(request => {
                html += renderSwapRequestCard(request, false);
            });
        }
        
        // Declined requests
        if(declined.length > 0) {
            html += "<div class='section-title' style='margin-top: 1rem; color: var(--rose-600);'>❌ Declined</div>";
            declined.forEach(request => {
                html += renderSwapRequestCard(request, false);
            });
        }
        
        html += "</div>";
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Close</button>";
    
    modal(html);
}

function renderSwapRequestCard(request, showActions) {
    const lesson1 = lessons.find(l => l.id === request.requestingLessonId);
    const lesson2 = lessons.find(l => l.id === request.targetLessonId);
    
    let statusClass = '';
    let statusIcon = '';
    let statusLabel = '';
    if(request.status === 'student_agreed') {
        statusClass = 'info-box-info';
        statusIcon = '✋';
        statusLabel = 'Students Agreed';
    } else if(request.status === 'pending') {
        statusClass = 'info-box-warning';
        statusIcon = '⏳';
        statusLabel = 'Pending';
    } else if(request.status === 'approved') {
        statusClass = 'info-box-success';
        statusIcon = '✅';
        statusLabel = 'Completed';
    } else {
        statusClass = 'info-box-danger';
        statusIcon = '❌';
        statusLabel = 'Declined';
    }
    
    let html = "<div class='info-box " + statusClass + "' style='margin-bottom: 0.75rem; padding: 1rem;'>";
    
    // Header with timestamp
    const requestDate = new Date(request.timestamp);
    html += "<div style='display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;'>" +
        "<span style='font-weight: 700;'>" + statusIcon + " " + statusLabel + "</span>" +
        "<span style='font-size: 0.7rem; opacity: 0.7;'>Requested " + requestDate.toLocaleDateString() + "</span>" +
        "</div>";
    
    // Requester info
    html += "<div style='font-size: 0.875rem; margin-bottom: 0.5rem;'>" +
        "<strong>" + request.requestingStudent + "</strong> wants:";
    
    if(lesson1) {
        html += "<div style='margin-left: 1rem; font-size: 0.8rem; color: var(--stone-600);'>" +
            days[lesson1.day] + " at " + lesson1.time + " (" + lesson1.duration + " min)" +
            "</div>";
    }
    
    html += "</div>";
    
    // Arrow
    html += "<div style='text-align: center; color: var(--stone-400); font-size: 1rem;'>⬍</div>";
    
    // Target info
    html += "<div style='font-size: 0.875rem; margin-top: 0.5rem;'>" +
        "<strong>" + request.targetStudent + "</strong>'s time:";
    
    if(lesson2) {
        html += "<div style='margin-left: 1rem; font-size: 0.8rem; color: var(--stone-600);'>" +
            days[lesson2.day] + " at " + lesson2.time + " (" + lesson2.duration + " min)" +
            "</div>";
    }
    
    html += "</div>";
    
    // Show requester's reason
    if(request.reason) {
        html += "<div style='margin-top: 0.75rem; padding: 0.5rem 0.75rem; background: var(--violet-50); border: 1px solid var(--violet-300); border-radius: 8px;'>" +
            "<div style='font-size: 0.7rem; font-weight: 600; color: var(--violet-700); margin-bottom: 0.15rem;'>💬 Reason for swap</div>" +
            "<div style='font-size: 0.8rem; color: var(--stone-700);'>" + request.reason + "</div>" +
            "</div>";
    }
    
    // Show decline reason if declined
    if(request.status === 'declined' && request.declineReason) {
        html += "<div style='margin-top: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(244, 63, 94, 0.08); border: 1px solid var(--rose-300); border-radius: 8px;'>" +
            "<div style='font-size: 0.7rem; font-weight: 600; color: var(--rose-600); margin-bottom: 0.15rem;'>💬 Reason for declining</div>" +
            "<div style='font-size: 0.8rem; color: var(--stone-700);'>" + request.declineReason + "</div>" +
            "</div>";
    }
    
    // Show info about student agreement
    if(request.status === 'student_agreed' && request.studentAgreedAt) {
        const agreedDate = new Date(request.studentAgreedAt);
        const formattedDate = agreedDate.toLocaleDateString();
        const formattedTime = agreedDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        
        html += "<div style='font-size: 0.75rem; margin-top: 0.75rem; padding: 0.5rem; background: var(--teal-50); border-radius: 6px; color: var(--teal-700);'>" +
            "✓ " + (request.agreedBy || request.targetStudent) + " agreed on " + formattedDate + " at " + formattedTime +
            "</div>";
    }
    
    // Resolution info for resolved requests
    if((request.status === 'approved' || request.status === 'declined') && request.resolvedAt) {
        const resolvedDate = new Date(request.resolvedAt);
        const formattedDate = resolvedDate.toLocaleDateString();
        const formattedTime = resolvedDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        
        let resolutionText = '';
        if(request.status === 'approved') {
            resolutionText = "Approved by teacher on " + formattedDate + " at " + formattedTime;
        } else {
            if(request.resolvedBy === 'teacher') {
                resolutionText = "Declined by teacher on " + formattedDate + " at " + formattedTime;
            } else {
                resolutionText = "Declined by " + request.targetStudent + " on " + formattedDate + " at " + formattedTime;
            }
        }
        
        html += "<div style='font-size: 0.7rem; margin-top: 0.75rem; opacity: 0.7; font-style: italic;'>" +
            resolutionText +
            "</div>";
    }
    
    // Action buttons
    if(showActions) {
        if(request.status === 'student_agreed') {
            // Both students agreed - teacher just needs to approve
            html += "<div style='display: flex; gap: 0.5rem; margin-top: 0.75rem;'>" +
                "<button onclick='teacherApproveSwap(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--teal-600); color: white;'>✓ Approve Swap</button>" +
                "<button onclick='teacherDeclineSwap(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--rose-500); color: white;'>✗ Decline</button>" +
                "</div>";
        } else if(request.status === 'pending') {
            // Still waiting for student - teacher can approve directly or decline
            html += "<div style='display: flex; gap: 0.5rem; margin-top: 0.75rem;'>" +
                "<button onclick='teacherApproveSwap(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--emerald-500); color: white;'>✓ Approve Now</button>" +
                "<button onclick='teacherDeclineSwap(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--rose-500); color: white;'>✗ Decline</button>" +
                "</div>" +
                "<p style='font-size: 0.7rem; color: var(--stone-400); margin-top: 0.5rem; text-align: center;'>Or wait for " + request.targetStudent + " to respond</p>";
        }
    }
    
    html += "</div>";
    
    return html;
}

function teacherApproveSwap(requestId) {
    const request = swapRequests.find(r => r.id === requestId);
    if(!request) return;
    
    const lesson1 = lessons.find(l => l.id === request.requestingLessonId);
    const lesson2 = lessons.find(l => l.id === request.targetLessonId);
    
    if(!lesson1 || !lesson2) {
        toast("Error: Lessons not found");
        return;
    }
    
    // Capture original times before swap
    const origReqDay = lesson1.day;
    const origReqTime = lesson1.time;
    const origTargDay = lesson2.day;
    const origTargTime = lesson2.time;
    
    // Swap the times
    lesson1.day = lesson2.day;
    lesson1.time = lesson2.time;
    lesson2.day = origReqDay;
    lesson2.time = origReqTime;
    
    // Break from recurring series
    if(lesson1.isRecurring) { lesson1.isRecurring = false; lesson1.seriesId = null; }
    if(lesson2.isRecurring) { lesson2.isRecurring = false; lesson2.seriesId = null; }
    
    request.status = 'approved';
    request.resolvedAt = new Date().toISOString();
    request.resolvedBy = 'teacher';
    
    // Store old and new times so notifications can show them
    request.oldRequestingDay = origReqDay;
    request.oldRequestingTime = origReqTime;
    request.newRequestingDay = lesson1.day;
    request.newRequestingTime = lesson1.time;
    request.newRequestingWeek = lesson1.week;
    request.oldTargetDay = origTargDay;
    request.oldTargetTime = origTargTime;
    request.newTargetDay = lesson2.day;
    request.newTargetTime = lesson2.time;
    request.newTargetWeek = lesson2.week;
    
    toast("Swap approved!");
    saveData();
    render();
    showTeacherSwapRequests();
}

function teacherDeclineSwap(requestId) {
    const request = swapRequests.find(r => r.id === requestId);
    if(request) {
        request.status = 'declined';
        request.resolvedAt = new Date().toISOString();
        request.resolvedBy = 'teacher';
    }
    toast("Swap declined");
    saveData();
    showTeacherSwapRequests();
}

function goToToday() {
    currentWeek = 0;
    render();
}

function dragstart(e) {
    draggedId = parseInt(e.target.getAttribute('data-id'));
    e.target.classList.add('dragging');
    
    // Store dragged lesson info for preview
    const lesson = lessons.find(l => l.id === draggedId);
    if (lesson) {
        draggedDuration = lesson.duration;
    }
    
    // Store the offset within the element where user clicked
    const rect = e.target.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    draggedWidth = rect.width;
    draggedHeight = rect.height;
    
    // Create time tooltip
    createDropTooltip();
    
    e.stopPropagation();
}

function dragend(e) {
    e.target.classList.remove('dragging');
    draggedDuration = null;
    dragOffsetX = 0;
    dragOffsetY = 0;
    draggedWidth = 0;
    draggedHeight = 0;
    
    // Clean up all drag elements everywhere
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    document.querySelectorAll('.drop-indicator, .drop-preview').forEach(el => el.remove());
    removeDropTooltip();
}

function dragover(e) {
    e.preventDefault();
    
    if (!draggedId) return;
    
    const cell = e.currentTarget;
    const day = parseInt(cell.getAttribute('data-day'));
    
    // Add drag-over class
    if (!cell.classList.contains('past-day')) {
        // Remove from other cells first
        document.querySelectorAll('.drag-over').forEach(el => {
            if (el !== cell) el.classList.remove('drag-over');
        });
        cell.classList.add('drag-over');
        
        // Calculate snap position
        const snapInfo = calculateSnapPosition(e, cell);
        
        // Check if this position is blocked
        const dropStart = timeToMinutes(snapInfo.time);
        const dropEnd = dropStart + (draggedDuration || 60);
        const isBlocked = blockedTimes.some(b => {
            if(b.week !== currentWeek || b.day !== day) return false;
            const blockStart = timeToMinutes(b.time);
            const blockEnd = blockStart + b.duration;
            return dropStart < blockEnd && dropEnd > blockStart;
        });
        
        // Show drop indicator and preview (with blocked state)
        showDropIndicator(cell, snapInfo, isBlocked);
        
        // Update tooltip - positioned at top right of preview
        updateDropTooltip(e, snapInfo.time, cell, snapInfo.snapY, isBlocked);
    }
}

function dragleave(e) {
    // Remove indicators when leaving - dragover on new cell will add them there
    const cell = e.currentTarget;
    cell.classList.remove('drag-over');
    
    // Remove indicators from this cell
    cell.querySelectorAll('.drop-indicator, .drop-preview').forEach(el => el.remove());
}

// Calculate where the lesson should snap to
function calculateSnapPosition(e, cell) {
    const rect = cell.getBoundingClientRect();
    const y = e.clientY - rect.top;
    const cellHeight = 80; // matches CSS
    
    // Calculate percentage down the cell
    const percentDown = Math.max(0, Math.min(y / cellHeight, 1));
    
    // Snap to 15-minute increments based on TOP of the box
    // Each 15 minutes = 20px (80px / 4)
    let minuteSlot;
    let snapY;
    
    if (percentDown < 0.25) {
        minuteSlot = 0;
        snapY = 0;
    } else if (percentDown < 0.5) {
        minuteSlot = 15;
        snapY = 20;
    } else if (percentDown < 0.75) {
        minuteSlot = 30;
        snapY = 40;
    } else {
        minuteSlot = 45;
        snapY = 60;
    }
    
    const baseTime = cell.getAttribute('data-time');
    const hour = baseTime.split(':')[0];
    const time = hour + ':' + minuteSlot.toString().padStart(2, '0');
    
    return { minuteSlot, snapY, time };
}

// Show drop indicator line and preview box
function showDropIndicator(cell, snapInfo, isBlocked) {
    // Remove existing indicators in this cell
    removeDropIndicators(cell);
    
    // Create indicator line
    const indicator = document.createElement('div');
    indicator.className = 'drop-indicator' + (isBlocked ? ' drop-indicator-blocked' : '');
    indicator.style.top = snapInfo.snapY + 'px';
    cell.appendChild(indicator);
    
    // Create preview box showing where lesson will land
    if (draggedDuration) {
        const preview = document.createElement('div');
        preview.className = 'drop-preview' + (isBlocked ? ' drop-preview-blocked' : '');
        preview.style.top = snapInfo.snapY + 'px';
        
        // Calculate height based on duration
        const heightPx = (draggedDuration / 60) * 80;
        preview.style.height = Math.min(heightPx, 80 - snapInfo.snapY) + 'px';
        
        cell.appendChild(preview);
    }
}

// Remove drop indicators
function removeDropIndicators(cell) {
    const container = cell || document;
    container.querySelectorAll('.drop-indicator, .drop-preview').forEach(el => el.remove());
}

// Create floating tooltip
function createDropTooltip() {
    if (document.getElementById('dropTooltip')) return;
    
    const tooltip = document.createElement('div');
    tooltip.id = 'dropTooltip';
    tooltip.className = 'drop-time-tooltip';
    tooltip.style.display = 'none';
    document.body.appendChild(tooltip);
}

// Update tooltip position and content - positioned outside top right of moving box
function updateDropTooltip(e, time, cell, snapY, isBlocked) {
    const tooltip = document.getElementById('dropTooltip');
    if (!tooltip) return;
    
    if (isBlocked) {
        tooltip.textContent = '🚫 ' + time;
        tooltip.style.background = 'var(--rose-600)';
    } else {
        tooltip.textContent = '📍 ' + time;
        tooltip.style.background = 'var(--stone-800)';
    }
    tooltip.style.display = 'block';
    
    // Calculate position of the moving box based on cursor and drag offset
    const boxLeft = e.clientX - dragOffsetX;
    const boxTop = e.clientY - dragOffsetY;
    const boxRight = boxLeft + draggedWidth;
    
    // Position tooltip outside the top-right corner of the moving box
    tooltip.style.left = (boxRight + 8) + 'px';
    tooltip.style.top = (boxTop - 4) + 'px';
}

// Remove tooltip
function removeDropTooltip() {
    const tooltip = document.getElementById('dropTooltip');
    if (tooltip) tooltip.remove();
}

function drop(e) {
    e.preventDefault();
    if(!draggedId) return;
    
    const cell = e.currentTarget;
    const newDay = parseInt(cell.getAttribute('data-day'));
    
    // Clean up all visuals everywhere
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    document.querySelectorAll('.drop-indicator, .drop-preview').forEach(el => el.remove());
    removeDropTooltip();
    
    const lesson = lessons.find(l => l.id === draggedId);
    if (!lesson) {
        draggedId = null;
        draggedDuration = null;
        dragOffsetX = 0;
        dragOffsetY = 0;
        draggedWidth = 0;
        draggedHeight = 0;
        return;
    }
    
    // Use same snap calculation as dragover
    const snapInfo = calculateSnapPosition(e, cell);
    const newTime = snapInfo.time;
    
    // Check if dropped at original position - silently do nothing
    if (lesson.day === newDay && lesson.time === newTime && lesson.week === currentWeek) {
        draggedId = null;
        draggedDuration = null;
        dragOffsetX = 0;
        dragOffsetY = 0;
        draggedWidth = 0;
        draggedHeight = 0;
        return;
    }
    
    if(isTimeInPast(currentWeek, newDay, newTime)) {
        draggedId = null;
        draggedDuration = null;
        dragOffsetX = 0;
        dragOffsetY = 0;
        draggedWidth = 0;
        draggedHeight = 0;
        toast("Cannot move lessons to past times");
        return;
    }
    
    // Check if dropping onto a blocked time
    const dropStart = timeToMinutes(newTime);
    const dropEnd = dropStart + lesson.duration;
    const hasBlockConflict = blockedTimes.some(b => {
        if(b.week !== currentWeek || b.day !== newDay) return false;
        const blockStart = timeToMinutes(b.time);
        const blockEnd = blockStart + b.duration;
        return dropStart < blockEnd && dropEnd > blockStart;
    });
    
    if(hasBlockConflict) {
        draggedId = null;
        draggedDuration = null;
        dragOffsetX = 0;
        dragOffsetY = 0;
        draggedWidth = 0;
        draggedHeight = 0;
        toast("Cannot move to blocked time");
        return;
    }
    
    if(lesson.isRecurring && lesson.seriesId) {
        showRecurringMovePrompt(lesson, newDay, newTime);
    } else {
        performMove(lesson.id, newDay, newTime);
    }
    
    draggedId = null;
    draggedDuration = null;
    dragOffsetX = 0;
    dragOffsetY = 0;
    draggedWidth = 0;
    draggedHeight = 0;
}

function showRecurringMovePrompt(lesson, newDay, newTime) {
    const name = lesson.firstName + " " + lesson.lastName;
    const html = "<h3 class='modal-title'>Move Recurring Lesson?</h3>" +
        "<p class='mb-4'>Moving <strong>" + name + "</strong> to " + days[newDay] + " at " + newTime + ".</p>" +
        "<p class='text-sm mb-4' style='color: var(--stone-500);'>Apply this change to:</p>" +
        "<button onclick='performMove(" + lesson.id + "," + newDay + ",\"" + newTime + "\",false)' class='modal-btn modal-btn-warning'>" +
        "Only This Lesson<br><span style='font-size: 0.8rem; opacity: 0.9;'>Move just this single occurrence</span>" +
        "</button>" +
        "<button onclick='performMove(" + lesson.id + "," + newDay + ",\"" + newTime + "\",true)' class='modal-btn modal-btn-primary'>" +
        "All Future Lessons<br><span style='font-size: 0.8rem; opacity: 0.9;'>Move all lessons in this series</span>" +
        "</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function performMove(lessonId, newDay, newTime, applyToAll) {
    const lesson = lessons.find(l => l.id === lessonId);
    const conflicts = checkConflict(newDay, newTime, lesson.duration, lessonId);
    
    if(conflicts.length > 0) {
        closeModal();
        showConflictWarning(conflicts, lesson, newDay, newTime, applyToAll);
    } else {
        if(applyToAll && lesson.isRecurring && lesson.seriesId) {
            const sameSeries = lessons.filter(l => l.seriesId === lesson.seriesId);
            sameSeries.forEach(l => {
                l.day = newDay;
                l.time = newTime;
            });
            closeModal();
            toast(lesson.firstName + " series moved to " + days[newDay] + " at " + newTime);
        } else {
            lesson.day = newDay;
            lesson.time = newTime;
            closeModal();
            toast(lesson.firstName + " moved to " + days[newDay] + " at " + newTime);
        }
        render();
    }
}

function checkConflict(day, time, duration, excludeId) {
    const startMinutes = timeToMinutes(time);
    const endMinutes = startMinutes + duration;
    
    let excludeStudentName = null;
    if(excludeId) {
        const excludeLesson = lessons.find(l => l.id === excludeId);
        if(excludeLesson) {
            excludeStudentName = excludeLesson.firstName + " " + excludeLesson.lastName;
        }
    }
    
    return lessons.filter(l => {
        if(l.id === excludeId) return false;
        if(l.day !== day) return false;
        if(l.week !== currentWeek) return false;
        
        if(excludeStudentName) {
            const lessonStudentName = l.firstName + " " + l.lastName;
            if(lessonStudentName === excludeStudentName) return false;
        }
        
        const lessonStart = timeToMinutes(l.time);
        const lessonEnd = lessonStart + l.duration;
        return (startMinutes < lessonEnd && endMinutes > lessonStart);
    });
}

function timeToMinutes(time) {
    const parts = time.split(':');
    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

function showConflictWarning(conflicts, lesson, newDay, newTime, applyToAll) {
    const conflictList = conflicts.map(c => {
        const name = c.firstName + " " + c.lastName;
        const endTime = addMinutes(c.time, c.duration);
        const dateInfo = getDateForLesson(c);
        return "<div class='conflict-item'><strong>" + name + "</strong><br>" +
               "<span class='text-xs'>" + days[c.day] + ", " + dateInfo + "</span><br>" +
               c.time + " to " + endTime + " (" + c.duration + " min)</div>";
    }).join('');
    
    const applyToAllParam = applyToAll ? ',true' : ',false';
    
    const html = "<h3 class='modal-title' style='color: var(--coral-500);'>⚠️ Scheduling Conflict</h3>" +
        "<p class='mb-4'>This lesson overlaps with existing lessons:</p>" +
        "<div class='conflict-list'>" + conflictList + "</div>" +
        "<p class='text-sm mb-4' style='color: var(--stone-500);'>Both lessons will appear side-by-side in the calendar. Schedule anyway?</p>" +
        "<button onclick='overrideConflict(" + lesson.id + "," + newDay + ",\"" + newTime + "\"" + applyToAllParam + ")' class='modal-btn modal-btn-warning'>Schedule Anyway</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function addMinutes(time, minutes) {
    const total = timeToMinutes(time) + minutes;
    const hours = Math.floor(total / 60);
    const mins = total % 60;
    return hours.toString().padStart(2, '0') + ':' + mins.toString().padStart(2, '0');
}

function overrideConflict(lessonId, newDay, newTime, applyToAll) {
    const lesson = lessons.find(l => l.id === lessonId);
    
    if(applyToAll && lesson.isRecurring && lesson.seriesId) {
        const sameSeries = lessons.filter(l => l.seriesId === lesson.seriesId);
        sameSeries.forEach(l => {
            l.day = newDay;
            l.time = newTime;
        });
        toast(lesson.firstName + " series moved - lessons will appear side-by-side");
    } else {
        lesson.day = newDay;
        lesson.time = newTime;
        toast(lesson.firstName + " moved - lessons will appear side-by-side");
    }
    
    closeModal();
    render();
}

function showDetails(id) {
    const lesson = lessons.find(l => l.id === id);
    const name = lesson.firstName + " " + lesson.lastName;
    const isPast = isTimeInPast(lesson.week, lesson.day, lesson.time);
    const tooSoon = isLessonTooSoon(lesson.week, lesson.day, lesson.time);
    
    const isMyLesson = loginMode === 'student' && loggedInStudent && 
                       lesson.firstName === loggedInStudent.firstName && 
                       lesson.lastName === loggedInStudent.lastName;
    
    let html = "<h3 class='modal-title'>Lesson Details</h3>";
    
    if(isPast) {
        html += "<div class='info-box info-box-info mb-4'>📅 Past lesson (read-only)</div>";
    }
    
    html += "<div class='mb-4'>" +
        "<div class='detail-row'><span class='detail-label'>Student</span><span class='detail-value'>" + name + "</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Day</span><span class='detail-value'>" + days[lesson.day] + "</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Time</span><span class='detail-value'>" + lesson.time + "</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Duration</span><span class='detail-value'>" + lesson.duration + " minutes</span></div>" +
        "</div>";
    
    if(lesson.isRecurring) {
        html += "<div class='recurring-badge'>🔁 Recurring weekly</div><br><br>";
    }
    
    if(loginMode === 'teacher' && !isPast) {
        html += "<button onclick='showEdit(" + id + ")' class='modal-btn modal-btn-primary'>Edit</button>" +
            "<button onclick='deleteLesson(" + id + ")' class='modal-btn modal-btn-danger'>Delete</button>";
    }
    
    if(loginMode === 'student' && isMyLesson && !isPast) {
        if(tooSoon) {
            html += "<div class='info-box info-box-warning' style='margin-bottom: 0.75rem;'>⏳ This lesson starts within the next hour. Swap and reschedule requests are no longer available.</div>";
        } else {
            html += "<button onclick='showStudentSwapOptions(" + id + ",\"" + loggedInStudent.firstName + "\",\"" + loggedInStudent.lastName + "\")' class='modal-btn modal-btn-violet'>🔄 Swap with Student</button>";
            html += "<button onclick='showRequestTeacherReschedule(" + id + ")' class='modal-btn modal-btn-amber'>📩 Ask Teacher to Reschedule</button>";
            html += "<button onclick='showRescheduleOptions(" + id + ")' class='modal-btn modal-btn-primary'>📅 Pick New Time</button>";
        }
    }
    
    if(loginMode === 'student' && !isMyLesson) {
        html += "<div class='info-box info-box-info'>This is " + name + "'s lesson. You can only request swaps for your own lessons.</div>";
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Close</button>";
    
    modal(html);
}

function showEdit(id) {
    const lesson = lessons.find(l => l.id === id);
    
    const html = "<h3 class='modal-title'>Edit Lesson</h3>" +
        "<label class='form-label'>First Name</label>" +
        "<input id='editFirst' value='" + lesson.firstName + "' class='form-input'>" +
        "<label class='form-label'>Last Name</label>" +
        "<input id='editLast' value='" + lesson.lastName + "' class='form-input'>" +
        "<label class='form-label'>Day</label>" +
        "<select id='editDay' class='form-select'>" +
        days.map((d,i) => "<option value='" + i + "'" + (i===lesson.day?" selected":"") + ">" + d + "</option>").join("") + "</select>" +
        "<label class='form-label'>Time</label>" +
        "<select id='editTime' class='form-select'>" +
        detailedTimes.map(t => "<option value='" + t + "'" + (t===lesson.time?" selected":"") + ">" + t + "</option>").join("") + "</select>" +
        "<label class='form-label'>Duration</label>" +
        "<select id='editDuration' class='form-select'>" +
        "<option value='30'" + (lesson.duration===30?" selected":"") + ">30 minutes</option>" +
        "<option value='45'" + (lesson.duration===45?" selected":"") + ">45 minutes</option>" +
        "<option value='60'" + (lesson.duration===60?" selected":"") + ">60 minutes</option></select>" +
        (lesson.isRecurring ? 
            "<label class='form-checkbox'>" +
            "<input type='checkbox' id='editAllRecurring'>" +
            "<span style='color: var(--coral-500);'>Apply changes to all future lessons in this series</span>" +
            "</label>" : "") +
        "<button onclick='saveEdit(" + id + ")' class='modal-btn modal-btn-primary'>Save</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function saveEdit(id) {
    const lesson = lessons.find(l => l.id === id);
    const newDay = parseInt(document.getElementById('editDay').value);
    const newTime = document.getElementById('editTime').value;
    const newDuration = parseInt(document.getElementById('editDuration').value);
    const editAllCheckbox = document.getElementById('editAllRecurring');
    const editAllFuture = editAllCheckbox && editAllCheckbox.checked;
    
    tempEditData = {
        id: id,
        firstName: document.getElementById('editFirst').value,
        lastName: document.getElementById('editLast').value,
        day: newDay,
        time: newTime,
        duration: newDuration,
        editAllFuture: editAllFuture
    };
    
    const conflicts = checkConflict(newDay, newTime, newDuration, id);
    
    if(conflicts.length > 0) {
        closeModal();
        const conflictList = conflicts.map(c => {
            const name = c.firstName + " " + c.lastName;
            const endTime = addMinutes(c.time, c.duration);
            const dateInfo = getDateForLesson(c);
            return "<div class='conflict-item'><strong>" + name + "</strong><br>" +
                   "<span class='text-xs'>" + days[c.day] + ", " + dateInfo + "</span><br>" +
                   c.time + " to " + endTime + " (" + c.duration + " min)</div>";
        }).join('');
        
        const html = "<h3 class='modal-title' style='color: var(--coral-500);'>⚠️ Scheduling Conflict</h3>" +
            "<p class='mb-4'>This change creates conflicts:</p>" +
            "<div class='conflict-list'>" + conflictList + "</div>" +
            "<button onclick='forceEdit(" + id + ")' class='modal-btn modal-btn-warning'>Save Anyway</button>" +
            "<button onclick='showEdit(" + id + ")' class='modal-btn modal-btn-secondary'>Go Back</button>";
        
        modal(html);
        return;
    }
    
    if(editAllFuture && lesson.isRecurring && lesson.seriesId) {
        const sameSeries = lessons.filter(l => l.seriesId === lesson.seriesId);
        sameSeries.forEach(l => {
            l.firstName = document.getElementById('editFirst').value;
            l.lastName = document.getElementById('editLast').value;
            l.day = newDay;
            l.time = newTime;
            l.duration = newDuration;
        });
        toast("Updated all lessons in series!");
    } else {
        lesson.firstName = document.getElementById('editFirst').value;
        lesson.lastName = document.getElementById('editLast').value;
        lesson.day = newDay;
        lesson.time = newTime;
        lesson.duration = newDuration;
        toast("Lesson updated!");
    }
    
    closeModal();
    render();
}

function forceEdit(id) {
    if(!tempEditData) return;
    
    const lesson = lessons.find(l => l.id === id);
    const editAllFuture = tempEditData.editAllFuture;
    
    if(editAllFuture && lesson.isRecurring && lesson.seriesId) {
        const sameSeries = lessons.filter(l => l.seriesId === lesson.seriesId);
        sameSeries.forEach(l => {
            l.firstName = tempEditData.firstName;
            l.lastName = tempEditData.lastName;
            l.day = tempEditData.day;
            l.time = tempEditData.time;
            l.duration = tempEditData.duration;
        });
        toast("Updated all lessons in series (with conflict)");
    } else {
        lesson.firstName = tempEditData.firstName;
        lesson.lastName = tempEditData.lastName;
        lesson.day = tempEditData.day;
        lesson.time = tempEditData.time;
        lesson.duration = tempEditData.duration;
        toast("Lesson updated (with conflict)");
    }
    
    tempEditData = null;
    closeModal();
    render();
}

function deleteLesson(id) {
    const lesson = lessons.find(l => l.id === id);
    const name = lesson.firstName + " " + lesson.lastName;
    
    if(lesson.isRecurring && lesson.seriesId) {
        const html = "<h3 class='modal-title' style='color: var(--rose-500);'>Delete Recurring Lesson?</h3>" +
            "<p class='mb-4'>This is a recurring lesson for <strong>" + name + "</strong>.</p>" +
            "<p class='text-sm mb-4' style='color: var(--stone-500);'>What would you like to delete?</p>" +
            "<button onclick='deleteOnlyThis(" + id + ")' class='modal-btn modal-btn-warning'>" +
            "Delete Only This Lesson<br><span style='font-size: 0.8rem; opacity: 0.9;'>Remove just this single occurrence</span>" +
            "</button>" +
            "<button onclick='deleteAllInSeries(\"" + lesson.seriesId + "\")' class='modal-btn modal-btn-danger'>" +
            "Delete All Lessons in Series<br><span style='font-size: 0.8rem; opacity: 0.9;'>Remove all lessons for this student</span>" +
            "</button>" +
            "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
        
        modal(html);
    } else {
        const html = "<h3 class='modal-title' style='color: var(--rose-500);'>Delete Lesson?</h3>" +
            "<p class='mb-4'>Delete lesson for <strong>" + name + "</strong>?</p>" +
            "<button onclick='confirmDelete(" + id + ")' class='modal-btn modal-btn-danger'>Yes, Delete</button>" +
            "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
        
        modal(html);
    }
}

function deleteOnlyThis(id) {
    const lesson = lessons.find(l => l.id === id);
    const name = lesson.firstName + " " + lesson.lastName;
    lessons = lessons.filter(l => l.id !== id);
    closeModal();
    render();
    toast("Deleted one lesson for " + name);
}

function deleteAllInSeries(seriesId) {
    const firstLesson = lessons.find(l => l.seriesId === seriesId);
    const name = firstLesson.firstName + " " + firstLesson.lastName;
    const count = lessons.filter(l => l.seriesId === seriesId).length;
    lessons = lessons.filter(l => l.seriesId !== seriesId);
    closeModal();
    render();
    toast("Deleted " + count + " lessons for " + name);
}

function confirmDelete(id) {
    const lesson = lessons.find(l => l.id === id);
    const name = lesson.firstName + " " + lesson.lastName;
    lessons = lessons.filter(l => l.id !== id);
    closeModal();
    render();
    toast("Deleted: " + name);
}

function showAddModal() {
    const students = getUniqueStudents().filter(s => !s.retired);
    
    let studentOptions = "<option value=''>-- Select Student --</option>";
    students.forEach(s => {
        studentOptions += "<option value='" + s.firstName + "|" + s.lastName + "'>" + s.firstName + " " + s.lastName + "</option>";
    });
    studentOptions += "<option value='new'>+ Add New Student</option>";
    
    const html = "<h3 class='modal-title'>Add New Lesson</h3>" +
        "<label class='form-label'>Student</label>" +
        "<select id='studentSelect' class='form-select' onchange='handleStudentSelect()'>" +
        studentOptions +
        "</select>" +
        "<div id='nameFields' style='display:none;'>" +
        "<label class='form-label'>First Name</label>" +
        "<input id='newFirst' placeholder='First Name' class='form-input'>" +
        "<label class='form-label'>Last Name</label>" +
        "<input id='newLast' placeholder='Last Name' class='form-input'>" +
        "</div>" +
        "<label class='form-label'>Day</label>" +
        "<select id='newDay' class='form-select'>" +
        days.map((d,i) => "<option value='" + i + "'>" + d + "</option>").join("") + "</select>" +
        "<label class='form-label'>Time</label>" +
        "<select id='newTime' class='form-select'>" +
        detailedTimes.map(t => "<option value='" + t + "'>" + t + "</option>").join("") + "</select>" +
        "<label class='form-label'>Duration</label>" +
        "<select id='newDuration' class='form-select'>" +
        "<option value='30'>30 minutes</option><option value='45'>45 minutes</option><option value='60' selected>60 minutes</option></select>" +
        "<label class='form-checkbox'>" +
        "<input type='checkbox' id='newRecurring' checked onchange='toggleEndDate()'>" +
        "<span>Recurring weekly lesson</span>" +
        "</label>" +
        "<div id='endDateSection'>" +
        "<label class='form-label'>Repeat until <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='date' id='endDate' class='form-input'>" +
        "<p class='text-xs' style='color: var(--stone-400); margin-top: -0.75rem; margin-bottom: 1rem;'>Leave blank to repeat indefinitely</p>" +
        "</div>" +
        "<button onclick='saveNew()' class='modal-btn modal-btn-success'>Add Lesson</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function handleStudentSelect() {
    const select = document.getElementById('studentSelect');
    const nameFields = document.getElementById('nameFields');
    const firstInput = document.getElementById('newFirst');
    const lastInput = document.getElementById('newLast');
    
    if(select.value === 'new') {
        nameFields.style.display = 'block';
        firstInput.value = '';
        lastInput.value = '';
        firstInput.readOnly = false;
        lastInput.readOnly = false;
    } else if(select.value === '') {
        nameFields.style.display = 'none';
        firstInput.value = '';
        lastInput.value = '';
    } else {
        const [firstName, lastName] = select.value.split('|');
        nameFields.style.display = 'block';
        firstInput.value = firstName;
        lastInput.value = lastName;
        firstInput.readOnly = true;
        lastInput.readOnly = true;
    }
}

function toggleEndDate() {
    const recurring = document.getElementById('newRecurring').checked;
    const endDateSection = document.getElementById('endDateSection');
    if(endDateSection) {
        endDateSection.style.display = recurring ? 'block' : 'none';
    }
}

function saveNew() {
    const studentSelect = document.getElementById('studentSelect');
    const firstName = document.getElementById('newFirst').value.trim();
    const lastName = document.getElementById('newLast').value.trim();
    
    if(!studentSelect.value) {
        toast("Please select a student");
        return;
    }
    
    if(!firstName || !lastName) {
        toast("Please enter student name");
        return;
    }
    
    const newDay = parseInt(document.getElementById('newDay').value);
    const newTime = document.getElementById('newTime').value;
    const newDuration = parseInt(document.getElementById('newDuration').value);
    const isRecurring = document.getElementById('newRecurring').checked;
    
    tempNewData = {
        firstName: firstName,
        lastName: lastName,
        day: newDay,
        time: newTime,
        duration: newDuration,
        isRecurring: isRecurring,
        endDate: document.getElementById('endDate') ? document.getElementById('endDate').value : ''
    };
    
    const conflicts = checkConflict(newDay, newTime, newDuration, null);
    
    if(conflicts.length > 0) {
        closeModal();
        const conflictList = conflicts.map(c => {
            const name = c.firstName + " " + c.lastName;
            const endTime = addMinutes(c.time, c.duration);
            const dateInfo = getDateForLesson(c);
            return "<div class='conflict-item'><strong>" + name + "</strong><br>" +
                   "<span class='text-xs'>" + days[c.day] + ", " + dateInfo + "</span><br>" +
                   c.time + " to " + endTime + " (" + c.duration + " min)</div>";
        }).join('');
        
        const html = "<h3 class='modal-title' style='color: var(--coral-500);'>⚠️ Scheduling Conflict</h3>" +
            "<p class='mb-4'>This lesson conflicts with:</p>" +
            "<div class='conflict-list'>" + conflictList + "</div>" +
            "<button onclick='forceNew()' class='modal-btn modal-btn-warning'>Add Anyway</button>" +
            "<button onclick='showAddModal()' class='modal-btn modal-btn-secondary'>Go Back</button>";
        
        modal(html);
        return;
    }
    
    const newLesson = {
        id: nextId++,
        firstName: firstName,
        lastName: lastName,
        day: newDay,
        time: newTime,
        duration: newDuration,
        week: currentWeek
    };
    
    lessons.push(newLesson);
    
    if(isRecurring) {
        newLesson.isRecurring = true;
        newLesson.seriesId = "series-" + nextSeriesId++;
        
        const endDateInput = document.getElementById('endDate');
        const endDateValue = endDateInput ? endDateInput.value : '';
        
        if(endDateValue) {
            const endDate = new Date(endDateValue);
            const today = new Date();
            const weeksToCreate = Math.ceil((endDate - today) / (7 * 24 * 60 * 60 * 1000));
            
            for(let w = 1; w <= weeksToCreate && w <= 52; w++) {
                lessons.push({
                    id: nextId++,
                    firstName: newLesson.firstName,
                    lastName: newLesson.lastName,
                    day: newDay,
                    time: newTime,
                    duration: newDuration,
                    week: currentWeek + w,
                    isRecurring: true,
                    seriesId: newLesson.seriesId
                });
            }
            toast("Lesson added! Created " + (weeksToCreate + 1) + " lessons until " + endDate.toLocaleDateString());
        } else {
            for(let w = 1; w <= 52; w++) {
                lessons.push({
                    id: nextId++,
                    firstName: newLesson.firstName,
                    lastName: newLesson.lastName,
                    day: newDay,
                    time: newTime,
                    duration: newDuration,
                    week: currentWeek + w,
                    isRecurring: true,
                    seriesId: newLesson.seriesId
                });
            }
            toast("Lesson added! (Recurring for 52 weeks)");
        }
    } else {
        toast("Lesson added!");
    }
    
    closeModal();
    render();
}

function forceNew() {
    if(!tempNewData) return;
    
    const newLesson = {
        id: nextId++,
        firstName: tempNewData.firstName,
        lastName: tempNewData.lastName,
        day: tempNewData.day,
        time: tempNewData.time,
        duration: tempNewData.duration,
        week: currentWeek
    };
    
    lessons.push(newLesson);
    
    if(tempNewData.isRecurring) {
        newLesson.isRecurring = true;
        newLesson.seriesId = "series-" + nextSeriesId++;
        
        if(tempNewData.endDate) {
            const endDate = new Date(tempNewData.endDate);
            const today = new Date();
            const weeksToCreate = Math.ceil((endDate - today) / (7 * 24 * 60 * 60 * 1000));
            
            for(let w = 1; w <= weeksToCreate && w <= 52; w++) {
                lessons.push({
                    id: nextId++,
                    firstName: newLesson.firstName,
                    lastName: newLesson.lastName,
                    day: tempNewData.day,
                    time: tempNewData.time,
                    duration: tempNewData.duration,
                    week: currentWeek + w,
                    isRecurring: true,
                    seriesId: newLesson.seriesId
                });
            }
        } else {
            for(let w = 1; w <= 52; w++) {
                lessons.push({
                    id: nextId++,
                    firstName: newLesson.firstName,
                    lastName: newLesson.lastName,
                    day: tempNewData.day,
                    time: tempNewData.time,
                    duration: tempNewData.duration,
                    week: currentWeek + w,
                    isRecurring: true,
                    seriesId: newLesson.seriesId
                });
            }
        }
    }
    
    tempNewData = null;
    closeModal();
    render();
    toast("Lesson added (with conflict)");
}

let _returnToDashboard = false;

function openDashboardModal(showFn) {
    _returnToDashboard = true;
    showFn();
}

function modal(html) {
    document.getElementById('modalContent').innerHTML = html;
    document.getElementById('modal').classList.add('active');
}

function closeModal() {
    document.getElementById('modal').classList.remove('active');
    if(_returnToDashboard) {
        _returnToDashboard = false;
        goToDashboard();
    }
}

// Enhanced toast notification system
let toastTimeout = null;

function toast(msg, type = 'auto') {
    const t = document.getElementById('toast');
    
    // Clear any existing timeout
    if (toastTimeout) {
        clearTimeout(toastTimeout);
    }
    
    // Auto-detect type based on message content
    if (type === 'auto') {
        const msgLower = msg.toLowerCase();
        if (msgLower.includes('error') || msgLower.includes('invalid') || msgLower.includes('failed') || msgLower.includes('cannot') || msgLower.includes('please')) {
            type = 'error';
        } else if (msgLower.includes('deleted') || msgLower.includes('removed') || msgLower.includes('declined') || msgLower.includes('cancelled') || msgLower.includes('canceled')) {
            type = 'warning';
        } else if (msgLower.includes('added') || msgLower.includes('saved') || msgLower.includes('updated') || msgLower.includes('approved') || msgLower.includes('success') || msgLower.includes('created') || msgLower.includes('moved') || msgLower.includes('welcome')) {
            type = 'success';
        } else if (msgLower.includes('logged out')) {
            type = 'info';
        } else {
            type = 'default';
        }
    }
    
    // Icon mapping
    const icons = {
        success: '✓',
        error: '✕',
        warning: '⚠',
        info: 'ℹ',
        default: '♪'
    };
    
    // Build toast HTML
    t.innerHTML = `
        <div class="toast-content">
            <span class="toast-icon">${icons[type] || icons.default}</span>
            <span class="toast-message">${msg}</span>
            <button class="toast-close" onclick="hideToast()">✕</button>
        </div>
        <div class="toast-progress">
            <div class="toast-progress-bar"></div>
        </div>
    `;
    
    // Remove all type classes and add new one
    t.className = '';
    t.classList.add('show', 'toast-' + type);
    
    // Auto-hide after 3 seconds
    toastTimeout = setTimeout(() => {
        hideToast();
    }, 3000);
}

function hideToast() {
    const t = document.getElementById('toast');
    t.classList.add('hiding');
    setTimeout(() => {
        t.classList.remove('show', 'hiding');
    }, 300);
}

// Convenience functions for specific toast types
function toastSuccess(msg) { toast(msg, 'success'); }
function toastError(msg) { toast(msg, 'error'); }
function toastWarning(msg) { toast(msg, 'warning'); }
function toastInfo(msg) { toast(msg, 'info'); }

function showBlockTimeModal() {
    const html = "<h3 class='modal-title'>Block Time Slot</h3>" +
        "<p class='modal-subtitle'>Mark times when you're unavailable</p>" +
        "<label class='form-label'>Day</label>" +
        "<select id='blockDay' class='form-select'>" +
        days.map((d,i) => "<option value='" + i + "'>" + d + "</option>").join("") + "</select>" +
        "<label class='form-label'>Time</label>" +
        "<select id='blockTime' class='form-select'>" +
        detailedTimes.map(t => "<option value='" + t + "'>" + t + "</option>").join("") + "</select>" +
        "<label class='form-label'>Duration</label>" +
        "<select id='blockDuration' class='form-select'>" +
        "<option value='30'>30 minutes</option>" +
        "<option value='60' selected>1 hour</option>" +
        "<option value='90'>1.5 hours</option>" +
        "<option value='120'>2 hours</option>" +
        "<option value='180'>3 hours</option>" +
        "<option value='240'>4 hours</option>" +
        "</select>" +
        "<label class='form-label'>Reason</label>" +
        "<input id='blockReason' placeholder='e.g., Lunch, Meeting' class='form-input'>" +
        "<label class='form-label'>Repeat Options</label>" +
        "<select id='blockRepeatType' class='form-select' onchange='toggleBlockEndDate()'>" +
        "<option value='none'>This day only (one time)</option>" +
        "<option value='weekly'>Every week on this day</option>" +
        "<option value='daily'>Every day (all 7 days)</option>" +
        "</select>" +
        "<div id='blockEndDateSection' style='display:none;'>" +
        "<label class='form-label'>Repeat until <span class='form-label-optional'>(Optional - leave blank for indefinitely)</span></label>" +
        "<input type='date' id='blockEndDate' class='form-input'>" +
        "</div>" +
        "<button onclick='saveBlockTime()' class='modal-btn modal-btn-warning'>Block Time</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function toggleBlockEndDate() {
    const repeatType = document.getElementById('blockRepeatType');
    const endDateSection = document.getElementById('blockEndDateSection');
    if(repeatType && endDateSection) {
        endDateSection.style.display = (repeatType.value !== 'none') ? 'block' : 'none';
    }
}

function saveBlockTime() {
    const blockDay = parseInt(document.getElementById('blockDay').value);
    const blockTime = document.getElementById('blockTime').value;
    const blockDuration = parseInt(document.getElementById('blockDuration').value);
    const blockReason = document.getElementById('blockReason').value || 'Unavailable';
    const repeatType = document.getElementById('blockRepeatType').value;
    
    applyBlockTime(blockDay, blockTime, blockDuration, blockReason, repeatType);
}

function applyBlockTime(blockDay, blockTime, blockDuration, blockReason, repeatType) {
    const block = {
        id: nextBlockId++,
        day: blockDay,
        time: blockTime,
        duration: blockDuration,
        reason: blockReason,
        week: currentWeek
    };
    
    blockedTimes.push(block);
    
    if(repeatType === 'daily' || repeatType === 'weekly') {
        const endDateInput = document.getElementById('blockEndDate');
        const endDateValue = endDateInput ? endDateInput.value : '';
        
        if(endDateValue) {
            const endDate = new Date(endDateValue);
            const today = new Date();
            const weeksToCreate = Math.ceil((endDate - today) / (7 * 24 * 60 * 60 * 1000));
            
            if(repeatType === 'daily') {
                for(let w = 0; w <= weeksToCreate && w <= 52; w++) {
                    for(let d = 0; d < 7; d++) {
                        if(w === 0 && d === blockDay) continue;
                        blockedTimes.push({
                            id: nextBlockId++,
                            day: d,
                            time: blockTime,
                            duration: blockDuration,
                            reason: blockReason,
                            week: currentWeek + w
                        });
                    }
                }
            } else {
                for(let w = 1; w <= weeksToCreate && w <= 52; w++) {
                    blockedTimes.push({
                        id: nextBlockId++,
                        day: blockDay,
                        time: blockTime,
                        duration: blockDuration,
                        reason: blockReason,
                        week: currentWeek + w
                    });
                }
            }
        } else {
            if(repeatType === 'daily') {
                for(let w = 0; w <= 52; w++) {
                    for(let d = 0; d < 7; d++) {
                        if(w === 0 && d === blockDay) continue;
                        blockedTimes.push({
                            id: nextBlockId++,
                            day: d,
                            time: blockTime,
                            duration: blockDuration,
                            reason: blockReason,
                            week: currentWeek + w
                        });
                    }
                }
            } else {
                for(let w = 1; w <= 52; w++) {
                    blockedTimes.push({
                        id: nextBlockId++,
                        day: blockDay,
                        time: blockTime,
                        duration: blockDuration,
                        reason: blockReason,
                        week: currentWeek + w
                    });
                }
            }
        }
    }
    
    toast("Time blocked: " + blockReason);
    closeModal();
    render();
}

function showBlockDetails(blockId) {
    const block = blockedTimes.find(b => b.id === blockId);
    if(!block) {
        toast('Error: Block not found');
        return;
    }
    
    const endTime = addMinutes(block.time, block.duration);
    const isPast = isTimeInPast(block.week, block.day, block.time);
    const dateInfo = getDateForLesson(block);
    
    // Check if this is a default/system block
    const isSystemBlock = block.reason === 'Closed' || block.reason === 'Weekend' || block.reason === 'Lunch';
    
    // Find all matching blocks (same time, duration, reason - could be weekly or daily pattern)
    const matchingWeekly = blockedTimes.filter(b => 
        b.time === block.time && 
        b.duration === block.duration && 
        b.reason === block.reason && 
        b.day === block.day &&
        !isTimeInPast(b.week, b.day, b.time)
    );
    
    const matchingDaily = blockedTimes.filter(b => 
        b.time === block.time && 
        b.duration === block.duration && 
        b.reason === block.reason &&
        !isTimeInPast(b.week, b.day, b.time)
    );
    
    const hasWeeklyRecurrence = matchingWeekly.length > 1;
    const hasDailyRecurrence = matchingDaily.length > matchingWeekly.length;
    
    let html = "<h3 class='modal-title' style='color: var(--stone-600);'>🚫 Blocked Time</h3>";
    
    if(isPast) {
        html += "<div class='info-box info-box-info'>📅 Past block (read-only)</div>";
    }
    
    // Show block details
    html += "<div class='mb-4'>" +
        "<div class='detail-row'><span class='detail-label'>Day</span><span class='detail-value'>" + days[block.day] + ", " + dateInfo + "</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Time</span><span class='detail-value'>" + block.time + " - " + endTime + "</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Duration</span><span class='detail-value'>" + block.duration + " minutes</span></div>" +
        "<div class='detail-row'><span class='detail-label'>Reason</span><span class='detail-value'>" + block.reason + "</span></div>" +
        "</div>";
    
    if(hasWeeklyRecurrence || hasDailyRecurrence) {
        html += "<div class='recurring-badge' style='margin-bottom: 1rem;'>🔁 Recurring block</div>";
    }
    
    if(isSystemBlock && !isPast) {
        html += "<div class='info-box info-box-info' style='margin-bottom: 1rem;'>" +
            "<strong>Default Time Block</strong><br>" +
            "<span style='font-size: 0.8rem;'>This is a default blocked time. You can unblock it to allow scheduling.</span>" +
            "</div>";
    }
    
    if(!isPast) {
        html += "<p class='text-sm mb-4' style='color: var(--stone-500);'>Would you like to unblock this time?</p>";
        
        if(hasDailyRecurrence && matchingDaily.length > matchingWeekly.length) {
            // Has daily pattern (all 7 days)
            html += "<button onclick='confirmUnblockTime(" + blockId + ")' class='modal-btn modal-btn-primary'>" +
                "Unblock This Instance Only<br><span style='font-size: 0.8rem; opacity: 0.9;'>Just " + days[block.day] + ", " + dateInfo + "</span>" +
                "</button>" +
                "<button onclick='unblockAllWeekly(" + blockId + ")' class='modal-btn modal-btn-warning'>" +
                "Unblock Every " + days[block.day] + "<br><span style='font-size: 0.8rem; opacity: 0.9;'>(" + matchingWeekly.length + " future instances at " + block.time + ")</span>" +
                "</button>" +
                "<button onclick='unblockAllDaily(" + blockId + ")' class='modal-btn modal-btn-danger'>" +
                "Unblock Every Day at " + block.time + "<br><span style='font-size: 0.8rem; opacity: 0.9;'>(" + matchingDaily.length + " future instances, all days)</span>" +
                "</button>";
        } else if(hasWeeklyRecurrence) {
            // Has weekly pattern only
            html += "<button onclick='confirmUnblockTime(" + blockId + ")' class='modal-btn modal-btn-primary'>" +
                "Unblock This Instance Only<br><span style='font-size: 0.8rem; opacity: 0.9;'>Just " + days[block.day] + ", " + dateInfo + "</span>" +
                "</button>" +
                "<button onclick='unblockAllWeekly(" + blockId + ")' class='modal-btn modal-btn-danger'>" +
                "Unblock Every " + days[block.day] + " at " + block.time + "<br><span style='font-size: 0.8rem; opacity: 0.9;'>(" + matchingWeekly.length + " future instances)</span>" +
                "</button>";
        } else {
            // Single instance
            html += "<button onclick='confirmUnblockTime(" + blockId + ")' class='modal-btn modal-btn-danger'>Yes, Unblock This Time</button>";
        }
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function unblockAllWeekly(blockId) {
    const block = blockedTimes.find(b => b.id === blockId);
    if(!block) return;
    
    const countBefore = blockedTimes.length;
    
    // Remove all blocks with same day, time, duration, and reason
    blockedTimes = blockedTimes.filter(b => 
        !(b.time === block.time && 
          b.duration === block.duration && 
          b.reason === block.reason && 
          b.day === block.day)
    );
    
    const removed = countBefore - blockedTimes.length;
    closeModal();
    saveData();
    render();
    toast("Unblocked " + removed + " instances on " + days[block.day] + "s");
}

function unblockAllDaily(blockId) {
    const block = blockedTimes.find(b => b.id === blockId);
    if(!block) return;
    
    const countBefore = blockedTimes.length;
    
    // Remove all blocks with same time, duration, and reason (any day)
    blockedTimes = blockedTimes.filter(b => 
        !(b.time === block.time && 
          b.duration === block.duration && 
          b.reason === block.reason)
    );
    
    const removed = countBefore - blockedTimes.length;
    closeModal();
    saveData();
    render();
    toast("Unblocked " + removed + " instances at " + block.time);
}

function confirmUnblockTime(blockId) {
    const block = blockedTimes.find(b => b.id === blockId);
    blockedTimes = blockedTimes.filter(b => b.id !== blockId);
    closeModal();
    saveData();
    render();
    toast("Time unblocked: " + block.reason);
}

function handleCellClick(day, time) {
    if(isTimeInPast(currentWeek, day, time)) return;
    
    const hour = parseInt(time.split(':')[0]);
    const cellStartMinutes = hour * 60;
    const cellEndMinutes = (hour + 1) * 60;
    
    const hasLessons = lessons.some(l => l.day === day && l.week === currentWeek && l.time.startsWith(time.split(':')[0]));
    
    // Check if any block covers this cell (not just starts in this hour)
    const hasBlocks = blockedTimes.some(b => {
        if(b.day !== day || b.week !== currentWeek) return false;
        const blockStartHour = parseInt(b.time.split(':')[0]);
        const blockStartMinutes = parseInt(b.time.split(':')[1]);
        const blockTotalStartMinutes = blockStartHour * 60 + blockStartMinutes;
        const blockTotalEndMinutes = blockTotalStartMinutes + b.duration;
        // Block overlaps this cell if it starts before cell ends and ends after cell starts
        return blockTotalStartMinutes < cellEndMinutes && blockTotalEndMinutes > cellStartMinutes;
    });
    
    if(!hasLessons && !hasBlocks) {
        showCellActionChoice(day, time);
    }
}

function showCellActionChoice(day, time) {
    const dayName = days[day];
    const html = "<h3 class='modal-title'>What would you like to do?</h3>" +
        "<p class='mb-4' style='color: var(--stone-500);'>For <strong>" + dayName + " at " + time + "</strong></p>" +
        "<button onclick='showAddModalWithTime(" + day + ", \"" + time + "\")' class='modal-btn modal-btn-success'>📅 Add Lesson</button>" +
        "<button onclick='showQuickBlockModal(" + day + ", \"" + time + "\")' class='modal-btn modal-btn-warning'>🚫 Block Time</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function showAddModalWithTime(day, time) {
    closeModal();
    setTimeout(() => {
        showAddModal();
        document.getElementById('newDay').value = day;
        document.getElementById('newTime').value = time;
    }, 100);
}

function showQuickBlockModal(day, time) {
    const dayName = days[day];
    const html = "<h3 class='modal-title'>Block This Time?</h3>" +
        "<p class='mb-4' style='color: var(--stone-500);'>Block <strong>" + dayName + " at " + time + "</strong>?</p>" +
        "<label class='form-label'>Duration</label>" +
        "<select id='quickBlockDuration' class='form-select'>" +
        "<option value='30'>30 minutes</option>" +
        "<option value='60' selected>1 hour</option>" +
        "<option value='90'>1.5 hours</option>" +
        "<option value='120'>2 hours</option>" +
        "</select>" +
        "<label class='form-label'>Reason <span class='form-label-optional'>(Optional)</span></label>" +
        "<input id='quickBlockReason' placeholder='e.g., Lunch' class='form-input'>" +
        "<label class='form-label'>Apply to</label>" +
        "<select id='quickBlockRepeat' class='form-select'>" +
        "<option value='once'>This day only (one time)</option>" +
        "<option value='weekly'>Every week on " + dayName + "</option>" +
        "<option value='daily'>Every day at " + time + " (all 7 days, all weeks)</option>" +
        "</select>" +
        "<button onclick='saveQuickBlock(" + day + ", \"" + time + "\")' class='modal-btn modal-btn-warning'>Block Time</button>" +
        "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function saveQuickBlock(day, time) {
    const duration = parseInt(document.getElementById('quickBlockDuration').value);
    const reason = document.getElementById('quickBlockReason').value || 'Unavailable';
    const repeatType = document.getElementById('quickBlockRepeat').value;
    
    if(repeatType === 'daily') {
        // Block all 7 days at this time for all weeks
        for(let week = currentWeek; week <= currentWeek + 52; week++) {
            for(let d = 0; d < 7; d++) {
                blockedTimes.push({
                    id: nextBlockId++,
                    day: d,
                    time: time,
                    duration: duration,
                    reason: reason,
                    week: week
                });
            }
        }
        toast("Time blocked: " + reason + " (all days, all weeks)");
    } else if(repeatType === 'weekly') {
        // Block this day for all weeks
        for(let week = currentWeek; week <= currentWeek + 52; week++) {
            blockedTimes.push({
                id: nextBlockId++,
                day: day,
                time: time,
                duration: duration,
                reason: reason,
                week: week
            });
        }
        toast("Time blocked: " + reason + " (every " + days[day] + ")");
    } else {
        // Block only this one instance
        blockedTimes.push({
            id: nextBlockId++,
            day: day,
            time: time,
            duration: duration,
            reason: reason,
            week: currentWeek
        });
        toast("Time blocked: " + reason);
    }
    
    closeModal();
    render();
}

function applyQuickBlock(day, time, duration, reason, recurring) {
    if(recurring) {
        for(let week = currentWeek; week <= currentWeek + 52; week++) {
            blockedTimes.push({
                id: nextBlockId++,
                day: day,
                time: time,
                duration: duration,
                reason: reason,
                week: week
            });
        }
        toast("Time blocked: " + reason + " (all weeks)");
    } else {
        blockedTimes.push({
            id: nextBlockId++,
            day: day,
            time: time,
            duration: duration,
            reason: reason,
            week: currentWeek
        });
        toast("Time blocked: " + reason);
    }
    
    closeModal();
    render();
}

function showStudentsModal() {
    const studentList = getUniqueStudents();
    const activeStudents = studentList.filter(s => !s.retired);
    const retiredStudents = studentList.filter(s => s.retired);
    
    let html = "<h3 class='modal-title'>👥 Student Management</h3>";
    html += "<p class='modal-subtitle'>Manage your students and their schedules</p>";
    
    html += "<button onclick='showAddStudentModal()' class='modal-btn modal-btn-success'>+ Add New Student</button>";
    
    if(studentList.length === 0) {
        html += "<p style='color: var(--stone-500);'>No students yet. Add a student to get started.</p>";
    } else {
        html += "<div class='scroll-container' style='margin-top: 1rem;'>";
        
        if(activeStudents.length > 0) {
            activeStudents.forEach(student => {
                html += "<div class='student-card'>" +
                    "<div class='student-card-header'>" +
                    "<div>" +
                    "<div class='student-name-large'>" + student.firstName + " " + student.lastName + "</div>" +
                    "<div class='student-meta'>" + student.lessonCount + " total lessons • " + student.weeklyLessons + " this week</div>" +
                    "</div>" +
                    "<div class='student-actions'>" +
                    "<button onclick='viewStudentSchedule(\"" + student.firstName + "\",\"" + student.lastName + "\")' class='btn btn-small' style='background: var(--teal-500); color: white;'>View</button>" +
                    "<button onclick='retireStudent(\"" + student.firstName + "\",\"" + student.lastName + "\")' class='btn btn-small' style='background: var(--coral-500); color: white;'>Retire</button>" +
                    "</div>" +
                    "</div>" +
                    "</div>";
            });
        }
        
        if(retiredStudents.length > 0) {
            html += "<div class='section-divider'><div class='section-title'>Retired Students</div></div>";
            retiredStudents.forEach(student => {
                html += "<div class='student-card' style='opacity: 0.6; border-color: var(--stone-300);'>" +
                    "<div class='student-card-header'>" +
                    "<div>" +
                    "<div class='student-name-large' style='color: var(--stone-500);'>" + student.firstName + " " + student.lastName + " <span class='text-xs'>(Retired)</span></div>" +
                    "<div class='student-meta'>" + student.lessonCount + " total lessons</div>" +
                    "</div>" +
                    "<div class='student-actions'>" +
                    "<button onclick='viewStudentSchedule(\"" + student.firstName + "\",\"" + student.lastName + "\")' class='btn btn-small' style='background: var(--stone-500); color: white;'>View</button>" +
                    "<button onclick='unretireStudent(\"" + student.firstName + "\",\"" + student.lastName + "\")' class='btn btn-small' style='background: var(--emerald-500); color: white;'>Reactivate</button>" +
                    "</div>" +
                    "</div>" +
                    "</div>";
            });
        }
        
        html += "</div>";
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Close</button>";
    
    modal(html);
}

function getUniqueStudents() {
    const studentMap = new Map();
    
    studentProfiles.forEach(profile => {
        const key = profile.firstName + " " + profile.lastName;
        studentMap.set(key, {
            firstName: profile.firstName,
            lastName: profile.lastName,
            lessonCount: 0,
            weeklyLessons: 0,
            retired: profile.retired || false
        });
    });
    
    lessons.forEach(lesson => {
        const key = lesson.firstName + " " + lesson.lastName;
        if(!studentMap.has(key)) {
            studentMap.set(key, {
                firstName: lesson.firstName,
                lastName: lesson.lastName,
                lessonCount: 0,
                weeklyLessons: 0,
                retired: false
            });
        }
        const student = studentMap.get(key);
        student.lessonCount++;
        if(lesson.week === currentWeek) {
            student.weeklyLessons++;
        }
    });
    
    return Array.from(studentMap.values()).sort((a, b) => {
        if(a.retired !== b.retired) return a.retired ? 1 : -1;
        return (a.firstName + a.lastName).localeCompare(b.firstName + b.lastName);
    });
}

function viewStudentSchedule(firstName, lastName) {
    const studentLessons = lessons.filter(l => l.firstName === firstName && l.lastName === lastName);
    
    let profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    
    if(!profile) {
        profile = { firstName, lastName, dob: '', grade: '', school: '', street: '', city: '', state: '', zip: '', guardians: [], photo: '', retired: false };
    }
    
    // Convert old guardian format to guardians array for display
    let guardiansToShow = profile.guardians || [];
    if(guardiansToShow.length === 0) {
        // Fall back to old format
        if(profile.guardianName || profile.guardianPhone || profile.guardianEmail) {
            guardiansToShow.push({
                name: profile.guardianName || '',
                phone: profile.guardianPhone || '',
                email: profile.guardianEmail || ''
            });
        }
        if(profile.guardian2Name || profile.guardian2Phone || profile.guardian2Email) {
            guardiansToShow.push({
                name: profile.guardian2Name || '',
                phone: profile.guardian2Phone || '',
                email: profile.guardian2Email || ''
            });
        }
    }
    
    let html = "<h3 class='modal-title'>👤 " + firstName + " " + lastName + "</h3>";
    
    html += "<div style='display: flex; gap: 0.5rem; margin-bottom: 1rem;'>" +
        "<button onclick='scheduleStudentLesson(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-success' style='flex: 1; margin-bottom: 0;'>📅 Schedule</button>" +
        "<button onclick='editStudentProfile(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-primary' style='flex: 1; margin-bottom: 0;'>✏️ Edit</button>" +
        "</div>";
    
    html += "<div class='profile-section'>" +
        "<div class='profile-header'>";
    
    if(profile.photo) {
        html += "<img src='" + profile.photo + "' class='profile-photo' alt='Student photo'>";
    } else {
        html += "<div class='profile-photo-placeholder'>No photo</div>";
    }
    
    html += "<div style='flex: 1;'>" +
        "<div style='font-size: 0.8rem; color: var(--stone-500); margin-bottom: 0.5rem;'>Family Code</div>" +
        "<div class='family-code-display'>" + (profile.familyCode || 'Not set') + "</div>" +
        "</div></div>";
    
    html += "<div class='detail-row'><span class='detail-label'>Date of Birth</span><span class='detail-value'>" + (profile.dob || 'Not set') + "</span></div>";
    if(profile.grade) html += "<div class='detail-row'><span class='detail-label'>Grade</span><span class='detail-value'>" + profile.grade + "</span></div>";
    if(profile.school) html += "<div class='detail-row'><span class='detail-label'>School</span><span class='detail-value'>" + profile.school + "</span></div>";
    
    // Display address
    const hasAddress = profile.street || profile.city || profile.state || profile.zip;
    if(hasAddress) {
        let addressParts = [];
        if(profile.street) addressParts.push(profile.street);
        let cityStateZip = [];
        if(profile.city) cityStateZip.push(profile.city);
        if(profile.state && profile.zip) cityStateZip.push(profile.state + ' ' + profile.zip);
        else if(profile.state) cityStateZip.push(profile.state);
        else if(profile.zip) cityStateZip.push(profile.zip);
        if(cityStateZip.length > 0) addressParts.push(cityStateZip.join(', '));
        
        html += "<div class='detail-row'><span class='detail-label'>Address</span><span class='detail-value'>" + addressParts.join('<br>') + "</span></div>";
    }
    
    // Display all guardians
    if(guardiansToShow.length > 0) {
        html += "<div style='margin-top: 1rem;'>";
        guardiansToShow.forEach((guardian, index) => {
            if(guardian.name || guardian.phone || guardian.email) {
                const guardianLabel = guardiansToShow.length > 1 ? "Guardian " + (index + 1) : "Guardian";
                html += "<div style='margin-bottom: 0.75rem; padding: 0.75rem; background: var(--stone-50); border-radius: 8px;'>" +
                    "<div style='font-weight: 600; font-size: 0.75rem; color: var(--teal-600); margin-bottom: 0.25rem;'>👤 " + guardianLabel + "</div>";
                if(guardian.name) html += "<div style='font-size: 0.85rem; color: var(--stone-700);'>" + guardian.name + "</div>";
                if(guardian.phone) html += "<div style='font-size: 0.8rem; color: var(--stone-500);'>📞 " + guardian.phone + "</div>";
                if(guardian.email) html += "<div style='font-size: 0.8rem; color: var(--stone-500);'>✉️ " + guardian.email + "</div>";
                html += "</div>";
            }
        });
        html += "</div>";
    }
    
    html += "</div>";
    
    html += "<div class='section-title'>Schedule (" + studentLessons.length + " lessons)</div>";
    
    if(studentLessons.length === 0) {
        html += "<p style='color: var(--stone-500);'>No lessons scheduled</p>";
    } else {
        html += "<div class='scroll-container'>";
        
        const weekGroups = {};
        studentLessons.forEach(lesson => {
            if(!weekGroups[lesson.week]) weekGroups[lesson.week] = [];
            weekGroups[lesson.week].push(lesson);
        });
        
        Object.keys(weekGroups).sort((a, b) => parseInt(a) - parseInt(b)).forEach(week => {
            const weekNum = parseInt(week);
            let weekLabel = weekNum === 0 ? "This Week" : 
                           weekNum === 1 ? "Next Week" :
                           weekNum > 0 ? (weekNum + " Weeks Ahead") :
                           weekNum === -1 ? "Last Week" :
                           (Math.abs(weekNum) + " Weeks Ago");
            
            html += "<div style='margin-bottom: 0.75rem;'>" +
                "<div style='font-weight: 600; font-size: 0.8rem; color: var(--stone-700); margin-bottom: 0.25rem;'>" + weekLabel + "</div>";
            
            weekGroups[week].forEach(lesson => {
                const dateInfo = getDateForLesson(lesson);
                html += "<div style='font-size: 0.8rem; padding-left: 0.75rem; border-left: 2px solid var(--teal-400); margin-bottom: 0.25rem; color: var(--stone-600);'>" +
                    days[lesson.day] + ", " + dateInfo + " at " + lesson.time + " (" + lesson.duration + " min)" +
                    (lesson.isRecurring ? " 🔁" : "") +
                    "</div>";
            });
            html += "</div>";
        });
        
        html += "</div>";
    }
    
    html += "<button onclick='showStudentsModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Back to Students</button>";
    
    modal(html);
}

function editStudentProfile(firstName, lastName) {
    // Reset temp photo data
    tempPhotoData = null;
    
    let profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    
    if(!profile) {
        profile = { firstName, lastName, dob: '', grade: '', school: '', street: '', city: '', state: '', zip: '', guardians: [], photo: '', retired: false };
    }
    
    // Convert old guardian format to new guardians array if needed
    if(!profile.guardians) {
        profile.guardians = [];
        if(profile.guardianName || profile.guardianPhone || profile.guardianEmail) {
            profile.guardians.push({
                name: profile.guardianName || '',
                phone: profile.guardianPhone || '',
                email: profile.guardianEmail || ''
            });
        }
        if(profile.guardian2Name || profile.guardian2Phone || profile.guardian2Email) {
            profile.guardians.push({
                name: profile.guardian2Name || '',
                phone: profile.guardian2Phone || '',
                email: profile.guardian2Email || ''
            });
        }
    }
    
    // Ensure at least one guardian slot
    if(profile.guardians.length === 0) {
        profile.guardians.push({ name: '', phone: '', email: '' });
    }
    
    // Store current guardians for editing
    window.tempGuardians = JSON.parse(JSON.stringify(profile.guardians));
    
    // Photo preview HTML
    let photoHtml = "";
    if(profile.photo) {
        photoHtml = "<div class='photo-upload-preview'>" +
            "<img src='" + profile.photo + "' id='photoPreview' class='photo-preview-img'>" +
            "<button type='button' onclick='removeStudentPhoto(\"" + firstName + "\",\"" + lastName + "\")' class='photo-remove-btn'>✕ Remove</button>" +
            "</div>";
    } else {
        photoHtml = "<div class='photo-upload-preview'>" +
            "<div id='photoPreview' class='photo-placeholder'>📷<br><span style='font-size: 0.75rem;'>No photo</span></div>" +
            "</div>";
    }
    
    let html = "<h3 class='modal-title'>✏️ Edit Student Info</h3>" +
        "<p class='modal-subtitle'>" + firstName + " " + lastName + "</p>" +
        
        // Photo upload section
        "<div class='photo-upload-section'>" +
        photoHtml +
        "<div class='photo-upload-controls'>" +
        "<label class='form-label'>Student Photo</label>" +
        "<input type='file' id='photoInput' accept='image/*' onchange='previewStudentPhoto(this)' class='form-input' style='padding: 0.5rem;'>" +
        "<p style='font-size: 0.7rem; color: var(--stone-400); margin-top: 0.25rem;'>JPG, PNG, or GIF. Max 1MB recommended.</p>" +
        "</div>" +
        "</div>" +
        "<div class='section-divider'></div>" +
        
        "<label class='form-label'>Date of Birth</label>" +
        "<input type='date' id='editDob' value='" + (profile.dob || '') + "' class='form-input' oninput='generateEditFamilyCode(\"" + lastName + "\")' onchange='generateEditFamilyCode(\"" + lastName + "\")'>" +
        "<label class='form-label'>Grade <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='text' id='editGrade' value='" + (profile.grade || '') + "' placeholder='5th Grade, Junior, etc.' class='form-input'>" +
        "<label class='form-label'>School <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='text' id='editSchool' value='" + (profile.school || '') + "' placeholder='Lincoln Elementary' class='form-input'>" +
        "<div class='section-divider'></div>" +
        
        // Address section
        "<div class='section-title'>🏠 Address</div>" +
        "<label class='form-label'>Street Address <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='text' id='editStreet' value='" + (profile.street || '') + "' placeholder='123 Main Street' class='form-input'>" +
        "<label class='form-label'>City <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='text' id='editCity' value='" + (profile.city || '') + "' placeholder='Minneapolis' class='form-input'>" +
        "<div style='display: flex; gap: 0.75rem;'>" +
        "<div style='flex: 1;'>" +
        "<label class='form-label'>State <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='text' id='editState' value='" + (profile.state || '') + "' placeholder='MN' class='form-input' maxlength='2' style='text-transform: uppercase;'>" +
        "</div>" +
        "<div style='flex: 1;'>" +
        "<label class='form-label'>ZIP Code <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='text' id='editZip' value='" + (profile.zip || '') + "' placeholder='55401' class='form-input' maxlength='10'>" +
        "</div>" +
        "</div>" +
        "<div class='section-divider'></div>" +
        
        "<label class='form-label'>Family Code</label>" +
        "<input type='text' id='editFamilyCode' value='" + (profile.familyCode || '') + "' placeholder='SMITH2013' class='form-input' style='font-family: monospace; text-transform: uppercase;'>" +
        "<div class='section-divider'></div>" +
        "<div id='guardiansContainer'></div>" +
        "<button onclick='saveStudentProfile(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-primary'>Save</button>" +
        "<button onclick='viewStudentSchedule(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
    
    // Render guardians after modal is shown
    setTimeout(() => renderGuardiansEditor(), 50);
}

function renderGuardiansEditor() {
    const container = document.getElementById('guardiansContainer');
    if(!container) return;
    
    let html = "";
    
    window.tempGuardians.forEach((guardian, index) => {
        const guardianNum = index + 1;
        const isFirst = index === 0;
        
        html += "<div class='guardian-card' id='guardian-" + index + "'>" +
            "<div class='guardian-header'>" +
            "<div class='section-title'>👤 Parent/Guardian " + guardianNum + "</div>" +
            (!isFirst ? "<button type='button' onclick='removeGuardian(" + index + ")' class='btn-remove-guardian'>✕ Remove</button>" : "") +
            "</div>" +
            "<label class='form-label'>Name</label>" +
            "<input type='text' id='guardianName-" + index + "' value='" + escapeHtml(guardian.name || '') + "' placeholder='John Doe' class='form-input' onchange='updateGuardian(" + index + ", \"name\", this.value)'>" +
            "<label class='form-label'>Phone</label>" +
            "<input type='tel' id='guardianPhone-" + index + "' value='" + escapeHtml(guardian.phone || '') + "' placeholder='(555) 123-4567' class='form-input' onchange='updateGuardian(" + index + ", \"phone\", this.value)'>" +
            "<label class='form-label'>Email</label>" +
            "<input type='email' id='guardianEmail-" + index + "' value='" + escapeHtml(guardian.email || '') + "' placeholder='parent@example.com' class='form-input' onchange='updateGuardian(" + index + ", \"email\", this.value)'>" +
            "</div>";
    });
    
    // Add guardian button (if less than 5)
    if(window.tempGuardians.length < 5) {
        html += "<button type='button' onclick='addGuardian()' class='btn-add-guardian'>+ Add Another Parent/Guardian</button>";
    } else {
        html += "<p style='font-size: 0.8rem; color: var(--stone-500); text-align: center; margin: 1rem 0;'>Maximum of 5 guardians reached</p>";
    }
    
    container.innerHTML = html;
}

function escapeHtml(str) {
    if(!str) return '';
    return str.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
}

function addGuardian() {
    if(window.tempGuardians.length >= 5) {
        toast("Maximum of 5 guardians allowed");
        return;
    }
    window.tempGuardians.push({ name: '', phone: '', email: '' });
    renderGuardiansEditor();
}

function removeGuardian(index) {
    if(window.tempGuardians.length <= 1) {
        toast("At least one guardian is required");
        return;
    }
    window.tempGuardians.splice(index, 1);
    renderGuardiansEditor();
}

function updateGuardian(index, field, value) {
    if(window.tempGuardians[index]) {
        window.tempGuardians[index][field] = value;
    }
}

// Temporary storage for photo during editing
let tempPhotoData = null;

function previewStudentPhoto(input) {
    const file = input.files[0];
    if(!file) return;
    
    // Check file size (warn if over 1MB)
    if(file.size > 1024 * 1024) {
        if(!confirm('This image is larger than 1MB and may slow down the app. Continue anyway?')) {
            input.value = '';
            return;
        }
    }
    
    // Check file type
    if(!file.type.startsWith('image/')) {
        toast('Please select an image file');
        input.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        tempPhotoData = e.target.result;
        
        const preview = document.getElementById('photoPreview');
        if(preview) {
            // Replace placeholder or update existing image
            const container = preview.parentElement;
            container.innerHTML = "<img src='" + tempPhotoData + "' id='photoPreview' class='photo-preview-img'>" +
                "<button type='button' onclick='clearPhotoPreview()' class='photo-remove-btn'>✕ Remove</button>";
        }
    };
    reader.readAsDataURL(file);
}

function clearPhotoPreview() {
    tempPhotoData = '';  // Empty string means remove photo
    const preview = document.getElementById('photoPreview');
    if(preview) {
        const container = preview.parentElement;
        container.innerHTML = "<div id='photoPreview' class='photo-placeholder'>📷<br><span style='font-size: 0.75rem;'>No photo</span></div>";
    }
    const input = document.getElementById('photoInput');
    if(input) input.value = '';
}

function removeStudentPhoto(firstName, lastName) {
    tempPhotoData = '';  // Mark for removal
    clearPhotoPreview();
}

function generateEditFamilyCode(lastName) {
    const dobInput = document.getElementById('editDob');
    const codeInput = document.getElementById('editFamilyCode');
    
    if(!dobInput || !codeInput) return;
    
    const dob = dobInput.value;
    if(lastName && dob) {
        const year = dob.split('-')[0];
        codeInput.value = lastName.toUpperCase() + year;
    }
}

function saveStudentProfile(firstName, lastName) {
    let profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    
    if(!profile) {
        profile = { firstName, lastName };
        studentProfiles.push(profile);
    }
    
    profile.dob = document.getElementById('editDob').value;
    profile.grade = document.getElementById('editGrade').value;
    profile.school = document.getElementById('editSchool').value;
    profile.familyCode = document.getElementById('editFamilyCode').value.trim().toUpperCase();
    
    // Save address fields
    profile.street = document.getElementById('editStreet').value.trim();
    profile.city = document.getElementById('editCity').value.trim();
    profile.state = document.getElementById('editState').value.trim().toUpperCase();
    profile.zip = document.getElementById('editZip').value.trim();
    
    // Save guardians array
    profile.guardians = window.tempGuardians || [];
    
    // Also maintain backwards compatibility with old guardian fields
    if(profile.guardians.length > 0) {
        profile.guardianName = profile.guardians[0].name || '';
        profile.guardianPhone = profile.guardians[0].phone || '';
        profile.guardianEmail = profile.guardians[0].email || '';
    }
    if(profile.guardians.length > 1) {
        profile.guardian2Name = profile.guardians[1].name || '';
        profile.guardian2Phone = profile.guardians[1].phone || '';
        profile.guardian2Email = profile.guardians[1].email || '';
    }
    
    // Handle photo update
    if(tempPhotoData !== null) {
        profile.photo = tempPhotoData;  // Could be base64 data or empty string to remove
        tempPhotoData = null;  // Reset temp storage
    }
    
    saveData();
    toast("Profile updated!");
    viewStudentSchedule(firstName, lastName);
}

function showAddStudentModal() {
    // Initialize temp guardians for new student
    window.tempGuardians = [{ name: '', phone: '', email: '' }];
    
    const html = "<h3 class='modal-title'>➕ Add New Student</h3>" +
        "<label class='form-label'>First Name</label>" +
        "<input type='text' id='newStudentFirst' placeholder='Emma' class='form-input'>" +
        "<label class='form-label'>Last Name</label>" +
        "<input type='text' id='newStudentLast' placeholder='Smith' class='form-input' oninput='generateFamilyCode()' onchange='generateFamilyCode()'>" +
        "<label class='form-label'>Date of Birth</label>" +
        "<input type='date' id='newStudentDob' class='form-input' oninput='generateFamilyCode()' onchange='generateFamilyCode()'>" +
        "<label class='form-label'>Family Code</label>" +
        "<input type='text' id='newStudentFamilyCode' placeholder='SMITH2013' class='form-input' style='font-family: monospace; text-transform: uppercase;'>" +
        "<div class='section-divider'></div>" +
        
        // Address section
        "<div class='section-title'>🏠 Address <span class='form-label-optional'>(Optional)</span></div>" +
        "<label class='form-label'>Street Address</label>" +
        "<input type='text' id='newStudentStreet' placeholder='123 Main Street' class='form-input'>" +
        "<label class='form-label'>City</label>" +
        "<input type='text' id='newStudentCity' placeholder='Minneapolis' class='form-input'>" +
        "<div style='display: flex; gap: 0.75rem;'>" +
        "<div style='flex: 1;'>" +
        "<label class='form-label'>State</label>" +
        "<input type='text' id='newStudentState' placeholder='MN' class='form-input' maxlength='2' style='text-transform: uppercase;'>" +
        "</div>" +
        "<div style='flex: 1;'>" +
        "<label class='form-label'>ZIP Code</label>" +
        "<input type='text' id='newStudentZip' placeholder='55401' class='form-input' maxlength='10'>" +
        "</div>" +
        "</div>" +
        "<div class='section-divider'></div>" +
        
        "<div id='newStudentGuardiansContainer'></div>" +
        "<button onclick='saveNewStudent()' class='modal-btn modal-btn-success'>Create Student</button>" +
        "<button onclick='showStudentsModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
    
    // Render guardians after modal is shown
    setTimeout(() => renderNewStudentGuardians(), 50);
}

function renderNewStudentGuardians() {
    const container = document.getElementById('newStudentGuardiansContainer');
    if(!container) return;
    
    let html = "";
    
    window.tempGuardians.forEach((guardian, index) => {
        const guardianNum = index + 1;
        const isFirst = index === 0;
        
        html += "<div class='guardian-card' id='new-guardian-" + index + "'>" +
            "<div class='guardian-header'>" +
            "<div class='section-title'>👤 Parent/Guardian " + guardianNum + "</div>" +
            (!isFirst ? "<button type='button' onclick='removeNewGuardian(" + index + ")' class='btn-remove-guardian'>✕ Remove</button>" : "") +
            "</div>" +
            "<label class='form-label'>Name</label>" +
            "<input type='text' id='newGuardianName-" + index + "' value='" + escapeHtml(guardian.name || '') + "' placeholder='John Doe' class='form-input' onchange='updateNewGuardian(" + index + ", \"name\", this.value)'>" +
            "<label class='form-label'>Phone</label>" +
            "<input type='tel' id='newGuardianPhone-" + index + "' value='" + escapeHtml(guardian.phone || '') + "' placeholder='(555) 123-4567' class='form-input' onchange='updateNewGuardian(" + index + ", \"phone\", this.value)'>" +
            "<label class='form-label'>Email</label>" +
            "<input type='email' id='newGuardianEmail-" + index + "' value='" + escapeHtml(guardian.email || '') + "' placeholder='parent@example.com' class='form-input' onchange='updateNewGuardian(" + index + ", \"email\", this.value)'>" +
            "</div>";
    });
    
    // Add guardian button (if less than 5)
    if(window.tempGuardians.length < 5) {
        html += "<button type='button' onclick='addNewGuardian()' class='btn-add-guardian'>+ Add Another Parent/Guardian</button>";
    } else {
        html += "<p style='font-size: 0.8rem; color: var(--stone-500); text-align: center; margin: 1rem 0;'>Maximum of 5 guardians reached</p>";
    }
    
    container.innerHTML = html;
}

function addNewGuardian() {
    if(window.tempGuardians.length >= 5) {
        toast("Maximum of 5 guardians allowed");
        return;
    }
    window.tempGuardians.push({ name: '', phone: '', email: '' });
    renderNewStudentGuardians();
}

function removeNewGuardian(index) {
    if(window.tempGuardians.length <= 1) {
        toast("At least one guardian is required");
        return;
    }
    window.tempGuardians.splice(index, 1);
    renderNewStudentGuardians();
}

function updateNewGuardian(index, field, value) {
    if(window.tempGuardians[index]) {
        window.tempGuardians[index][field] = value;
    }
}

function generateFamilyCode() {
    const lastNameInput = document.getElementById('newStudentLast');
    const dobInput = document.getElementById('newStudentDob');
    const codeInput = document.getElementById('newStudentFamilyCode');
    
    if(!lastNameInput || !dobInput || !codeInput) return;
    
    const lastName = lastNameInput.value.trim().toUpperCase();
    const dob = dobInput.value;
    
    if(lastName && dob) {
        const year = dob.split('-')[0];
        codeInput.value = lastName + year;
    } else if(lastName) {
        // Show partial code with placeholder year
        codeInput.value = lastName + 'YYYY';
    }
}

function saveNewStudent() {
    const firstName = document.getElementById('newStudentFirst').value.trim();
    const lastName = document.getElementById('newStudentLast').value.trim();
    
    if(!firstName || !lastName) {
        toast("First and last name are required");
        return;
    }
    
    const exists = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    if(exists) {
        toast("Student already exists");
        return;
    }
    
    const familyCode = document.getElementById('newStudentFamilyCode').value.trim().toUpperCase();
    if(!familyCode) {
        toast("Family code is required");
        return;
    }
    
    const codeExists = studentProfiles.find(p => p.familyCode === familyCode);
    if(codeExists) {
        toast("Family code already in use");
        return;
    }
    
    // Build guardians array from temp data
    const guardians = window.tempGuardians || [];
    
    const newProfile = {
        firstName,
        lastName,
        familyCode,
        dob: document.getElementById('newStudentDob').value,
        street: document.getElementById('newStudentStreet').value.trim(),
        city: document.getElementById('newStudentCity').value.trim(),
        state: document.getElementById('newStudentState').value.trim().toUpperCase(),
        zip: document.getElementById('newStudentZip').value.trim(),
        guardians: guardians,
        photo: "",
        retired: false
    };
    
    // Also set backwards-compatible fields
    if(guardians.length > 0) {
        newProfile.guardianName = guardians[0].name || '';
        newProfile.guardianPhone = guardians[0].phone || '';
        newProfile.guardianEmail = guardians[0].email || '';
    }
    if(guardians.length > 1) {
        newProfile.guardian2Name = guardians[1].name || '';
        newProfile.guardian2Phone = guardians[1].phone || '';
        newProfile.guardian2Email = guardians[1].email || '';
    }
    
    studentProfiles.push(newProfile);
    saveData();
    
    toast("Student " + firstName + " " + lastName + " added");
    showStudentsModal();
}

function scheduleStudentLesson(firstName, lastName) {
    const html = "<h3 class='modal-title'>📅 Schedule Lesson</h3>" +
        "<p class='modal-subtitle'>For: <strong>" + firstName + " " + lastName + "</strong></p>" +
        "<label class='form-label'>Day</label>" +
        "<select id='newDay' class='form-select'>" +
        days.map((d,i) => "<option value='" + i + "'>" + d + "</option>").join("") + "</select>" +
        "<label class='form-label'>Time</label>" +
        "<select id='newTime' class='form-select'>" +
        detailedTimes.map(t => "<option value='" + t + "'>" + t + "</option>").join("") + "</select>" +
        "<label class='form-label'>Duration</label>" +
        "<select id='newDuration' class='form-select'>" +
        "<option value='30'>30 minutes</option><option value='45'>45 minutes</option><option value='60' selected>60 minutes</option></select>" +
        "<label class='form-checkbox'>" +
        "<input type='checkbox' id='newRecurring' checked onchange='toggleEndDate()'>" +
        "<span>Recurring weekly</span>" +
        "</label>" +
        "<div id='endDateSection'>" +
        "<label class='form-label'>Repeat until <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='date' id='endDate' class='form-input'>" +
        "</div>" +
        "<input type='hidden' id='newFirst' value='" + firstName + "'>" +
        "<input type='hidden' id='newLast' value='" + lastName + "'>" +
        "<button onclick='saveNew()' class='modal-btn modal-btn-success'>Schedule</button>" +
        "<button onclick='viewStudentSchedule(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function getDateForLesson(lesson) {
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (lesson.week * 7));
    const lessonDate = new Date(startOfWeek);
    lessonDate.setDate(startOfWeek.getDate() + lesson.day);
    return (lessonDate.getMonth() + 1) + '/' + lessonDate.getDate() + '/' + lessonDate.getFullYear();
}

function retireStudent(firstName, lastName) {
    const allLessons = lessons.filter(l => l.firstName === firstName && l.lastName === lastName);
    const futureLessons = allLessons.filter(l => l.week >= currentWeek);
    
    const html = "<h3 class='modal-title' style='color: var(--coral-500);'>Retire Student?</h3>" +
        "<p class='mb-4'>Retire <strong>" + firstName + " " + lastName + "</strong>?</p>" +
        "<div class='info-box info-box-warning'>" +
        "<p><strong>This will:</strong></p>" +
        "<p>• Remove " + futureLessons.length + " future lessons</p>" +
        "<p>• Keep past lessons as history</p>" +
        "<p>• Move student to 'Retired' section</p>" +
        "</div>" +
        "<div class='info-box info-box-success'>You can reactivate this student anytime.</div>" +
        "<button onclick='confirmRetireStudent(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-warning'>Retire Student</button>" +
        "<button onclick='showStudentsModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function confirmRetireStudent(firstName, lastName) {
    const beforeCount = lessons.length;
    lessons = lessons.filter(l => !(l.firstName === firstName && l.lastName === lastName && l.week >= currentWeek));
    const deletedCount = beforeCount - lessons.length;
    
    let profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    if(!profile) {
        profile = { firstName, lastName, retired: true };
        studentProfiles.push(profile);
    } else {
        profile.retired = true;
    }
    
    toast("Retired " + firstName + " " + lastName + " (" + deletedCount + " lessons removed)");
    showStudentsModal();
    render();
}

function unretireStudent(firstName, lastName) {
    let profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    if(profile) {
        profile.retired = false;
        toast(firstName + " " + lastName + " reactivated");
        showStudentsModal();
    }
}

// ============ STUDENT SWAP FUNCTIONS ============

function showMyLessonsForSwap() {
    if(!loggedInStudent) return;
    
    const firstName = loggedInStudent.firstName;
    const lastName = loggedInStudent.lastName;
    const fullName = firstName + " " + lastName;
    
    const myLessons = lessons.filter(l => 
        l.firstName === firstName && l.lastName === lastName && !isInPast(l.week, l.day)
    ).sort((a, b) => {
        if(a.week !== b.week) return a.week - b.week;
        if(a.day !== b.day) return a.day - b.day;
        return a.time.localeCompare(b.time);
    });
    
    const incomingRequests = swapRequests.filter(r => r.status === 'pending' && r.targetStudent === fullName);
    const outgoingPending = swapRequests.filter(r => r.status === 'pending' && r.requestingStudent === fullName);
    const awaitingTeacher = swapRequests.filter(r => r.status === 'student_agreed' && (r.requestingStudent === fullName || r.targetStudent === fullName));
    
    let html = "<h3 class='modal-title'>🔄 Request Swap</h3>" +
        "<p class='modal-subtitle'>Select one of your lessons to swap</p>";
    
    // Show swaps awaiting teacher approval
    if(awaitingTeacher.length > 0) {
        html += "<div class='info-box info-box-info' style='background: var(--teal-50); border-color: var(--teal-300);'>" +
            "<strong style='color: var(--teal-700);'>✋ " + awaitingTeacher.length + " Swap" + (awaitingTeacher.length > 1 ? "s" : "") + " Awaiting Teacher Approval</strong>" +
            "<p style='font-size: 0.8rem; margin-top: 0.25rem; color: var(--teal-600);'>Both students agreed. Waiting for teacher to approve.</p>" +
            "</div>";
    }
    
    if(incomingRequests.length > 0) {
        html += "<div class='info-box info-box-warning'>" +
            "<strong>⚠️ " + incomingRequests.length + " Swap Request" + (incomingRequests.length > 1 ? "s" : "") + " Waiting</strong>" +
            "</div>";
        
        incomingRequests.forEach(request => {
            const theirLesson = lessons.find(l => l.id === request.requestingLessonId);
            const myLesson = lessons.find(l => l.id === request.targetLessonId);
            if(!theirLesson || !myLesson) return;
            
            const theirName = formatNamePrivate(theirLesson.firstName, theirLesson.lastName);
            
            html += "<div class='swap-request-card'>" +
                "<div class='text-sm mb-2'><strong>" + theirName + "</strong> wants to swap:</div>" +
                "<div class='text-xs' style='color: var(--stone-600);'>Their: " + formatLessonDate(theirLesson.week, theirLesson.day) + " at " + theirLesson.time + "</div>" +
                "<div class='swap-arrow'>⬍</div>" +
                "<div class='text-xs' style='color: var(--stone-600);'>Your: " + formatLessonDate(myLesson.week, myLesson.day) + " at " + myLesson.time + "</div>";
            
            if(request.reason) {
                html += "<div style='margin-top: 0.75rem; padding: 0.6rem 0.75rem; background: var(--violet-50); border: 1px solid var(--violet-300); border-radius: 8px;'>" +
                    "<div style='font-size: 0.7rem; font-weight: 600; color: var(--violet-700); margin-bottom: 0.2rem;'>💬 Reason</div>" +
                    "<div style='font-size: 0.8rem; color: var(--stone-700);'>" + request.reason + "</div>" +
                    "</div>";
            }
            
            html += "<div style='display: flex; gap: 0.5rem; margin-top: 0.75rem;'>" +
                "<button onclick='approveSwapInPortal(" + request.id + ",\"" + firstName + "\",\"" + lastName + "\")' class='btn btn-small' style='flex: 1; background: var(--emerald-500); color: white;'>✓ Accept</button>" +
                "<button onclick='showDeclineSwapModal(" + request.id + ",\"" + firstName + "\",\"" + lastName + "\")' class='btn btn-small' style='flex: 1; background: var(--rose-500); color: white;'>✗ Decline</button>" +
                "</div>" +
                "</div>";
        });
    }
    
    if(outgoingPending.length > 0) {
        html += "<div class='info-box info-box-info'>" +
            "<strong>📤 " + outgoingPending.length + " pending request" + (outgoingPending.length > 1 ? "s" : "") + " awaiting other student's response</strong>" +
            "</div>";
        
        outgoingPending.forEach(request => {
            const theirLesson = lessons.find(l => l.id === request.targetLessonId);
            const myLesson = lessons.find(l => l.id === request.requestingLessonId);
            if(!theirLesson || !myLesson) return;
            
            const theirName = formatNamePrivate(theirLesson.firstName, theirLesson.lastName);
            
            html += "<div class='swap-request-card' style='opacity: 0.85;'>" +
                "<div class='text-sm mb-2'>Sent to <strong>" + theirName + "</strong></div>" +
                "<div class='text-xs' style='color: var(--stone-600);'>Your: " + formatLessonDate(myLesson.week, myLesson.day) + " at " + myLesson.time + "</div>" +
                "<div class='swap-arrow'>⬍</div>" +
                "<div class='text-xs' style='color: var(--stone-600);'>Their: " + formatLessonDate(theirLesson.week, theirLesson.day) + " at " + theirLesson.time + "</div>";
            
            if(request.reason) {
                html += "<div style='margin-top: 0.5rem; font-size: 0.75rem; color: var(--stone-500);'>💬 Your reason: " + request.reason + "</div>";
            }
            
            html += "<div style='margin-top: 0.5rem; font-size: 0.7rem; color: var(--stone-400);'>⏳ Waiting for response...</div>" +
                "</div>";
        });
    }
    
    html += "<div class='section-title' style='margin-top: 1rem;'>Your Upcoming Lessons (" + myLessons.length + ")</div>";
    
    if(myLessons.length === 0) {
        html += "<p style='color: var(--stone-500);'>No upcoming lessons scheduled.</p>";
    } else {
        html += "<div class='scroll-container'>";
        myLessons.forEach(lesson => {
            const tooSoon = isLessonTooSoon(lesson.week, lesson.day, lesson.time);
            
            if(tooSoon) {
                html += "<div class='lesson-list-item' style='opacity: 0.45; cursor: not-allowed;'>" +
                    "<div>" +
                    "<div class='lesson-list-time'>" + formatLessonDate(lesson.week, lesson.day) + " at " + lesson.time + "</div>" +
                    "<div class='lesson-list-duration'>" + lesson.duration + " min • ⏳ Too soon to swap</div>" +
                    "</div>" +
                    "</div>";
            } else {
                html += "<div class='lesson-list-item' onclick='showStudentSwapOptions(" + lesson.id + ",\"" + firstName + "\",\"" + lastName + "\")'>" +
                    "<div>" +
                    "<div class='lesson-list-time'>" + formatLessonDate(lesson.week, lesson.day) + " at " + lesson.time + "</div>" +
                    "<div class='lesson-list-duration'>" + lesson.duration + " min" + (lesson.isRecurring ? " • 🔁 Recurring" : "") + "</div>" +
                    "</div>" +
                    "<span style='color: var(--violet-500); font-weight: 600;'>→</span>" +
                    "</div>";
            }
        });
        html += "</div>";
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Close</button>";
    
    modal(html);
}

function showMyLessonsForReschedule() {
    if(!loggedInStudent) return;
    
    const firstName = loggedInStudent.firstName;
    const lastName = loggedInStudent.lastName;
    const fullName = firstName + " " + lastName;
    
    const myLessons = lessons.filter(l => 
        l.firstName === firstName && l.lastName === lastName && !isInPast(l.week, l.day)
    ).sort((a, b) => {
        if(a.week !== b.week) return a.week - b.week;
        if(a.day !== b.day) return a.day - b.day;
        return a.time.localeCompare(b.time);
    });
    
    // Check for pending reschedule requests
    const pendingRequests = moveRequests.filter(r => 
        r.status === 'pending' && r.studentName === fullName
    );
    
    let html = "<h3 class='modal-title'>📩 Request Reschedule</h3>" +
        "<p class='modal-subtitle'>Ask your teacher to find a new time</p>";
    
    // Show pending requests
    if(pendingRequests.length > 0) {
        html += "<div class='info-box info-box-warning'>" +
            "<strong>⏳ " + pendingRequests.length + " Pending Request" + (pendingRequests.length > 1 ? "s" : "") + "</strong>" +
            "<p style='font-size: 0.8rem; margin-top: 0.25rem;'>Waiting for teacher to respond.</p>" +
            "</div>";
        
        pendingRequests.forEach(request => {
            const lesson = lessons.find(l => l.id === request.lessonId);
            if(!lesson) return;
            
            html += "<div class='info-box info-box-info' style='padding: 0.75rem; margin-bottom: 0.5rem;'>" +
                "<div style='font-size: 0.85rem;'><strong>" + days[request.currentDay] + " at " + request.currentTime + "</strong></div>" +
                "<div style='font-size: 0.75rem; color: var(--stone-500); margin-top: 0.25rem;'>Reason: " + (request.reason || 'Not specified') + "</div>" +
                "<button onclick='cancelMoveRequest(" + request.id + ")' class='btn btn-small' style='margin-top: 0.5rem; background: var(--rose-500); color: white;'>Cancel Request</button>" +
                "</div>";
        });
    }
    
    html += "<div class='section-title' style='margin-top: 1rem;'>Your Upcoming Lessons (" + myLessons.length + ")</div>";
    
    if(myLessons.length === 0) {
        html += "<p style='color: var(--stone-500);'>No upcoming lessons scheduled.</p>";
    } else {
        html += "<div class='scroll-container'>";
        myLessons.forEach(lesson => {
            // Check if there's already a pending request for this lesson
            const hasPending = moveRequests.find(r => r.lessonId === lesson.id && r.status === 'pending');
            const tooSoon = isLessonTooSoon(lesson.week, lesson.day, lesson.time);
            
            if(hasPending) {
                html += "<div class='lesson-list-item' style='opacity: 0.45; cursor: not-allowed;'>" +
                    "<div>" +
                    "<div class='lesson-list-time'>" + formatLessonDate(lesson.week, lesson.day) + " at " + lesson.time + "</div>" +
                    "<div class='lesson-list-duration'>" + lesson.duration + " min • ⏳ Request pending</div>" +
                    "</div>" +
                    "</div>";
            } else if(tooSoon) {
                html += "<div class='lesson-list-item' style='opacity: 0.45; cursor: not-allowed;'>" +
                    "<div>" +
                    "<div class='lesson-list-time'>" + formatLessonDate(lesson.week, lesson.day) + " at " + lesson.time + "</div>" +
                    "<div class='lesson-list-duration'>" + lesson.duration + " min • ⏳ Too soon to reschedule</div>" +
                    "</div>" +
                    "</div>";
            } else {
                html += "<div class='lesson-list-item' onclick='showRequestTeacherReschedule(" + lesson.id + ")'>" +
                    "<div>" +
                    "<div class='lesson-list-time'>" + formatLessonDate(lesson.week, lesson.day) + " at " + lesson.time + "</div>" +
                    "<div class='lesson-list-duration'>" + lesson.duration + " min" + (lesson.isRecurring ? " • 🔁 Recurring" : "") + "</div>" +
                    "</div>" +
                    "<span style='color: var(--amber-500); font-weight: 600;'>→</span>" +
                    "</div>";
            }
        });
        html += "</div>";
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Close</button>";
    
    modal(html);
}

function canSwapFitSchedule(myLesson, theirLesson) {
    // When swapping: my lesson goes to their day/time (with my duration)
    //                their lesson goes to my day/time (with their duration)
    // If same duration, always fits (clean swap).
    if(myLesson.duration === theirLesson.duration) return true;
    
    const week = myLesson.week;
    
    // Check: can my lesson (my duration) fit at their day/time?
    // Exclude their lesson (it's moving away) and exclude my lesson
    const myAtTheirSlotStart = timeToMinutes(theirLesson.time);
    const myAtTheirSlotEnd = myAtTheirSlotStart + myLesson.duration;
    
    const conflictsAtTheirSlot = lessons.some(l => {
        if(l.id === theirLesson.id || l.id === myLesson.id) return false;
        if(l.day !== theirLesson.day || l.week !== week) return false;
        const lStart = timeToMinutes(l.time);
        const lEnd = lStart + l.duration;
        return myAtTheirSlotStart < lEnd && myAtTheirSlotEnd > lStart;
    });
    
    if(conflictsAtTheirSlot) return false;
    
    // Check blocked times at their slot for my duration
    const blockedAtTheirSlot = blockedTimes.some(b => {
        if(b.day !== theirLesson.day || b.week !== week) return false;
        const bStart = timeToMinutes(b.time);
        const bEnd = bStart + b.duration;
        return myAtTheirSlotStart < bEnd && myAtTheirSlotEnd > bStart;
    });
    
    if(blockedAtTheirSlot) return false;
    
    // Check: can their lesson (their duration) fit at my day/time?
    // Exclude my lesson (it's moving away) and exclude their lesson
    const theirAtMySlotStart = timeToMinutes(myLesson.time);
    const theirAtMySlotEnd = theirAtMySlotStart + theirLesson.duration;
    
    const conflictsAtMySlot = lessons.some(l => {
        if(l.id === myLesson.id || l.id === theirLesson.id) return false;
        if(l.day !== myLesson.day || l.week !== week) return false;
        const lStart = timeToMinutes(l.time);
        const lEnd = lStart + l.duration;
        return theirAtMySlotStart < lEnd && theirAtMySlotEnd > lStart;
    });
    
    if(conflictsAtMySlot) return false;
    
    // Check blocked times at my slot for their duration
    const blockedAtMySlot = blockedTimes.some(b => {
        if(b.day !== myLesson.day || b.week !== week) return false;
        const bStart = timeToMinutes(b.time);
        const bEnd = bStart + b.duration;
        return theirAtMySlotStart < bEnd && theirAtMySlotEnd > bStart;
    });
    
    if(blockedAtMySlot) return false;
    
    return true;
}

function showStudentSwapOptions(lessonId, firstName, lastName) {
    const myLesson = lessons.find(l => l.id === lessonId);
    
    const availableLessons = lessons.filter(l => {
        if(l.id === lessonId) return false;
        if(l.firstName === myLesson.firstName && l.lastName === myLesson.lastName) return false;
        if(isInPast(l.week, l.day)) return false;
        if(isLessonTooSoon(l.week, l.day, l.time)) return false;
        if(l.week !== myLesson.week && !l.isRecurring) return false;
        // Check if swap would fit in the schedule
        if(!canSwapFitSchedule(myLesson, l)) return false;
        return true;
    });
    
    if(availableLessons.length === 0) {
        modal("<h3 class='modal-title'>🔄 Request Swap</h3>" +
            "<p>No compatible lessons available to swap with at this time.</p>" +
            "<div class='info-box info-box-info' style='margin-top: 0.75rem;'>Only lessons with the same duration, or where the schedule has enough open time to accommodate different durations, are shown.</div>" +
            "<button onclick='showMyLessonsForSwap()' class='modal-btn modal-btn-secondary'>Back</button>");
        return;
    }
    
    let html = "<h3 class='modal-title'>🔄 Request Swap</h3>" +
        "<p class='modal-subtitle'>Your lesson: " + formatLessonDate(myLesson.week, myLesson.day) + " at " + myLesson.time + " (" + myLesson.duration + " min)</p>" +
        "<div class='section-title'>Possible new times</div>" +
        "<div class='scroll-container'>";
    
    availableLessons.forEach(lesson => {
        const otherName = formatNamePrivate(lesson.firstName, lesson.lastName);
        const durationNote = lesson.duration !== myLesson.duration ? " • " + lesson.duration + " min slot" : "";
        
        html += "<div class='student-card' onclick='confirmStudentSwapRequest(" + lessonId + "," + lesson.id + ",\"" + firstName + "\",\"" + lastName + "\")'>" +
            "<div class='student-name-large'>" + otherName + "</div>" +
            "<div class='student-meta'>" + formatLessonDate(lesson.week, lesson.day) + " at " + lesson.time + " (" + lesson.duration + " min)" + durationNote + (lesson.isRecurring ? " 🔁" : "") + "</div>" +
            "</div>";
    });
    
    html += "</div>" +
        "<button onclick='showMyLessonsForSwap()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Cancel</button>";
    
    modal(html);
}

function confirmStudentSwapRequest(myLessonId, theirLessonId, firstName, lastName) {
    const myLesson = lessons.find(l => l.id === myLessonId);
    const theirLesson = lessons.find(l => l.id === theirLessonId);
    const theirName = formatNamePrivate(theirLesson.firstName, theirLesson.lastName);
    
    const html = "<h3 class='modal-title'>🔄 Confirm Swap Request</h3>" +
        "<div class='profile-section'>" +
        "<div class='text-sm mb-2'><strong>You want to swap:</strong></div>" +
        "<div style='padding-left: 1rem; margin-bottom: 0.75rem;'>" +
        "<div class='text-sm'><strong>Your lesson</strong></div>" +
        "<div class='text-xs' style='color: var(--stone-600);'>" + formatLessonDate(myLesson.week, myLesson.day) + " at " + myLesson.time + "</div>" +
        "</div>" +
        "<div class='swap-arrow'>⬍</div>" +
        "<div style='padding-left: 1rem;'>" +
        "<div class='text-sm'><strong>" + theirName + "</strong></div>" +
        "<div class='text-xs' style='color: var(--stone-600);'>" + formatLessonDate(theirLesson.week, theirLesson.day) + " at " + theirLesson.time + "</div>" +
        "</div>" +
        "</div>" +
        "<label class='form-label'>Reason for swap request <span style='color: var(--rose-500);'>*</span></label>" +
        "<textarea id='swapReason' class='form-input' style='resize: vertical; min-height: 70px;' placeholder='e.g., I have a dentist appointment, soccer practice conflict, family event...'></textarea>" +
        "<div class='info-box info-box-info'>" +
        "ℹ️ " + theirName + " will see your reason and can approve or decline." +
        "</div>" +
        "<button onclick='createStudentSwapRequest(" + myLessonId + "," + theirLessonId + ",\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-violet'>Send Request</button>" +
        "<button onclick='showStudentSwapOptions(" + myLessonId + ",\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-secondary'>Back</button>";
    
    modal(html);
}

function createStudentSwapRequest(myLessonId, theirLessonId, firstName, lastName) {
    const myLesson = lessons.find(l => l.id === myLessonId);
    const theirLesson = lessons.find(l => l.id === theirLessonId);
    
    const reason = document.getElementById('swapReason').value.trim();
    if(!reason) {
        toast("Please provide a reason for the swap request");
        document.getElementById('swapReason').focus();
        document.getElementById('swapReason').style.borderColor = 'var(--rose-500)';
        return;
    }
    
    const existing = swapRequests.find(r => 
        (r.requestingLessonId === myLessonId && r.targetLessonId === theirLessonId) ||
        (r.requestingLessonId === theirLessonId && r.targetLessonId === myLessonId)
    );
    
    if(existing && existing.status === 'pending') {
        toast("A swap request already exists");
        showMyLessonsForSwap();
        return;
    }
    
    swapRequests.push({
        id: nextSwapId++,
        requestingLessonId: myLessonId,
        targetLessonId: theirLessonId,
        requestingStudent: myLesson.firstName + " " + myLesson.lastName,
        targetStudent: theirLesson.firstName + " " + theirLesson.lastName,
        status: 'pending',
        timestamp: new Date().toISOString(),
        reason: reason
    });
    
    toast("Swap request sent!");
    saveData();
    render();
    closeModal();
}

function approveSwapInPortal(requestId, firstName, lastName) {
    const request = swapRequests.find(r => r.id === requestId);
    if(!request) return;
    
    // Mark as student agreed - teacher still needs to approve
    request.status = 'student_agreed';
    request.studentAgreedAt = new Date().toISOString();
    request.agreedBy = firstName + " " + lastName;
    
    // Mark as seen for the current user (they just took the action)
    const fullName = firstName + " " + lastName;
    if(!seenNotifications[fullName]) seenNotifications[fullName] = [];
    if(!seenNotifications[fullName].includes(requestId)) {
        seenNotifications[fullName].push(requestId);
    }
    
    toast("Swap accepted! Waiting for teacher approval.");
    saveData();
    render();
    showMyLessonsForSwap();
}

function showDeclineSwapModal(requestId, firstName, lastName) {
    const request = swapRequests.find(r => r.id === requestId);
    if(!request) return;
    
    const theirLesson = lessons.find(l => l.id === request.requestingLessonId);
    const myLesson = lessons.find(l => l.id === request.targetLessonId);
    const theirName = theirLesson ? formatNamePrivate(theirLesson.firstName, theirLesson.lastName) : 'Unknown';
    
    let html = "<h3 class='modal-title'>❌ Decline Swap Request</h3>" +
        "<p class='modal-subtitle'>Let " + theirName + " know why you can't swap</p>";
    
    if(theirLesson && myLesson) {
        html += "<div class='info-box info-box-info' style='margin-bottom: 1rem;'>" +
            "<div style='font-size: 0.8rem;'>" +
            "<strong>" + theirName + "</strong> wants their <strong>" + formatLessonDate(theirLesson.week, theirLesson.day) + " at " + theirLesson.time + "</strong><br>" +
            "swapped with your <strong>" + formatLessonDate(myLesson.week, myLesson.day) + " at " + myLesson.time + "</strong>" +
            "</div>" +
            "</div>";
    }
    
    if(request.reason) {
        html += "<div style='padding: 0.6rem 0.75rem; background: var(--violet-50); border: 1px solid var(--violet-300); border-radius: 8px; margin-bottom: 1rem;'>" +
            "<div style='font-size: 0.7rem; font-weight: 600; color: var(--violet-700); margin-bottom: 0.2rem;'>💬 Their reason</div>" +
            "<div style='font-size: 0.8rem; color: var(--stone-700);'>" + request.reason + "</div>" +
            "</div>";
    }
    
    html += "<label class='form-label'>Reason for declining <span style='color: var(--rose-500);'>*</span></label>" +
        "<textarea id='declineReason' class='form-input' style='resize: vertical; min-height: 70px;' placeholder='e.g., That time doesn&apos;t work for me, I have another commitment then...'></textarea>" +
        "<button onclick='confirmDeclineSwap(" + requestId + ",\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-danger'>Decline Request</button>" +
        "<button onclick='showMyLessonsForSwap()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function confirmDeclineSwap(requestId, firstName, lastName) {
    const declineReason = document.getElementById('declineReason').value.trim();
    if(!declineReason) {
        toast("Please provide a reason for declining");
        document.getElementById('declineReason').focus();
        document.getElementById('declineReason').style.borderColor = 'var(--rose-500)';
        return;
    }
    
    declineSwapInPortal(requestId, firstName, lastName, declineReason);
}

function declineSwapInPortal(requestId, firstName, lastName, declineReason) {
    const request = swapRequests.find(r => r.id === requestId);
    if(request) {
        request.status = 'declined';
        request.resolvedAt = new Date().toISOString();
        request.declineReason = declineReason || '';
        request.resolvedBy = firstName + " " + lastName;
    }
    
    // Mark as seen for the current user (they just took the action)
    const fullName = firstName + " " + lastName;
    if(!seenNotifications[fullName]) seenNotifications[fullName] = [];
    if(!seenNotifications[fullName].includes(requestId)) {
        seenNotifications[fullName].push(requestId);
    }
    
    toast("Swap declined");
    saveData();
    showMyLessonsForSwap();
}

// ============ RESCHEDULE / MOVE REQUEST FUNCTIONS ============

function findAvailableSlots(duration, maxWeek = 4, numSlots = 6) {
    const availableSlots = [];
    const businessHours = ["09:00", "09:30", "10:00", "10:30", "11:00", "11:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30"];
    const weekdays = [0, 1, 2, 3, 4]; // Mon-Fri
    
    // Check weeks 0 through maxWeek
    for(let week = 0; week <= maxWeek && availableSlots.length < numSlots; week++) {
        for(let day of weekdays) {
            if(availableSlots.length >= numSlots) break;
            
            // Skip past days in current week
            if(week === 0 && isInPast(week, day)) continue;
            
            for(let time of businessHours) {
                if(availableSlots.length >= numSlots) break;
                
                const slotStart = timeToMinutes(time);
                const slotEnd = slotStart + duration;
                
                // Check if slot conflicts with any existing lesson
                const hasLessonConflict = lessons.some(l => {
                    if(l.week !== week || l.day !== day) return false;
                    const lessonStart = timeToMinutes(l.time);
                    const lessonEnd = lessonStart + l.duration;
                    return slotStart < lessonEnd && slotEnd > lessonStart;
                });
                
                if(hasLessonConflict) continue;
                
                // Check if slot conflicts with any blocked time
                const hasBlockConflict = blockedTimes.some(b => {
                    if(b.week !== week || b.day !== day) return false;
                    const blockStart = timeToMinutes(b.time);
                    const blockEnd = blockStart + b.duration;
                    return slotStart < blockEnd && slotEnd > blockStart;
                });
                
                if(hasBlockConflict) continue;
                
                // This slot is available!
                availableSlots.push({
                    day: day,
                    time: time,
                    week: week,
                    dateStr: getDateForLesson({day: day, week: week})
                });
            }
        }
    }
    
    return availableSlots;
}

// Request teacher to reschedule - show available slots
function showRequestTeacherReschedule(lessonId) {
    const lesson = lessons.find(l => l.id === lessonId);
    if(!lesson) return;
    
    const currentDay = days[lesson.day];
    const currentTime = lesson.time;
    const duration = lesson.duration;
    
    // Check if there's already a pending request for this lesson
    const existingRequest = moveRequests.find(r => r.lessonId === lessonId && r.status === 'pending');
    if(existingRequest) {
        let html = "<h3 class='modal-title'>📩 Request Already Pending</h3>" +
            "<div class='info-box info-box-warning'>" +
            "<p>You already have a pending reschedule request for this lesson.</p>" +
            "<p style='margin-top: 0.5rem; font-size: 0.85rem;'>Waiting for teacher approval.</p>" +
            "</div>" +
            "<button onclick='cancelMoveRequest(" + existingRequest.id + ")' class='modal-btn modal-btn-danger'>Cancel Request</button>" +
            "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Close</button>";
        modal(html);
        return;
    }
    
    // Find the student's last scheduled lesson week
    const studentLessons = lessons.filter(l => 
        l.firstName === lesson.firstName && l.lastName === lesson.lastName
    );
    const lastLessonWeek = Math.max(...studentLessons.map(l => l.week));
    
    // Find available slots of the same duration, limited to last lesson week
    const availableSlots = findAvailableSlots(duration, lastLessonWeek, 12);
    
    // Store selected slot globally for form submission
    window.selectedRescheduleSlot = null;
    
    let html = "<h3 class='modal-title'>📩 Request Reschedule</h3>" +
        "<p class='modal-subtitle'>Select a new time for your lesson</p>" +
        
        "<div class='info-box info-box-info' style='margin-bottom: 1rem;'>" +
        "<strong>Current:</strong> " + currentDay + " at " + currentTime + " (" + duration + " min)" +
        "</div>" +
        
        "<label class='form-label'>Reason for Reschedule</label>" +
        "<textarea id='teacherRescheduleReason' class='form-textarea' placeholder='e.g., Family vacation, school event, conflict with another activity...' rows='2'></textarea>";
    
    if(availableSlots.length === 0) {
        html += "<div class='info-box info-box-warning' style='margin-top: 1rem;'>" +
            "<strong>No open times found</strong><br>" +
            "<span style='font-size: 0.85rem;'>There are no available " + duration + "-minute slots. Your teacher will find a time for you.</span>" +
            "</div>" +
            
            "<label class='form-label' style='margin-top: 1rem;'>Preferred Times <span class='form-label-optional'>(Optional)</span></label>" +
            "<input type='text' id='teacherReschedulePreferred' class='form-input' placeholder='e.g., Any morning, Tuesday or Thursday after 4pm'>";
    } else {
        html += "<div class='section-title' style='margin-top: 1rem;'>Select a Preferred Time</div>" +
            "<p style='font-size: 0.8rem; color: var(--stone-500); margin-bottom: 0.75rem;'>Available " + duration + "-minute slots:</p>" +
            "<div class='scroll-container' style='max-height: 200px;' id='rescheduleSlotContainer'>";
        
        availableSlots.forEach((slot, index) => {
            const dayName = days[slot.day];
            const weekLabel = slot.week === 0 ? "This week" : (slot.week === 1 ? "Next week" : "In " + slot.week + " weeks");
            
            html += "<div class='available-slot-card reschedule-slot-option' data-index='" + index + "' " +
                "onclick='selectRescheduleSlotOption(" + index + ", " + slot.day + ", \"" + slot.time + "\", " + slot.week + ", \"" + slot.dateStr + "\")'>" +
                "<div style='display: flex; justify-content: space-between; align-items: center;'>" +
                "<div>" +
                "<div style='font-weight: 600; color: var(--stone-700);'>" + dayName + " at " + slot.time + "</div>" +
                "<div style='font-size: 0.75rem; color: var(--stone-500);'>" + slot.dateStr + " • " + weekLabel + "</div>" +
                "</div>" +
                "<span class='slot-check' style='display: none; color: var(--teal-500); font-size: 1.25rem;'>✓</span>" +
                "</div>" +
                "</div>";
        });
        
        html += "</div>";
    }
    
    html += "<div style='margin-top: 1rem;'>" +
        "<button onclick='submitTeacherRescheduleRequest(" + lessonId + ")' class='modal-btn modal-btn-amber'>Send Request</button>" +
        "<button onclick='showMyLessonsForReschedule()' class='modal-btn modal-btn-secondary'>Back</button>" +
        "</div>";
    
    modal(html);
}

function selectRescheduleSlotOption(index, day, time, week, dateStr) {
    // Store the selected slot
    window.selectedRescheduleSlot = { day, time, week, dateStr };
    
    // Update visual selection
    document.querySelectorAll('.reschedule-slot-option').forEach((el, i) => {
        if(i === index) {
            el.style.background = 'var(--teal-50)';
            el.style.borderColor = 'var(--teal-400)';
            el.querySelector('.slot-check').style.display = 'block';
        } else {
            el.style.background = '';
            el.style.borderColor = '';
            el.querySelector('.slot-check').style.display = 'none';
        }
    });
}

function submitTeacherRescheduleRequest(lessonId) {
    const lesson = lessons.find(l => l.id === lessonId);
    if(!lesson) return;
    
    const reason = document.getElementById('teacherRescheduleReason').value.trim();
    const preferredInput = document.getElementById('teacherReschedulePreferred');
    const preferred = preferredInput ? preferredInput.value.trim() : '';
    const selectedSlot = window.selectedRescheduleSlot;
    
    if(!reason) {
        toast("Please provide a reason for the reschedule request");
        return;
    }
    
    // Build preferred times string from selected slot if available
    let preferredTimesStr = preferred;
    if(selectedSlot) {
        preferredTimesStr = days[selectedSlot.day] + " at " + selectedSlot.time + " (" + selectedSlot.dateStr + ")";
    }
    
    moveRequests.push({
        id: nextMoveId++,
        lessonId: lessonId,
        studentName: lesson.firstName + " " + lesson.lastName,
        currentDay: lesson.day,
        currentTime: lesson.time,
        currentWeek: lesson.week,
        duration: lesson.duration,
        type: 'teacher_reschedule',
        reason: reason,
        preferredTimes: preferredTimesStr,
        // Include selected slot details if student picked one
        suggestedDay: selectedSlot ? selectedSlot.day : null,
        suggestedTime: selectedSlot ? selectedSlot.time : null,
        suggestedWeek: selectedSlot ? selectedSlot.week : null,
        newDay: null,
        newTime: null,
        newWeek: null,
        status: 'pending',
        timestamp: new Date().toISOString()
    });
    
    // Clear the selected slot
    window.selectedRescheduleSlot = null;
    
    saveData();
    closeModal();
    toast("Reschedule request sent to teacher!");
}

function showRescheduleOptions(lessonId) {
    const lesson = lessons.find(l => l.id === lessonId);
    if(!lesson) return;
    
    const studentName = lesson.firstName + " " + lesson.lastName;
    const currentTime = lesson.time;
    const currentDay = days[lesson.day];
    const duration = lesson.duration;
    
    // Find the student's last scheduled lesson week
    const studentLessons = lessons.filter(l => 
        l.firstName === lesson.firstName && 
        l.lastName === lesson.lastName
    );
    const lastLessonWeek = Math.max(...studentLessons.map(l => l.week));
    
    // Check if there's already a pending move request for this lesson
    const existingRequest = moveRequests.find(r => r.lessonId === lessonId && r.status === 'pending');
    if(existingRequest) {
        const newDate = getDateForLesson({day: existingRequest.newDay, week: existingRequest.newWeek});
        let html = "<h3 class='modal-title'>📅 Reschedule Request Pending</h3>" +
            "<div class='info-box info-box-warning'>" +
            "<p>You already have a pending request to move this lesson to:</p>" +
            "<p style='margin-top: 0.5rem; font-weight: 700;'>" + days[existingRequest.newDay] + ", " + newDate + " at " + existingRequest.newTime + "</p>" +
            "<p style='margin-top: 0.5rem; font-size: 0.85rem;'>Waiting for teacher approval.</p>" +
            "</div>" +
            "<button onclick='cancelMoveRequest(" + existingRequest.id + ")' class='modal-btn modal-btn-danger'>Cancel Request</button>" +
            "<button onclick='closeModal()' class='modal-btn modal-btn-secondary'>Close</button>";
        modal(html);
        return;
    }
    
    // Find available slots - limited to the week of the student's last lesson
    const availableSlots = findAvailableSlots(duration, lastLessonWeek, 6);
    
    let html = "<h3 class='modal-title'>📅 Reschedule Lesson</h3>" +
        "<p class='modal-subtitle'>Find an open time for your " + duration + "-minute lesson</p>";
    
    // Show current lesson info
    html += "<div class='info-box info-box-info' style='margin-bottom: 1rem;'>" +
        "<strong>Current Time:</strong> " + currentDay + " at " + currentTime + 
        "</div>";
    
    if(availableSlots.length === 0) {
        html += "<div class='info-box info-box-warning'>" +
            "<strong>No open times found</strong><br>" +
            "<span style='font-size: 0.85rem;'>There are no available " + duration + "-minute slots within your scheduled lesson period. " +
            "Try requesting a swap with another student instead.</span>" +
            "</div>";
    } else {
        html += "<p style='font-size: 0.9rem; color: var(--stone-600); margin-bottom: 1rem;'>Select an available time:</p>";
        
        html += "<div class='scroll-container' style='max-height: 300px;'>";
        availableSlots.forEach((slot, index) => {
            const dayName = days[slot.day];
            const weekLabel = slot.week === 0 ? "This week" : (slot.week === 1 ? "Next week" : "In " + slot.week + " weeks");
            
            html += "<div class='available-slot-card' onclick='selectRescheduleSlot(" + lessonId + ", " + slot.day + ", \"" + slot.time + "\", " + slot.week + ")'>" +
                "<div style='display: flex; justify-content: space-between; align-items: center;'>" +
                "<div>" +
                "<div style='font-weight: 700; color: var(--teal-700);'>" + dayName + " at " + slot.time + "</div>" +
                "<div style='font-size: 0.8rem; color: var(--stone-500);'>" + slot.dateStr + " • " + weekLabel + "</div>" +
                "</div>" +
                "<span style='color: var(--teal-600); font-size: 1.2rem;'>→</span>" +
                "</div>" +
                "</div>";
        });
        html += "</div>";
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Cancel</button>";
    
    modal(html);
}

function selectRescheduleSlot(lessonId, newDay, newTime, newWeek) {
    const lesson = lessons.find(l => l.id === lessonId);
    if(!lesson) return;
    
    const studentName = lesson.firstName + " " + lesson.lastName;
    const currentDate = getDateForLesson(lesson);
    const newDate = getDateForLesson({day: newDay, week: newWeek});
    
    let html = "<h3 class='modal-title'>📅 Confirm Reschedule Request</h3>" +
        "<div style='margin-bottom: 1.5rem;'>" +
        "<div class='info-box' style='background: var(--rose-50); border-color: var(--rose-200); margin-bottom: 0.5rem;'>" +
        "<div style='font-size: 0.8rem; color: var(--stone-500);'>FROM:</div>" +
        "<div style='font-weight: 700; color: var(--rose-700);'>" + days[lesson.day] + ", " + currentDate + " at " + lesson.time + "</div>" +
        "</div>" +
        "<div style='text-align: center; color: var(--stone-400); padding: 0.5rem;'>↓</div>" +
        "<div class='info-box' style='background: var(--teal-50); border-color: var(--teal-200);'>" +
        "<div style='font-size: 0.8rem; color: var(--stone-500);'>TO:</div>" +
        "<div style='font-weight: 700; color: var(--teal-700);'>" + days[newDay] + ", " + newDate + " at " + newTime + "</div>" +
        "</div>" +
        "</div>" +
        "<p style='font-size: 0.9rem; color: var(--stone-600); margin-bottom: 1rem;'>" +
        "Your teacher will be notified of this request. The change will only happen if they approve it." +
        "</p>" +
        "<button onclick='submitMoveRequest(" + lessonId + ", " + newDay + ", \"" + newTime + "\", " + newWeek + ")' class='modal-btn modal-btn-primary'>✓ Send Request</button>" +
        "<button onclick='showRescheduleOptions(" + lessonId + ")' class='modal-btn modal-btn-secondary'>← Back</button>";
    
    modal(html);
}

function submitMoveRequest(lessonId, newDay, newTime, newWeek) {
    const lesson = lessons.find(l => l.id === lessonId);
    if(!lesson) return;
    
    const studentName = lesson.firstName + " " + lesson.lastName;
    
    moveRequests.push({
        id: nextMoveId++,
        studentName: studentName,
        lessonId: lessonId,
        currentDay: lesson.day,
        currentTime: lesson.time,
        currentWeek: lesson.week,
        newDay: newDay,
        newTime: newTime,
        newWeek: newWeek,
        duration: lesson.duration,
        status: "pending",
        timestamp: new Date().toISOString()
    });
    
    saveData();
    toast("Reschedule request sent!");
    closeModal();
    render();
}

function cancelMoveRequest(requestId) {
    const index = moveRequests.findIndex(r => r.id === requestId);
    if(index !== -1) {
        moveRequests.splice(index, 1);
        saveData();
        toast("Request cancelled");
        closeModal();
    }
}

// Teacher functions for move requests
function teacherApproveMoveRequest(requestId) {
    const request = moveRequests.find(r => r.id === requestId);
    if(!request) return;
    
    const lesson = lessons.find(l => l.id === request.lessonId);
    if(!lesson) {
        toast("Error: Lesson not found");
        return;
    }
    
    // Update the lesson
    lesson.day = request.newDay;
    lesson.time = request.newTime;
    lesson.week = request.newWeek;
    
    // Break from recurring series
    if(lesson.isRecurring) {
        lesson.isRecurring = false;
        lesson.seriesId = null;
    }
    
    request.status = 'approved';
    request.resolvedAt = new Date().toISOString();
    
    toast("Reschedule approved!");
    saveData();
    render();
    showTeacherMoveRequests();
}

function teacherDeclineMoveRequest(requestId) {
    const request = moveRequests.find(r => r.id === requestId);
    if(request) {
        request.status = 'declined';
        request.resolvedAt = new Date().toISOString();
    }
    
    toast("Reschedule declined");
    saveData();
    showTeacherMoveRequests();
}

// Teacher picks a new time for a student's reschedule request
function showTeacherPickTimeModal(requestId) {
    const request = moveRequests.find(r => r.id === requestId);
    if(!request) return;
    
    const lesson = lessons.find(l => l.id === request.lessonId);
    if(!lesson) {
        toast("Error: Lesson not found");
        return;
    }
    
    const duration = request.duration || lesson.duration;
    
    // Find the student's last scheduled lesson week
    const studentLessons = lessons.filter(l => 
        l.firstName === lesson.firstName && l.lastName === lesson.lastName
    );
    const lastLessonWeek = Math.max(...studentLessons.map(l => l.week));
    
    // Find available slots limited to last lesson week
    const availableSlots = findAvailableSlots(duration, lastLessonWeek, 12);
    
    let html = "<h3 class='modal-title'>📅 Pick New Time</h3>" +
        "<p class='modal-subtitle'>For: <strong>" + request.studentName + "</strong></p>" +
        
        "<div class='info-box info-box-info' style='margin-bottom: 1rem;'>" +
        "<strong>Current:</strong> " + days[request.currentDay] + " at " + request.currentTime + " (" + duration + " min)" +
        "</div>";
    
    if(request.reason) {
        html += "<div class='info-box info-box-warning' style='margin-bottom: 1rem;'>" +
            "<strong>Reason:</strong> " + request.reason;
        if(request.preferredTimes) {
            html += "<br><strong>Preferred times:</strong> " + request.preferredTimes;
        }
        html += "</div>";
    }
    
    if(availableSlots.length === 0) {
        html += "<div class='info-box info-box-danger'>" +
            "<strong>No available slots</strong><br>" +
            "No open " + duration + "-minute slots found within the student's lesson period." +
            "</div>";
    } else {
        html += "<p style='font-size: 0.9rem; color: var(--stone-600); margin-bottom: 1rem;'>Select an available time:</p>";
        
        html += "<div class='scroll-container' style='max-height: 300px;'>";
        availableSlots.forEach(slot => {
            const dayName = days[slot.day];
            const weekLabel = slot.week === 0 ? "This week" : (slot.week === 1 ? "Next week" : "In " + slot.week + " weeks");
            
            html += "<div class='available-slot-card' onclick='teacherAssignNewTime(" + requestId + ", " + slot.day + ", \"" + slot.time + "\", " + slot.week + ")'>" +
                "<div style='display: flex; justify-content: space-between; align-items: center;'>" +
                "<div>" +
                "<div style='font-weight: 700; color: var(--teal-700);'>" + dayName + " at " + slot.time + "</div>" +
                "<div style='font-size: 0.8rem; color: var(--stone-500);'>" + slot.dateStr + " • " + weekLabel + "</div>" +
                "</div>" +
                "<span style='font-size: 1.25rem;'>→</span>" +
                "</div>" +
                "</div>";
        });
        html += "</div>";
    }
    
    html += "<button onclick='showTeacherMoveRequests()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Back</button>";
    
    modal(html);
}

function teacherAssignNewTime(requestId, newDay, newTime, newWeek) {
    const request = moveRequests.find(r => r.id === requestId);
    if(!request) return;
    
    const lesson = lessons.find(l => l.id === request.lessonId);
    if(!lesson) {
        toast("Error: Lesson not found");
        return;
    }
    
    // Update request with the new time
    request.newDay = newDay;
    request.newTime = newTime;
    request.newWeek = newWeek;
    
    // Update the lesson
    lesson.day = newDay;
    lesson.time = newTime;
    lesson.week = newWeek;
    
    // Break from recurring series
    if(lesson.isRecurring) {
        lesson.isRecurring = false;
        lesson.seriesId = null;
    }
    
    request.status = 'approved';
    request.resolvedAt = new Date().toISOString();
    
    toast("Lesson rescheduled to " + days[newDay] + " at " + newTime);
    saveData();
    render();
    showTeacherMoveRequests();
}

function showTeacherMoveRequests() {
    const pending = moveRequests.filter(r => r.status === 'pending');
    const approved = moveRequests.filter(r => r.status === 'approved');
    const declined = moveRequests.filter(r => r.status === 'declined');
    
    let html = "<h3 class='modal-title'>📅 Reschedule Requests</h3>" +
        "<p class='modal-subtitle'>Students requesting to move to open times</p>";
    
    // Summary stats
    html += "<div style='display: flex; gap: 0.5rem; margin-bottom: 1.5rem;'>" +
        "<div style='flex: 1; text-align: center; padding: 0.75rem; background: var(--amber-100); border-radius: 10px;'>" +
        "<div style='font-size: 1.5rem; font-weight: 700; color: var(--amber-700);'>" + pending.length + "</div>" +
        "<div style='font-size: 0.75rem; color: var(--amber-600);'>Pending</div>" +
        "</div>" +
        "<div style='flex: 1; text-align: center; padding: 0.75rem; background: var(--emerald-500); border-radius: 10px; opacity: 0.8;'>" +
        "<div style='font-size: 1.5rem; font-weight: 700; color: white;'>" + approved.length + "</div>" +
        "<div style='font-size: 0.75rem; color: white;'>Approved</div>" +
        "</div>" +
        "<div style='flex: 1; text-align: center; padding: 0.75rem; background: var(--rose-500); border-radius: 10px; opacity: 0.8;'>" +
        "<div style='font-size: 1.5rem; font-weight: 700; color: white;'>" + declined.length + "</div>" +
        "<div style='font-size: 0.75rem; color: white;'>Declined</div>" +
        "</div>" +
        "</div>";
    
    if(moveRequests.length === 0) {
        html += "<div class='info-box info-box-info'>No reschedule requests yet.</div>";
    } else {
        html += "<div class='scroll-container' style='max-height: 400px;'>";
        
        // Pending requests
        if(pending.length > 0) {
            html += "<div class='section-title' style='color: var(--amber-600);'>⏳ Pending Requests</div>";
            pending.forEach(request => {
                html += renderMoveRequestCard(request, true);
            });
        }
        
        // Approved requests
        if(approved.length > 0) {
            html += "<div class='section-title' style='margin-top: 1rem; color: var(--emerald-600);'>✅ Approved</div>";
            approved.forEach(request => {
                html += renderMoveRequestCard(request, false);
            });
        }
        
        // Declined requests
        if(declined.length > 0) {
            html += "<div class='section-title' style='margin-top: 1rem; color: var(--rose-600);'>❌ Declined</div>";
            declined.forEach(request => {
                html += renderMoveRequestCard(request, false);
            });
        }
        
        html += "</div>";
    }
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Close</button>";
    
    modal(html);
}

function renderMoveRequestCard(request, showActions) {
    const currentDate = getDateForLesson({day: request.currentDay, week: request.currentWeek});
    const requestDate = new Date(request.timestamp);
    
    let statusClass = '';
    let statusIcon = '';
    let statusLabel = '';
    
    if(request.status === 'pending') {
        statusClass = 'info-box-warning';
        statusIcon = '⏳';
        statusLabel = 'Pending';
    } else if(request.status === 'approved') {
        statusClass = 'info-box-success';
        statusIcon = '✅';
        statusLabel = 'Approved';
    } else {
        statusClass = 'info-box-danger';
        statusIcon = '❌';
        statusLabel = 'Declined';
    }
    
    // Check if this is a "teacher reschedule" request (student asked teacher to pick time)
    const isTeacherReschedule = request.type === 'teacher_reschedule';
    
    let html = "<div class='info-box " + statusClass + "' style='margin-bottom: 0.75rem; padding: 1rem;'>";
    
    // Header with badge for teacher reschedule
    html += "<div style='display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;'>" +
        "<span style='font-weight: 700;'>" + statusIcon + " " + request.studentName + "</span>" +
        "<span style='font-size: 0.7rem; opacity: 0.7;'>" + requestDate.toLocaleDateString() + "</span>" +
        "</div>";
    
    if(isTeacherReschedule) {
        // Teacher reschedule request - show reason and preferred times
        html += "<div style='background: var(--amber-50); border: 1px solid var(--amber-200); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;'>" +
            "<div style='font-size: 0.7rem; text-transform: uppercase; font-weight: 600; color: var(--amber-700); margin-bottom: 0.25rem;'>📩 Reschedule Request</div>" +
            "<div style='font-size: 0.85rem;'><strong>Current:</strong> " + days[request.currentDay] + " at " + request.currentTime + " (" + currentDate + ")</div>" +
            "</div>";
        
        html += "<div style='font-size: 0.85rem; margin-bottom: 0.5rem;'>" +
            "<div style='color: var(--stone-600);'><strong>Reason:</strong> " + (request.reason || 'Not specified') + "</div>";
        
        // Check if student suggested a specific time slot
        if(request.suggestedDay !== null && request.suggestedDay !== undefined) {
            const suggestedDate = getDateForLesson({day: request.suggestedDay, week: request.suggestedWeek});
            html += "<div style='background: var(--teal-50); border: 1px solid var(--teal-300); border-radius: 6px; padding: 0.5rem; margin-top: 0.5rem;'>" +
                "<div style='font-size: 0.7rem; text-transform: uppercase; font-weight: 600; color: var(--teal-700);'>📍 Student's Preferred Time</div>" +
                "<div style='font-weight: 700; color: var(--teal-800); margin-top: 0.25rem;'>" + days[request.suggestedDay] + " at " + request.suggestedTime + "</div>" +
                "<div style='font-size: 0.75rem; color: var(--teal-600);'>" + suggestedDate + "</div>" +
                "</div>";
        } else if(request.preferredTimes) {
            html += "<div style='color: var(--teal-700); margin-top: 0.5rem;'><strong>Preferred:</strong> " + request.preferredTimes + "</div>";
        }
        html += "</div>";
        
        // Duration
        html += "<div style='font-size: 0.75rem; color: var(--stone-400);'>" + request.duration + " min lesson</div>";
        
        // Action buttons for teacher reschedule
        if(showActions) {
            // If student suggested a time, show quick-approve button
            if(request.suggestedDay !== null && request.suggestedDay !== undefined) {
                html += "<div style='display: flex; gap: 0.5rem; margin-top: 0.75rem;'>" +
                    "<button onclick='teacherAssignNewTime(" + request.id + ", " + request.suggestedDay + ", \"" + request.suggestedTime + "\", " + request.suggestedWeek + ")' class='btn btn-small' style='flex: 1; background: var(--emerald-500); color: white;'>✓ Approve Time</button>" +
                    "</div>" +
                    "<div style='display: flex; gap: 0.5rem; margin-top: 0.5rem;'>" +
                    "<button onclick='showTeacherPickTimeModal(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--teal-500); color: white;'>📅 Pick Different Time</button>" +
                    "<button onclick='teacherDeclineMoveRequest(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--rose-500); color: white;'>✗ Decline</button>" +
                    "</div>";
            } else {
                html += "<div style='display: flex; gap: 0.5rem; margin-top: 0.75rem;'>" +
                    "<button onclick='showTeacherPickTimeModal(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--teal-500); color: white;'>📅 Pick New Time</button>" +
                    "<button onclick='teacherDeclineMoveRequest(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--rose-500); color: white;'>✗ Decline</button>" +
                    "</div>";
            }
        }
    } else {
        // Regular reschedule request - student already picked a time
        const newDate = getDateForLesson({day: request.newDay, week: request.newWeek});
        
        // From/To times
        html += "<div style='font-size: 0.85rem;'>" +
            "<div style='color: var(--stone-500);'>From: <strong>" + days[request.currentDay] + " " + request.currentTime + "</strong> (" + currentDate + ")</div>" +
            "<div style='text-align: center; color: var(--stone-400); padding: 0.25rem;'>↓</div>" +
            "<div style='color: var(--teal-700);'>To: <strong>" + days[request.newDay] + " " + request.newTime + "</strong> (" + newDate + ")</div>" +
            "</div>";
        
        // Duration
        html += "<div style='font-size: 0.75rem; color: var(--stone-400); margin-top: 0.5rem;'>" + request.duration + " min lesson</div>";
        
        // Action buttons for regular reschedule
        if(showActions) {
            html += "<div style='display: flex; gap: 0.5rem; margin-top: 0.75rem;'>" +
                "<button onclick='teacherApproveMoveRequest(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--emerald-500); color: white;'>✓ Approve</button>" +
                "<button onclick='teacherDeclineMoveRequest(" + request.id + ")' class='btn btn-small' style='flex: 1; background: var(--rose-500); color: white;'>✗ Decline</button>" +
                "</div>";
        }
    }
    
    // Resolution info
    if(request.status !== 'pending' && request.resolvedAt) {
        const resolvedDate = new Date(request.resolvedAt);
        html += "<div style='font-size: 0.7rem; margin-top: 0.5rem; opacity: 0.7; font-style: italic;'>" +
            (request.status === 'approved' ? "Approved" : "Declined") + " on " + resolvedDate.toLocaleDateString() +
            "</div>";
    }
    
    html += "</div>";
    
    return html;
}

function createDefaultBlocks() {
    if(blockedTimes.length > 0) return;
    
    const nightHours = ["21:00", "22:00", "23:00", "00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00"];
    const dayHours = ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00"];
    
    // Block night hours for all days
    for(let day = 0; day < 7; day++) {
        nightHours.forEach(time => {
            for(let week = -2; week <= 52; week++) {
                blockedTimes.push({
                    id: nextBlockId++,
                    day: day,
                    time: time,
                    duration: 60,
                    reason: "Closed",
                    week: week
                });
            }
        });
    }
    
    // Block daytime hours for weekends (Saturday = 5, Sunday = 6)
    [5, 6].forEach(day => {
        dayHours.forEach(time => {
            for(let week = -2; week <= 52; week++) {
                blockedTimes.push({
                    id: nextBlockId++,
                    day: day,
                    time: time,
                    duration: 60,
                    reason: "Weekend",
                    week: week
                });
            }
        });
    });
}

createDefaultBlocks();

// ===== PAYMENT TRACKING FUNCTIONS =====
function showPaymentsModal() {
    const students = getUniqueStudents().filter(s => !s.retired);
    
    // Calculate totals
    let totalOwed = 0;
    let totalPaid = 0;
    
    students.forEach(student => {
        const studentPayments = getStudentPaymentSummary(student.firstName, student.lastName);
        totalOwed += studentPayments.totalOwed;
        totalPaid += studentPayments.totalPaid;
    });
    
    const outstanding = totalOwed - totalPaid;
    
    let html = "<h3 class='modal-title'>💰 Payment Tracking</h3>" +
        "<p class='modal-subtitle'>Manage lesson payments and invoices</p>";
    
    // Summary stats
    html += "<div class='payment-summary'>" +
        "<div class='payment-stat total'>" +
        "<div class='payment-stat-value'>$" + totalOwed.toFixed(0) + "</div>" +
        "<div class='payment-stat-label'>Total Billed</div>" +
        "</div>" +
        "<div class='payment-stat paid'>" +
        "<div class='payment-stat-value'>$" + totalPaid.toFixed(0) + "</div>" +
        "<div class='payment-stat-label'>Received</div>" +
        "</div>" +
        "<div class='payment-stat unpaid'>" +
        "<div class='payment-stat-value'>$" + outstanding.toFixed(0) + "</div>" +
        "<div class='payment-stat-label'>Outstanding</div>" +
        "</div>" +
        "</div>";
    
    // Quick actions
    html += "<div style='display: flex; gap: 0.5rem; margin-bottom: 1rem;'>" +
        "<button onclick='showRecordPaymentModal()' class='modal-btn modal-btn-success' style='flex: 1; margin-bottom: 0;'>+ Record Payment</button>" +
        "<button onclick='showRatesModal()' class='modal-btn modal-btn-primary' style='flex: 1; margin-bottom: 0;'>⚙️ Rates</button>" +
        "</div>";
    
    // Student balances
    html += "<div class='section-title'>Student Balances</div>";
    html += "<div class='scroll-container'>";
    
    students.forEach(student => {
        const summary = getStudentPaymentSummary(student.firstName, student.lastName);
        const balance = summary.totalOwed - summary.totalPaid;
        const badgeClass = balance <= 0 ? 'paid' : 'unpaid';
        const badgeText = balance <= 0 ? 'PAID' : '$' + balance.toFixed(0) + ' DUE';
        
        html += "<div class='payment-row' onclick='showStudentPayments(\"" + student.firstName + "\",\"" + student.lastName + "\")'>" +
            "<div class='payment-row-info'>" +
            "<div class='payment-row-name'>" + student.firstName + " " + student.lastName + "</div>" +
            "<div class='payment-row-detail'>" + summary.lessonCount + " lessons • $" + summary.totalOwed.toFixed(0) + " billed</div>" +
            "</div>" +
            "<span class='payment-badge " + badgeClass + "'>" + badgeText + "</span>" +
            "</div>";
    });
    
    html += "</div>";
    
    html += "<button onclick='closeModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Close</button>";
    
    modal(html);
}

function getStudentPaymentSummary(firstName, lastName) {
    const studentKey = firstName + " " + lastName;
    
    // Get all past lessons for this student (that should be paid for)
    const pastLessons = lessons.filter(l => 
        l.firstName === firstName && 
        l.lastName === lastName && 
        isInPast(l.week, l.day)
    );
    
    // Calculate total owed
    let totalOwed = 0;
    pastLessons.forEach(lesson => {
        totalOwed += lessonRates[lesson.duration] || lessonRates[60];
    });
    
    // Calculate total paid
    const studentPayments = payments.filter(p => p.studentKey === studentKey);
    const totalPaid = studentPayments.reduce((sum, p) => sum + p.amount, 0);
    
    return {
        lessonCount: pastLessons.length,
        totalOwed: totalOwed,
        totalPaid: totalPaid,
        balance: totalOwed - totalPaid
    };
}

function showStudentPayments(firstName, lastName) {
    const studentKey = firstName + " " + lastName;
    const summary = getStudentPaymentSummary(firstName, lastName);
    const studentPayments = payments.filter(p => p.studentKey === studentKey).sort((a, b) => new Date(b.date) - new Date(a.date));
    
    let html = "<h3 class='modal-title'>💰 " + firstName + " " + lastName + "</h3>";
    
    // Summary
    const balance = summary.totalOwed - summary.totalPaid;
    const statusClass = balance <= 0 ? 'paid' : 'unpaid';
    const statusText = balance <= 0 ? 'All Paid Up!' : '$' + balance.toFixed(0) + ' Outstanding';
    
    html += "<div class='payment-summary'>" +
        "<div class='payment-stat total'>" +
        "<div class='payment-stat-value'>$" + summary.totalOwed.toFixed(0) + "</div>" +
        "<div class='payment-stat-label'>Total Billed</div>" +
        "</div>" +
        "<div class='payment-stat paid'>" +
        "<div class='payment-stat-value'>$" + summary.totalPaid.toFixed(0) + "</div>" +
        "<div class='payment-stat-label'>Paid</div>" +
        "</div>" +
        "<div class='payment-stat " + statusClass + "'>" +
        "<div class='payment-stat-value'>" + (balance <= 0 ? '✓' : '$' + balance.toFixed(0)) + "</div>" +
        "<div class='payment-stat-label'>" + (balance <= 0 ? 'Paid Up' : 'Balance Due') + "</div>" +
        "</div>" +
        "</div>";
    
    // Quick actions
    html += "<div style='display: flex; gap: 0.5rem; margin-bottom: 1rem;'>" +
        "<button onclick='showRecordPaymentModal(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-success' style='flex: 1; margin-bottom: 0;'>+ Record Payment</button>" +
        "<button onclick='generateInvoice(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-primary' style='flex: 1; margin-bottom: 0;'>📄 Invoice</button>" +
        "</div>";
    
    // Payment history
    html += "<div class='section-title'>Payment History</div>";
    
    if(studentPayments.length === 0) {
        html += "<p style='color: var(--stone-500); font-size: 0.875rem;'>No payments recorded yet.</p>";
    } else {
        html += "<div class='scroll-container'>";
        studentPayments.forEach(payment => {
            const date = new Date(payment.date);
            html += "<div class='payment-row'>" +
                "<div class='payment-row-info'>" +
                "<div class='payment-row-name'>$" + payment.amount.toFixed(2) + "</div>" +
                "<div class='payment-row-detail'>" + date.toLocaleDateString() + (payment.note ? ' • ' + payment.note : '') + "</div>" +
                "</div>" +
                "<button onclick='deletePayment(" + payment.id + ",\"" + firstName + "\",\"" + lastName + "\")' class='btn btn-small' style='background: var(--rose-500); color: white; font-size: 0.7rem;'>✕</button>" +
                "</div>";
        });
        html += "</div>";
    }
    
    html += "<button onclick='showPaymentsModal()' class='modal-btn modal-btn-secondary' style='margin-top: 1rem;'>Back</button>";
    
    modal(html);
}

function showRecordPaymentModal(firstName, lastName) {
    const students = getUniqueStudents().filter(s => !s.retired);
    
    let studentOptions = "";
    if(!firstName) {
        studentOptions = "<option value=''>-- Select Student --</option>";
    }
    students.forEach(s => {
        const selected = (firstName === s.firstName && lastName === s.lastName) ? ' selected' : '';
        studentOptions += "<option value='" + s.firstName + "|" + s.lastName + "'" + selected + ">" + s.firstName + " " + s.lastName + "</option>";
    });
    
    const today = new Date().toISOString().split('T')[0];
    
    let html = "<h3 class='modal-title'>💵 Record Payment</h3>";
    
    html += "<label class='form-label'>Student</label>" +
        "<select id='paymentStudent' class='form-select' onchange='updatePaymentSuggestion()'>" + studentOptions + "</select>" +
        "<label class='form-label'>Amount</label>" +
        "<div class='rate-input'>" +
        "<span>$</span>" +
        "<input type='number' id='paymentAmount' class='form-input' placeholder='0.00' step='0.01' style='margin-bottom: 0;'>" +
        "</div>" +
        "<div id='paymentSuggestion' style='font-size: 0.75rem; color: var(--stone-500); margin-top: 0.25rem;'></div>" +
        "<label class='form-label'>Date</label>" +
        "<input type='date' id='paymentDate' class='form-input' value='" + today + "'>" +
        "<label class='form-label'>Note <span class='form-label-optional'>(Optional)</span></label>" +
        "<input type='text' id='paymentNote' class='form-input' placeholder='e.g., Check #1234, Venmo, Cash'>" +
        "<button onclick='savePayment()' class='modal-btn modal-btn-success'>Save Payment</button>" +
        "<button onclick='showPaymentsModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
    
    if(firstName) {
        setTimeout(updatePaymentSuggestion, 100);
    }
}

function updatePaymentSuggestion() {
    const select = document.getElementById('paymentStudent');
    const suggestion = document.getElementById('paymentSuggestion');
    const amountInput = document.getElementById('paymentAmount');
    
    if(!select.value) {
        suggestion.textContent = '';
        return;
    }
    
    const parts = select.value.split('|');
    const summary = getStudentPaymentSummary(parts[0], parts[1]);
    const balance = summary.totalOwed - summary.totalPaid;
    
    if(balance > 0) {
        suggestion.innerHTML = 'Balance due: <strong>$' + balance.toFixed(2) + '</strong> • <a href="#" onclick="document.getElementById(\'paymentAmount\').value=' + balance.toFixed(2) + ';return false;">Use this amount</a>';
    } else {
        suggestion.textContent = 'All paid up! Balance: $0.00';
    }
}

function savePayment() {
    const select = document.getElementById('paymentStudent');
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const date = document.getElementById('paymentDate').value;
    const note = document.getElementById('paymentNote').value.trim();
    
    if(!select.value) {
        toast('Please select a student');
        return;
    }
    
    if(!amount || amount <= 0) {
        toast('Please enter a valid amount');
        return;
    }
    
    const parts = select.value.split('|');
    
    payments.push({
        id: nextPaymentId++,
        studentKey: parts[0] + ' ' + parts[1],
        amount: amount,
        date: date,
        note: note,
        createdAt: new Date().toISOString()
    });
    
    toast('Payment recorded: $' + amount.toFixed(2));
    saveData();
    showStudentPayments(parts[0], parts[1]);
}

function deletePayment(paymentId, firstName, lastName) {
    if(confirm('Delete this payment record?')) {
        payments = payments.filter(p => p.id !== paymentId);
        toast('Payment deleted');
        saveData();
        showStudentPayments(firstName, lastName);
    }
}

function showRatesModal() {
    let html = "<h3 class='modal-title'>⚙️ Lesson Rates</h3>" +
        "<p class='modal-subtitle'>Set your rates by lesson duration</p>";
    
    html += "<label class='form-label'>30-minute lesson</label>" +
        "<div class='rate-input'>" +
        "<span>$</span>" +
        "<input type='number' id='rate30' class='form-input' value='" + lessonRates[30] + "' step='0.01' style='margin-bottom: 0;'>" +
        "</div>" +
        "<label class='form-label'>45-minute lesson</label>" +
        "<div class='rate-input'>" +
        "<span>$</span>" +
        "<input type='number' id='rate45' class='form-input' value='" + lessonRates[45] + "' step='0.01' style='margin-bottom: 0;'>" +
        "</div>" +
        "<label class='form-label'>60-minute lesson</label>" +
        "<div class='rate-input'>" +
        "<span>$</span>" +
        "<input type='number' id='rate60' class='form-input' value='" + lessonRates[60] + "' step='0.01' style='margin-bottom: 0;'>" +
        "</div>" +
        "<button onclick='saveRates()' class='modal-btn modal-btn-primary'>Save Rates</button>" +
        "<button onclick='showPaymentsModal()' class='modal-btn modal-btn-secondary'>Cancel</button>";
    
    modal(html);
}

function saveRates() {
    lessonRates[30] = parseFloat(document.getElementById('rate30').value) || 40;
    lessonRates[45] = parseFloat(document.getElementById('rate45').value) || 55;
    lessonRates[60] = parseFloat(document.getElementById('rate60').value) || 70;
    
    toast('Rates updated!');
    saveData();
    showPaymentsModal();
}

function generateInvoice(firstName, lastName) {
    const studentKey = firstName + ' ' + lastName;
    const summary = getStudentPaymentSummary(firstName, lastName);
    
    // Get unpaid lessons (past lessons)
    const pastLessons = lessons.filter(l => 
        l.firstName === firstName && 
        l.lastName === lastName && 
        isInPast(l.week, l.day)
    ).sort((a, b) => {
        const dateA = getActualDate(a.week, a.day);
        const dateB = getActualDate(b.week, b.day);
        return dateA - dateB;
    });
    
    // Get recent ones (last 4 weeks)
    const recentLessons = pastLessons.slice(-8);
    
    const profile = studentProfiles.find(p => p.firstName === firstName && p.lastName === lastName);
    const guardianName = profile ? profile.guardianName : 'Parent/Guardian';
    const today = new Date();
    
    let html = "<h3 class='modal-title'>📄 Invoice</h3>";
    
    html += "<div class='invoice-preview'>" +
        "<div class='invoice-header'>" +
        "<div>" +
        "<div class='invoice-title'>🐦 Loonie Bird Music</div>" +
        "<div style='font-size: 0.8rem; color: var(--stone-500);'>Music Lessons Invoice</div>" +
        "</div>" +
        "<div style='text-align: right;'>" +
        "<div style='font-weight: 600;'>Invoice Date</div>" +
        "<div style='font-size: 0.85rem;'>" + today.toLocaleDateString() + "</div>" +
        "</div>" +
        "</div>" +
        "<div style='margin-bottom: 1rem;'>" +
        "<div style='font-weight: 600;'>Bill To:</div>" +
        "<div>" + guardianName + "</div>" +
        "<div style='color: var(--stone-500);'>Student: " + firstName + " " + lastName + "</div>" +
        "</div>" +
        "<table class='invoice-table'>" +
        "<thead><tr><th>Date</th><th>Duration</th><th>Amount</th></tr></thead>" +
        "<tbody>";
    
    let invoiceTotal = 0;
    recentLessons.forEach(lesson => {
        const date = getActualDate(lesson.week, lesson.day);
        const rate = lessonRates[lesson.duration] || lessonRates[60];
        invoiceTotal += rate;
        html += "<tr>" +
            "<td>" + date.toLocaleDateString() + "</td>" +
            "<td>" + lesson.duration + " min</td>" +
            "<td>$" + rate.toFixed(2) + "</td>" +
            "</tr>";
    });
    
    html += "</tbody></table>" +
        "<div class='invoice-total'>" +
        "Total: $" + invoiceTotal.toFixed(2) +
        "</div>";
    
    if(summary.totalPaid > 0) {
        html += "<div style='text-align: right; font-size: 0.85rem; color: var(--stone-500);'>" +
            "Payments received: $" + summary.totalPaid.toFixed(2) + "<br>" +
            "Balance due: $" + Math.max(0, summary.totalOwed - summary.totalPaid).toFixed(2) +
            "</div>";
    }
    
    html += "</div>";
    
    html += "<button onclick='printInvoice()' class='modal-btn modal-btn-primary'>🖨️ Print Invoice</button>" +
        "<button onclick='showStudentPayments(\"" + firstName + "\",\"" + lastName + "\")' class='modal-btn modal-btn-secondary'>Back</button>";
    
    modal(html);
}

function printInvoice() {
    const invoiceContent = document.querySelector('.invoice-preview');
    if(invoiceContent) {
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>Invoice</title>');
        printWindow.document.write('<style>body{font-family:system-ui,sans-serif;padding:2rem;} table{width:100%;border-collapse:collapse;margin:1rem 0;} th,td{padding:0.5rem;text-align:left;border-bottom:1px solid #ddd;} th{background:#f5f5f4;} .invoice-title{font-size:1.5rem;font-weight:bold;} .invoice-header{display:flex;justify-content:space-between;margin-bottom:1rem;padding-bottom:1rem;border-bottom:2px solid #ddd;} .invoice-total{text-align:right;font-size:1.25rem;font-weight:bold;margin-top:1rem;padding-top:1rem;border-top:2px solid #333;}</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(invoiceContent.innerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }
}

console.log("Loonie Bird loaded successfully!");

// Hide splash screen after load
window.addEventListener('load', function() {
    setTimeout(function() {
        const splash = document.getElementById('splashScreen');
        if(splash) {
            splash.classList.add('hidden');
            // Remove from DOM after animation
            setTimeout(function() {
                splash.remove();
            }, 400);
        }
    }, 500); // Brief delay to show splash
});

// ============ MINI MONTH CALENDAR ============

let _miniCalViewMonth = null; // { year, month } for the currently displayed month
let _miniCalOpen = null; // which mini calendar is open: 'miniCalendar' or 'miniCalendar2'

function toggleMiniCalendar(evt) {
    // Determine which calendar element to use based on click target
    const btn = evt ? evt.target.closest('.week-nav') : null;
    let calId = 'miniCalendar';
    if(btn) {
        const cal2 = btn.querySelector('#miniCalendar2');
        if(cal2) calId = 'miniCalendar2';
    }
    
    const el = document.getElementById(calId);
    const otherCalId = calId === 'miniCalendar' ? 'miniCalendar2' : 'miniCalendar';
    const otherEl = document.getElementById(otherCalId);
    if(otherEl) otherEl.classList.add('hidden');
    
    if(el.classList.contains('hidden')) {
        // Initialize to the month of the currently viewed week
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (currentWeek * 7));
        _miniCalViewMonth = { year: startOfWeek.getFullYear(), month: startOfWeek.getMonth() };
        _miniCalOpen = calId;
        renderMiniCalendar();
        el.classList.remove('hidden');
    } else {
        el.classList.add('hidden');
        _miniCalOpen = null;
    }
}

function miniCalChangeMonth(delta) {
    _miniCalViewMonth.month += delta;
    if(_miniCalViewMonth.month > 11) {
        _miniCalViewMonth.month = 0;
        _miniCalViewMonth.year++;
    } else if(_miniCalViewMonth.month < 0) {
        _miniCalViewMonth.month = 11;
        _miniCalViewMonth.year--;
    }
    renderMiniCalendar();
}

function renderMiniCalendar() {
    if(!_miniCalOpen) return;
    const el = document.getElementById(_miniCalOpen);
    if(!el) return;
    
    const year = _miniCalViewMonth.year;
    const month = _miniCalViewMonth.month;
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const dowLabels = ['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'];
    
    // Determine which week is currently displayed
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const viewedWeekStart = new Date(today);
    viewedWeekStart.setDate(today.getDate() - today.getDay() + 1 + (currentWeek * 7));
    const viewedWeekEnd = new Date(viewedWeekStart);
    viewedWeekEnd.setDate(viewedWeekStart.getDate() + 6);
    
    // Build lesson date set for dot indicators
    const lessonDates = new Set();
    lessons.forEach(l => {
        const d = getActualDate(l.week, l.day);
        lessonDates.add(d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate());
    });
    
    // First day of month
    const firstDay = new Date(year, month, 1);
    let startDay = firstDay.getDay() - 1; // Monday = 0
    if(startDay < 0) startDay = 6;
    
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    let html = '<div class="mini-cal-header">';
    html += '<button class="mini-cal-nav" onclick="event.stopPropagation(); miniCalChangeMonth(-1)">‹</button>';
    html += '<span class="mini-cal-title">' + monthNames[month] + ' ' + year + '</span>';
    html += '<button class="mini-cal-nav" onclick="event.stopPropagation(); miniCalChangeMonth(1)">›</button>';
    html += '</div>';
    
    html += '<div class="mini-cal-grid">';
    
    // Day of week headers
    dowLabels.forEach(d => {
        html += '<div class="mini-cal-dow">' + d + '</div>';
    });
    
    // Previous month trailing days
    for(let i = startDay - 1; i >= 0; i--) {
        const dayNum = daysInPrevMonth - i;
        const prevMonth = month === 0 ? 11 : month - 1;
        const prevYear = month === 0 ? year - 1 : year;
        const dateKey = prevYear + '-' + (prevMonth + 1) + '-' + dayNum;
        const hasLessons = lessonDates.has(dateKey);
        html += '<div class="mini-cal-day other-month' + (hasLessons ? ' has-lessons' : '') + '" onclick="event.stopPropagation(); miniCalSelectDate(' + prevYear + ',' + prevMonth + ',' + dayNum + ')">' + dayNum + '</div>';
    }
    
    // Current month days
    for(let d = 1; d <= daysInMonth; d++) {
        const thisDate = new Date(year, month, d);
        thisDate.setHours(0, 0, 0, 0);
        const isToday = thisDate.getTime() === today.getTime();
        const isInViewedWeek = thisDate >= viewedWeekStart && thisDate <= viewedWeekEnd;
        const dateKey = year + '-' + (month + 1) + '-' + d;
        const hasLessons = lessonDates.has(dateKey);
        
        let cls = 'mini-cal-day';
        if(isToday) cls += ' today';
        else if(isInViewedWeek) cls += ' current-week';
        if(hasLessons) cls += ' has-lessons';
        
        html += '<div class="' + cls + '" onclick="event.stopPropagation(); miniCalSelectDate(' + year + ',' + month + ',' + d + ')">' + d + '</div>';
    }
    
    // Next month leading days
    const totalCells = startDay + daysInMonth;
    const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for(let i = 1; i <= remaining; i++) {
        const nextMonth = month === 11 ? 0 : month + 1;
        const nextYear = month === 11 ? year + 1 : year;
        const dateKey = nextYear + '-' + (nextMonth + 1) + '-' + i;
        const hasLessons = lessonDates.has(dateKey);
        html += '<div class="mini-cal-day other-month' + (hasLessons ? ' has-lessons' : '') + '" onclick="event.stopPropagation(); miniCalSelectDate(' + nextYear + ',' + nextMonth + ',' + i + ')">' + i + '</div>';
    }
    
    html += '</div>';
    el.innerHTML = html;
}

function miniCalSelectDate(year, month, day) {
    const selectedDate = new Date(year, month, day);
    selectedDate.setHours(0, 0, 0, 0);
    
    // Find the Monday of that week
    let dayOfWeek = selectedDate.getDay(); // 0=Sun
    if(dayOfWeek === 0) dayOfWeek = 7;
    const monday = new Date(selectedDate);
    monday.setDate(selectedDate.getDate() - (dayOfWeek - 1));
    
    // Calculate the current "real" Monday (week 0)
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    let todayDow = today.getDay();
    if(todayDow === 0) todayDow = 7;
    const thisMonday = new Date(today);
    thisMonday.setDate(today.getDate() - (todayDow - 1));
    
    // Calculate week offset
    const diffMs = monday.getTime() - thisMonday.getTime();
    const weekOffset = Math.round(diffMs / (7 * 24 * 60 * 60 * 1000));
    
    currentWeek = weekOffset;
    
    // Close mini calendar
    if(_miniCalOpen) {
        document.getElementById(_miniCalOpen).classList.add('hidden');
        _miniCalOpen = null;
    }
    
    render();
}

function updateMiniCalendar() {
    if(_miniCalOpen) renderMiniCalendar();
}

// Close mini calendar when clicking outside
document.addEventListener('click', function(e) {
    if(!e.target.closest('.week-nav')) {
        document.querySelectorAll('.mini-calendar').forEach(el => el.classList.add('hidden'));
        _miniCalOpen = null;
    }
});
</script>
</body>
</html>
